<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система отчетности арбитража</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1em;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #7f8c8d;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e1e8ed;
        }

        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .positive {
            color: #27ae60;
            font-weight: 600;
        }

        .negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .employee-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .employee-card h4 {
            margin-bottom: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .filters {
                flex-direction: column;
            }
            .filter-item {
                min-width: auto;
            }
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
                padding: 8px 0;
            }
            .nav-tab {
                font-size: 1.1em;
                padding: 14px 0;
                border-radius: 8px;
            }
            .header {
                padding: 18px 8px;
            }
            .container {
                padding: 8px;
            }
            .btn, .btn-secondary {
                font-size: 1.1em;
                padding: 16px 0;
                width: 100%;
                margin-bottom: 8px;
            }
            .form-control {
                font-size: 1.1em;
                padding: 16px 12px;
            }
            .table {
                display: block;
                width: 100%;
                overflow-x: auto;
                font-size: 0.98em;
            }
            .table thead, .table tbody, .table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            .table th, .table td {
                padding: 10px 6px;
            }
        }
        @media (max-width: 500px) {
            .table, .table thead, .table tbody, .table tr, .table th, .table td {
                display: block;
                width: 100%;
            }
            .table thead { display: none; }
            .table tr {
                margin-bottom: 18px;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 2px 8px #e1e8ed;
                padding: 10px 8px;
            }
            .table td {
                padding: 8px 4px;
                border: none;
                position: relative;
            }
            .table td:before {
                content: attr(data-label);
                font-weight: bold;
                color: #764ba2;
                display: block;
                margin-bottom: 2px;
                font-size: 0.98em;
            }
        }

        // --- Новый стиль для детального отчёта ---
        // 1. Секции: карточки с тенью и цветными полосками
        // 2. Балансы по аккаунтам: таблица с фиксированным заголовком, горизонтальный скролл, цвет дельты
        // 3. Финансовые итоги: ключевые показатели в карточках с иконками
        // 4. Второстепенные детали (файлы, комментарии) — свернуты по умолчанию
        // 5. Всё адаптивно, не меняю названия блоков и полей

        .report-details {
            background: #f8f9fa;
            border-radius: 24px;
            padding: 32px 18px;
            margin: 14px 0;
            box-shadow: 0 4px 32px rgba(102,126,234,0.10);
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .report-header h3 {
            margin: 0;
            color: #667eea;
            font-size: 1.2em;
        }

        .report-header button {
            background: none;
            border: none;
            color: #888;
            font-size: 1.2em;
            cursor: pointer;
        }

        .stats-section {
            background: #fff;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 24px;
            border-left: 6px solid #667eea;
        }

        .stats-section h4 {
            margin: 0 0 16px 0;
            color: #667eea;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .stat-item {
            background: #f3f6fd;
            padding: 16px;
            border-radius: 12px;
        }

        .stat-item label {
            display: block;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-item div {
            font-size: 1.1em;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ДЛЯ РАСЧЁТОВ ---
        const PLATFORMS = ['bybit','htx','bliss','gate'];

        function compareShifts(dateA, shiftA, dateB, shiftB) {
            const dA = new Date(dateA);
            const dB = new Date(dateB);
            if (dA < dB) return -1;
            if (dA > dB) return 1;
            if (shiftA === shiftB) return 0;
            if (shiftA === 'morning' && shiftB === 'evening') return -1;
            if (shiftA === 'evening' && shiftB === 'morning') return 1;
            return 0;
        }

        function findPrevBalanceJS(account_id, platform, reports, report, settingsInitialBalances, accounts) {
            if (reports && Array.isArray(reports)) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        return true;
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let prevBalances = {};
                    try { prevBalances = JSON.parse(prev[0].balances_json || '{}'); } catch { prevBalances = {}; }
                    const found = prevBalances[platform]?.find(a => (a.account_id || a.id) == account_id);
                    if (found && found.balance !== '' && !isNaN(found.balance)) return parseFloat(found.balance);
                }
            }
            if (settingsInitialBalances) {
                const acc = settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts?.find(a => a.id == account_id)?.account_name)));
                if (acc && acc.balance !== undefined) return parseFloat(acc.balance);
            }
            return 0;
        }

        function getTotalBalance(balances, internal) {
            let total = 0;
            PLATFORMS.forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        if (acc.balance !== '' && !isNaN(acc.balance)) total += parseFloat(acc.balance);
                    });
                }
            });
            return total + (parseFloat(internal) || 0);
        }

        function getPrevTotal(report, reports, settingsInitialBalances, accounts) {
            let prevTotal = null;
            let usedInitial = false;
            if (reports && Array.isArray(reports)) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        return true;
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let prevBalances = {};
                    try { prevBalances = JSON.parse(prev[0].balances_json || '{}'); } catch { prevBalances = {}; }
                    let prevSum = 0;
                    PLATFORMS.forEach(platform => {
                        if (prevBalances[platform]) {
                            prevBalances[platform].forEach(acc => {
                                if (acc.balance !== '' && !isNaN(acc.balance)) prevSum += parseFloat(acc.balance);
                            });
                        }
                    });
                    const prevInternal = parseFloat(prev[0].internal_transfer_amount) || 0;
                    prevTotal = prevSum + prevInternal;
                }
            }
            if (prevTotal === null && settingsInitialBalances) {
                prevTotal = 0;
                settingsInitialBalances.forEach(b => {
                    if (b.balance !== '' && !isNaN(b.balance)) prevTotal += parseFloat(b.balance);
                });
                usedInitial = true;
            }
            return { prevTotal, usedInitial };
        }

        // --- Глобальная история балансов аккаунтов ---
        window.accountBalanceHistory = window.accountBalanceHistory || [];

        // --- Сохранять историю балансов после каждого отчёта ---
        async function saveAccountBalancesToHistory(report, employees, accounts) {
            console.log('saveAccountBalancesToHistory called', {report, employees, accounts});
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            const employee = employees.find(emp => emp.id === report.employee_id);
            for (const platform of ['bybit','htx','bliss','gate']) {
                if (balances[platform]) {
                    for (const acc of balances[platform]) {
                        const body = {
                            account_id: acc.account_id || acc.id,
                            account_name: acc.account_name,
                            platform,
                            shift_date: report.shift_date,
                            shift_type: report.shift_type,
                            balance: acc.balance !== '' && !isNaN(acc.balance) ? parseFloat(acc.balance) : 0,
                            employee_id: employee ? employee.id : null,
                            employee_name: employee ? employee.name : '—'
                        };
                        console.log('POST to /api/account-balance-history', body);
                        try {
                            const resp = await fetch('/api/account-balance-history', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(body)
                            });
                            if (!resp.ok) {
                                const err = await resp.text();
                                console.error('Ошибка сохранения баланса в историю:', err);
                                alert('Ошибка сохранения баланса в историю: ' + err);
                            } else {
                                console.log('Баланс сохранён в историю:', acc.account_name, platform, acc.balance);
                            }
                        } catch (e) {
                            console.error('Ошибка запроса к истории балансов:', e);
                            alert('Ошибка запроса к истории балансов: ' + e);
                        }
                    }
                }
            }
        }

        // --- Использовать историю для расчёта дельты ---
        function findPrevAccountBalanceInHistory(account_id, platform, shift_date, shift_type, accounts = []) {
            // Найти последнюю запись по этому аккаунту до текущей смены
            const prev = window.accountBalanceHistory
                .filter(h => h.account_id == account_id && h.platform === platform && compareShifts(h.shift_date, h.shift_type, shift_date, shift_type) < 0)
                .sort((a, b) => compareShifts(b.shift_date, b.shift_type, a.shift_date, a.shift_type));
            if (prev.length > 0) return prev[0].balance;
            // Если нет — ищем стартовый баланс из настроек
            if (window.settingsInitialBalances) {
                const found = window.settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts.find(a => a.id == account_id)?.account_name)));
                if (found && found.balance !== undefined && found.balance !== '' && !isNaN(found.balance)) return parseFloat(found.balance);
            }
            return 0;
        }

        // --- Модифицировать calculateProfit и calculateSalaryProfit ---
        function calculateProfit(report, reports, settingsInitialBalances, accounts, employees) {
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            let endSum = 0;
            let startSum = 0;
            ['bybit','htx','bliss','gate'].forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        if (acc.end_balance !== '' && !isNaN(acc.end_balance)) endSum += parseFloat(acc.end_balance);
                        if (acc.start_balance !== '' && !isNaN(acc.start_balance)) startSum += parseFloat(acc.start_balance);
                    });
                }
            });
            const dokidka = parseFloat(report.dokidka_amount) || 0;
            const profit = endSum - startSum - dokidka;
            return { endSum, startSum, dokidka, profit };
        }
        function calculateSalaryProfit(report, reports, settingsInitialBalances, accounts, employees) {
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            let endSum = 0;
            let startSum = 0;
            ['bybit','htx','bliss','gate'].forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        if (acc.end_balance !== '' && !isNaN(acc.end_balance)) endSum += parseFloat(acc.end_balance);
                        if (acc.start_balance !== '' && !isNaN(acc.start_balance)) startSum += parseFloat(acc.start_balance);
                    });
                }
            });
            const dokidka = parseFloat(report.dokidka_amount) || 0;
            const scam = (report.scam_personal ? (parseFloat(report.scam_amount) || 0) : 0);
            const profit = endSum - startSum - dokidka - scam;
            return { endSum, startSum, dokidka, scam, profit };
        }

        // --- Сохранять историю балансов в localStorage ---
        function saveAccountBalanceHistoryToStorage() {
            try {
                localStorage.setItem('accountBalanceHistory', JSON.stringify(window.accountBalanceHistory));
            } catch {}
        }
        function loadAccountBalanceHistoryFromStorage() {
            try {
                const data = localStorage.getItem('accountBalanceHistory');
                if (data) window.accountBalanceHistory = JSON.parse(data);
            } catch {}
        }
        // Загружаем историю при старте
        loadAccountBalanceHistoryFromStorage();

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dashboardData, setDashboardData] = useState(null);
            const [employees, setEmployees] = useState([]);
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(true);
            const [settingsVisible, setSettingsVisible] = useState(false);
            const [settingsPassword, setSettingsPassword] = useState('');
            const [settingsAuthed, setSettingsAuthed] = useState(false);
            const [settingsInitialBalances, setSettingsInitialBalances] = useState([]);
            const [settingsAccounts, setSettingsAccounts] = useState([]);
            const [settingsLoading, setSettingsLoading] = useState(false);
            const [stats, setStats] = useState([]);
            const [statsStart, setStatsStart] = useState(() => {
                const d = new Date();
                return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-01';
            });
            const [statsEnd, setStatsEnd] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [statsLoading, setStatsLoading] = useState(false);
            const [globalAuthed, setGlobalAuthed] = useState(false);
            const [globalPassword, setGlobalPassword] = useState('');
            const [globalError, setGlobalError] = useState('');
            const [showDetails, setShowDetails] = useState({id: null, type: null});

            // Фиксированный список площадок
            const platforms = [
                { id: 1, name: 'Bybit', type: 'exchange' },
                { id: 2, name: 'HTX', type: 'exchange' },
                { id: 3, name: 'Bliss', type: 'arbitrage' },
                { id: 4, name: 'Gate', type: 'arbitrage' }
            ];

            // Проверяем аутентификацию при загрузке
            useEffect(() => {
                const isAuthenticated = sessionStorage.getItem('authenticated');
                if (isAuthenticated === 'true') {
                    setGlobalAuthed(true);
                }
            }, []);

            useEffect(() => {
                if (globalAuthed) {
                loadData();
                // Загружаем начальные балансы при старте приложения
                fetch('/api/settings/balances').then(r => r.json()).then(balances => {
                    window.settingsInitialBalances = balances;
                });
                }
            }, [activeTab, globalAuthed]);

            useEffect(() => {
                if (activeTab === 'settings' && settingsAuthed && globalAuthed) {
                    setSettingsLoading(true);
                    fetch('/api/accounts').then(r => r.json()).then(setSettingsAccounts);
                    fetch('/api/settings/balances').then(r => r.json()).then(balances => {
                        setSettingsInitialBalances(balances);
                        window.settingsInitialBalances = balances;
                        setSettingsLoading(false);
                    });
                }
            }, [activeTab, settingsAuthed, globalAuthed]);

            useEffect(() => {
                if (activeTab === 'statistics' && globalAuthed) {
                    setStatsLoading(true);
                    fetch(`/api/statistics?start_date=${statsStart}&end_date=${statsEnd}`)
                        .then(r => r.json())
                        .then(data => { setStats(data); setStatsLoading(false); });
                }
            }, [activeTab, statsStart, statsEnd, globalAuthed]);

            const loadData = async () => {
                try {
                    const [dashboardRes, employeesRes, reportsRes] = await Promise.all([
                        fetch('/api/dashboard'),
                        fetch('/api/employees'),
                        fetch('/api/reports')
                    ]);

                    const dashboard = await dashboardRes.json();
                    const employeesData = await employeesRes.json();
                    const reportsData = await reportsRes.json();

                    setDashboardData(dashboard);
                    setEmployees(employeesData);
                    setReports(reportsData);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading data:', error);
                    setLoading(false);
                }
            };

            const handleLogin = () => {
                if (globalPassword === '7605203') {
                    setGlobalAuthed(true);
                    setGlobalError('');
                    sessionStorage.setItem('authenticated', 'true');
                } else {
                    setGlobalError('Неверный пароль!');
                }
            };

            const handleLogout = () => {
                setGlobalAuthed(false);
                setGlobalPassword('');
                setGlobalError('');
                sessionStorage.removeItem('authenticated');
                setDashboardData(null);
                setEmployees([]);
                setReports([]);
                setLoading(true);
            };

            // Если не аутентифицирован, показываем форму входа
            if (!globalAuthed) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1><i className="fas fa-coins"></i> Birch Team</h1>
                            <p>Мониторинг и аналитика P2P арбитражной команды</p>
                        </div>
                        <div className="card" style={{maxWidth: 400, margin: '40px auto', textAlign: 'center'}}>
                            <h3><i className="fas fa-lock"></i> Вход в систему</h3>
                            <div className="form-group">
                                <input 
                                    type="password" 
                                    className="form-control" 
                                    placeholder="Введите пароль" 
                                    value={globalPassword} 
                                    onChange={e => setGlobalPassword(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && handleLogin()}
                                    style={{margin: '20px 0'}} 
                                />
                            </div>
                            <button className="btn" onClick={handleLogin}>
                                <i className="fas fa-sign-in-alt"></i> Войти
                            </button>
                            {globalError && <div style={{color: '#e74c3c', marginTop: 10}}>{globalError}</div>}
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading">
                            <i className="fas fa-spinner fa-spin fa-2x"></i>
                            <p>Загрузка данных...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <div className="header">
                        <h1><i className="fas fa-coins"></i> Birch Team</h1>
                        <p>Мониторинг и аналитика P2P арбитражной команды</p>
                        <button className="logout-btn" onClick={handleLogout}>
                            <i className="fas fa-sign-out-alt"></i> Выйти
                        </button>
                    </div>

                    <div className="nav-tabs">
                        <div className={`nav-tab ${activeTab === 'dashboard' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('dashboard')}>
                            <i className="fas fa-tachometer-alt"></i> Дашборд
                        </div>
                        <div className={`nav-tab ${activeTab === 'employees' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('employees')}>
                            <i className="fas fa-users"></i> Сотрудники
                        </div>
                        <div className={`nav-tab ${activeTab === 'platforms' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('platforms')}>
                            <i className="fas fa-exchange-alt"></i> Площадки
                        </div>
                        <div className={`nav-tab ${activeTab === 'reports' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('reports')}>
                            <i className="fas fa-file-alt"></i> Отчеты
                        </div>
                        <div className={`nav-tab ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>
                            <i className="fas fa-cog"></i> Настройки
                        </div>
                        <div className={`nav-tab ${activeTab === 'statistics' ? 'active' : ''}`} onClick={() => setActiveTab('statistics')}>
                            <i className="fas fa-chart-pie"></i> Статистика
                        </div>
                        <div className={`nav-tab ${activeTab === 'accountBalanceHistory' ? 'active' : ''}`} onClick={() => setActiveTab('accountBalanceHistory')}>
                            <i className="fas fa-database"></i> История балансов
                        </div>
                    </div>

                    {activeTab === 'dashboard' && <Dashboard data={dashboardData} />}
                    {activeTab === 'employees' && <Employees employees={employees} onUpdate={loadData} />}
                    {activeTab === 'platforms' && <Platforms platforms={platforms} employees={employees} onUpdate={loadData} />}
                    {activeTab === 'reports' && <Reports reports={reports} employees={employees} platforms={platforms} onUpdate={loadData} />}
                    {activeTab === 'settings' && (
                        <Settings
                            authed={settingsAuthed}
                            setAuthed={setSettingsAuthed}
                            password={settingsPassword}
                            setPassword={setSettingsPassword}
                            initialBalances={settingsInitialBalances}
                            setInitialBalances={setSettingsInitialBalances}
                            accounts={settingsAccounts}
                            loading={settingsLoading}
                        />
                    )}
                    {activeTab === 'statistics' && (
                        <Statistics
                            stats={stats}
                            start={statsStart}
                            end={statsEnd}
                            setStart={setStatsStart}
                            setEnd={setStatsEnd}
                            loading={statsLoading}
                        />
                    )}
                    {activeTab === 'accountBalanceHistory' && <AccountBalanceHistoryViewer accounts={settingsAccounts || []} employees={employees} />}
                    {activeTab === 'settings' && settingsAuthed && (
                        <div style={{textAlign: 'right', marginBottom: 20}}>
                            <a href="/settings/salary-percents" className="btn" style={{fontSize: '15px', padding: '10px 18px', textDecoration: 'none'}}>
                                <i className="fa fa-percent"></i> Проценты сотрудников
                            </a>
                        </div>
                    )}
                </div>
            );
        }

        function Dashboard({ data: initialData }) {
            const [chart, setChart] = useState(null);
            const [dayChart, setDayChart] = useState(null);
            const now = new Date();
            const [selectedYear, setSelectedYear] = useState(now.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState(now.getMonth() + 1); // 1-12
            const [startDate, setStartDate] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [endDate, setEndDate] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [data, setData] = useState(initialData);
            useEffect(() => { setData(initialData); }, [initialData]);

            // Получаем список месяцев и лет из данных (или за последние 2 года)
            const minYear = now.getFullYear() - 2;
            const years = [];
            for (let y = now.getFullYear(); y >= minYear; y--) years.push(y);
            const months = [
                { value: 1, label: 'Январь' }, { value: 2, label: 'Февраль' }, { value: 3, label: 'Март' },
                { value: 4, label: 'Апрель' }, { value: 5, label: 'Май' }, { value: 6, label: 'Июнь' },
                { value: 7, label: 'Июль' }, { value: 8, label: 'Август' }, { value: 9, label: 'Сентябрь' },
                { value: 10, label: 'Октябрь' }, { value: 11, label: 'Ноябрь' }, { value: 12, label: 'Декабрь' }
            ];

            // --- Новый useEffect для загрузки данных по выбранным датам ---
            useEffect(() => {
                fetch(`/api/dashboard?start_date=${startDate}&end_date=${endDate}`)
                    .then(r => r.json())
                    .then(setData);
            }, [startDate, endDate]);

            useEffect(() => {
                if (data && data.employee_stats) {
                    const ctx = document.getElementById('profitChart');
                    if (ctx) {
                        if (chart) chart.destroy();
                        const profits = data.employee_stats.map(emp => emp.total_profit);
                        const minProfit = Math.min(...profits, 0);
                        const maxProfit = Math.max(...profits, 0);
                        const yMax = maxProfit === minProfit ? maxProfit + 10 : undefined;
                        const newChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.employee_stats.map(emp => emp.name),
                                datasets: [{
                                    label: 'Прибыль (USDT)',
                                    data: profits,
                                    backgroundColor: profits.map(p => p >= 0 ? 'rgba(102, 126, 234, 0.8)' : 'rgba(231, 76, 60, 0.8)'),
                                    borderColor: profits.map(p => p >= 0 ? 'rgba(102, 126, 234, 1)' : 'rgba(231, 76, 60, 1)'),
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        min: minProfit,
                                        max: yMax,
                                        grace: '10%',
                                        ticks: {
                                            callback: function(value) {
                                                return value + ' USDT';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        setChart(newChart);
                    }
                }
            }, [data]);

            // --- График по дням за выбранный месяц ---
            useEffect(() => {
                if (data && (data.profit_by_day || data.reports)) {
                    const ctx = document.getElementById('dayProfitChart');
                    if (ctx) {
                        if (dayChart) dayChart.destroy();
                        // Получаем все даты выбранного месяца
                        const year = selectedYear;
                        const month = selectedMonth - 1; // JS: 0-11
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        const labels = Array.from({length: daysInMonth}, (_,i) => new Date(year, month, i+1).toISOString().slice(0,10));
                        // profitByDay: фильтруем по выбранному месяцу
                        let profitByDay = {};
                        if (data.profit_by_day) {
                            // profit_by_day: { 'YYYY-MM-DD': value }
                            Object.entries(data.profit_by_day).forEach(([d, v]) => {
                                if (d.startsWith(`${year}-${String(selectedMonth).padStart(2,'0')}`)) profitByDay[d] = v;
                            });
                        } else if (data.reports) {
                            data.reports.forEach(r => {
                                const d = (r.shift_date || '').slice(0,10);
                                if (d.startsWith(`${year}-${String(selectedMonth).padStart(2,'0')}`)) {
                                    if (!profitByDay[d]) profitByDay[d] = 0;
                                    profitByDay[d] += parseFloat(r.net_profit || 0);
                                }
                            });
                        }
                        const dataArr = labels.map(d => profitByDay[d] || 0);
                        const minVal = Math.min(...dataArr, 0);
                        const maxVal = Math.max(...dataArr, 0);
                        const yMax = maxVal === minVal ? maxVal + 10 : undefined;
                        const newDayChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels.map(d => d.slice(8,10)+'.'+d.slice(5,7)),
                                datasets: [{
                                    label: 'Чистая прибыль (Δ-скам) по дням',
                                    data: dataArr,
                                    fill: true,
                                    backgroundColor: 'rgba(102, 126, 234, 0.15)',
                                    borderColor: 'rgba(102, 126, 234, 1)',
                                    tension: 0.2,
                                    pointRadius: 4,
                                    pointBackgroundColor: dataArr.map(v => v >= 0 ? '#27ae60' : '#e74c3c')
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        min: minVal,
                                        max: yMax,
                                        grace: '10%',
                                        ticks: {
                                            callback: function(value) { return value + ' USDT'; }
                                        }
                                    }
                                }
                            }
                        });
                        setDayChart(newDayChart);
                    }
                }
            }, [data, selectedYear, selectedMonth]);

            if (!data) return <div className="loading">Нет данных</div>;

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <h3>${(data.total_profit ?? 0).toFixed(2)}</h3>
                            <p>Общая прибыль</p>
                        </div>
                        <div className="stat-card">
                            <h3>${(data.total_volume ?? 0).toFixed(2)}</h3>
                            <p>Общий объем</p>
                        </div>
                        <div className="stat-card">
                            <h3>{data.total_requests ?? 0}</h3>
                            <p>Всего ордеров</p>
                        </div>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-chart-line"></i> Динамика прибыли по дням за выбранный месяц</h3>
                        <div style={{display:'flex',gap:12,alignItems:'center',marginBottom:18}}>
                            <label>Месяц:</label>
                            <select className="form-control" style={{maxWidth:140}} value={selectedMonth} onChange={e => setSelectedMonth(Number(e.target.value))}>
                                {months.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
                            </select>
                            <label>Год:</label>
                            <select className="form-control" style={{maxWidth:100}} value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))}>
                                {years.map(y => <option key={y} value={y}>{y}</option>)}
                            </select>
                        </div>
                        <div className="chart-container">
                            <canvas id="dayProfitChart"></canvas>
                        </div>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-users"></i> Статистика сотрудников</h3>
                        <div style={{display:'flex',gap:12,alignItems:'center',marginBottom:18,flexWrap:'wrap'}}>
                            <label>Период с</label>
                            <input type="date" className="form-control" style={{maxWidth:140}} value={startDate} onChange={e => setStartDate(e.target.value)} />
                            <label>по</label>
                            <input type="date" className="form-control" style={{maxWidth:140}} value={endDate} onChange={e => setEndDate(e.target.value)} />
                        </div>
                        <div className="chart-container">
                            <canvas id="profitChart"></canvas>
                        </div>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-list"></i> Краткий отчет за последние 3 смены</h3>
                        <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '15px' }}>
                            {(data.last_reports ?? []).map(report => (
                                <div key={report.id} className="employee-card">
                                    <h4>{report.employee_name}</h4>
                                    <p>Смена: {report.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'}</p>
                                    <p>Дата: {new Date(report.shift_date).toLocaleDateString('ru-RU')}</p>
                                    <p>Прибыль: ${report.profit}</p>
                                    <p>Ордера: {report.total_requests}</p>
                                    {/* Кратко по платформам */}
                                    {['bybit','htx','bliss','gate'].map(platform => (
                                        <div key={platform}>
                                            <b>{platform.toUpperCase()}:</b> {report[platform + '_accounts']} аккаунтов, Изменение {report[platform + '_delta']}
                                        </div>
                                    ))}
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-trophy" style={{color:'#f7b731'}}></i> Топ-3 сотрудника по прибыли</h3>
                        <div style={{display:'flex',gap:24,justifyContent:'flex-start',marginTop:18,flexWrap:'wrap'}}>
                            {(data.employee_stats || []).slice().sort((a,b)=>Number(b.total_profit||0)-Number(a.total_profit||0)).slice(0,3).map((emp, idx) => (
                                <div key={emp.id || emp.name} style={{background:'#fffbe6',borderRadius:16,padding:'22px 28px',minWidth:220,boxShadow:'0 2px 12px #f7b73122',display:'flex',flexDirection:'column',alignItems:'center',position:'relative'}}>
                                    <div style={{position:'absolute',top:10,right:18,fontSize:22,color:'#f7b731',fontWeight:700}} title={`Место #${idx+1}`}>{['🥇','🥈','🥉'][idx]}</div>
                                    <div style={{fontWeight:700,fontSize:'1.2em',marginBottom:6}}>{emp.name}</div>
                                    <div style={{color:'#888',marginBottom:8}}>Смен: {emp.total_shifts ?? '-'}</div>
                                    <div style={{fontSize:'1.5em',fontWeight:700,color:'#27ae60',marginBottom:4}} title="Общая прибыль">
                                      {(Number(emp.total_profit) >= 0 ? '+' : '') + (Number(emp.total_profit) || 0).toFixed(2)} USDT
                                    </div>
                                    <div style={{color:'#aaa',fontSize:'0.95em'}}>
                                      Чистая прибыль: {(Number(emp.net_profit) >= 0 ? '+' : '') + (Number(emp.net_profit) || 0).toFixed(2)} USDT
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function Employees({ employees, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                telegram: ''
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('/api/employees', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    if (response.ok) {
                        setFormData({ name: '', telegram: '' });
                        setShowForm(false);
                        onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating employee:', error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('Для удаления сотрудника введите пароль:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/employees/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Ошибка удаления');
                    }
                } catch (error) {
                    alert('Ошибка удаления');
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-users"></i> Сотрудники</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> Добавить сотрудника
                            </button>
                        </div>

                        {showForm && (
                            <form onSubmit={handleSubmit} style={{ marginBottom: '20px', padding: '20px', background: '#f8f9fa', borderRadius: '10px' }}>
                                <div className="form-group">
                                    <label>Имя сотрудника</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Ник Telegram</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.telegram}
                                        onChange={(e) => setFormData({...formData, telegram: e.target.value})}
                                        required
                                    />
                                </div>
                                <button type="submit" className="btn">Сохранить</button>
                                <button type="button" className="btn btn-secondary" onClick={() => setShowForm(false)}>Отмена</button>
                            </form>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Имя</th>
                                    <th>Ник Telegram</th>
                                    <th>Дата добавления</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td>{emp.name}</td>
                                        <td>{emp.telegram}</td>
                                        <td>{new Date(emp.created_at).toLocaleDateString('ru-RU')}</td>
                                        <td>
                                            <button className="btn btn-secondary" onClick={() => handleDelete(emp.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>Удалить</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function Platforms({ platforms, employees, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [accounts, setAccounts] = useState([]);
            const [formData, setFormData] = useState({
                platform: '',
                account_name: ''
            });
            const platformOptions = [
                { value: 'bybit', label: 'Bybit' },
                { value: 'htx', label: 'HTX' },
                { value: 'bliss', label: 'Bliss' },
                { value: 'gate', label: 'Gate' }
            ];

            useEffect(() => {
                fetch('/api/accounts').then(r => r.json()).then(setAccounts);
            }, [showForm]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // Добавляем аккаунт
                    const response = await fetch('/api/accounts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: formData.platform,
                            account_name: formData.account_name
                        })
                    });
                    if (response.ok) {
                        setFormData({ platform: '', account_name: '' });
                        setShowForm(false);
                        fetch('/api/accounts').then(r => r.json()).then(setAccounts);
                        if (onUpdate) onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating account:', error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('Для удаления аккаунта введите пароль:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/accounts/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        fetch('/api/accounts').then(r => r.json()).then(setAccounts);
                        if (onUpdate) onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Ошибка удаления');
                    }
                } catch (error) {
                    alert('Ошибка удаления');
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-exchange-alt"></i> Аккаунты площадок</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> Добавить аккаунт
                            </button>
                        </div>

                        {showForm && (
                            <form onSubmit={handleSubmit} style={{ marginBottom: '20px', padding: '20px', background: '#f8f9fa', borderRadius: '10px' }}>
                                <div className="form-group">
                                    <label>Площадка</label>
                                    <select className="form-control" value={formData.platform} onChange={e => setFormData({ ...formData, platform: e.target.value })} required>
                                        <option value="">Выберите площадку</option>
                                        {platformOptions.map(opt => (
                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>Название аккаунта</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.account_name}
                                        onChange={e => setFormData({ ...formData, account_name: e.target.value })}
                                        required
                                    />
                                </div>
                                <button type="submit" className="btn">Сохранить</button>
                                <button type="button" className="btn btn-secondary" onClick={() => setShowForm(false)}>Отмена</button>
                            </form>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Площадка</th>
                                    <th>Название аккаунта</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {accounts.map(acc => (
                                    <tr key={acc.id}>
                                        <td>{platformOptions.find(opt => opt.value === acc.platform)?.label || acc.platform}</td>
                                        <td>{acc.account_name}</td>
                                        <td>
                                            <button className="btn btn-secondary" onClick={() => handleDelete(acc.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>Удалить</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function Reports({ reports: initialReports, employees, platforms, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [filters, setFilters] = useState({
                start_date: '',
                end_date: '',
                employee_id: ''
            });
            const [accounts, setAccounts] = useState([]);
            const [expandedReportId, setExpandedReportId] = useState(null);
            const [formData, setFormData] = useState({
                employee_id: '',
                shift_date: '',
                shift_type: 'morning',
                bybit_requests: 0,
                htx_requests: 0,
                bliss_requests: 0,
                balances: { bybit: [], htx: [], bliss: [], gate: [] },
                scam_amount: 0,
                scam_comment: '',
                scam_personal: false,
                dokidka_amount: 0,
                dokidka_comment: '',
                internal_transfer_amount: 0,
                internal_transfer_comment: '',
                bybit_file: null,
                htx_file: null,
                bliss_file: null,
                start_photo: null,
                end_photo: null
            });
            const [reports, setReports] = useState(initialReports || []);
            const [zoomedImage, setZoomedImage] = useState(null);
            const [showDetails, setShowDetails] = useState({id: null, type: null});

            useEffect(() => {
                fetch('/api/accounts').then(r => r.json()).then(setAccounts);
            }, []);

            const handleAccountChange = (platform, selectedIds) => {
                setFormData(fd => {
                    // Список выбранных аккаунтов для этой платформы
                    const selectedAccounts = accounts
                        .filter(a => selectedIds.includes(a.id.toString()) && a.platform === platform)
                        .map(acc => {
                            // Если уже были введены балансы — сохраняем их
                            const existing = fd.balances[platform].find(a => a.id === acc.id);
                            return existing ? existing : { ...acc, start_balance: '', end_balance: '' };
                        });
                    return {
                        ...fd,
                        balances: {
                            ...fd.balances,
                            [platform]: selectedAccounts
                        }
                    };
                });
            };

            const handleBalanceChange = (platform, idx, field, value) => {
                setFormData(fd => {
                    const updated = [...fd.balances[platform]];
                    updated[idx][field] = value;
                    return {
                        ...fd,
                        balances: {
                            ...fd.balances,
                            [platform]: updated
                        }
                    };
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const form = new FormData();
                form.append('employee_id', formData.employee_id);
                form.append('shift_date', formData.shift_date);
                form.append('shift_type', formData.shift_type);
                form.append('total_requests', formData.total_requests);
                form.append('bybit_requests', formData.bybit_requests || 0);
                form.append('htx_requests', formData.htx_requests || 0);
                form.append('bliss_requests', formData.bliss_requests || 0);
                form.append('balances_json', JSON.stringify(formData.balances));
                form.append('scam_amount', formData.scam_amount);
                form.append('scam_comment', formData.scam_comment);
                form.append('dokidka_amount', formData.dokidka_amount);
                form.append('dokidka_comment', formData.dokidka_comment);
                form.append('internal_transfer_amount', formData.internal_transfer_amount);
                form.append('internal_transfer_comment', formData.internal_transfer_comment);
                if (formData.bybit_file) form.append('bybit_file', formData.bybit_file);
                if (formData.htx_file) form.append('htx_file', formData.htx_file);
                if (formData.bliss_file) form.append('bliss_file', formData.bliss_file);
                if (formData.start_photo) form.append('start_photo', formData.start_photo);
                if (formData.end_photo) form.append('end_photo', formData.end_photo);
                ['bybit','htx','bliss','gate'].forEach(platform => {
                    form.append(platform + '_first_trade', formData[platform + '_first_trade'] || '');
                    form.append(platform + '_last_trade', formData[platform + '_last_trade'] || '');
                });
                form.append('scam_personal', formData.scam_personal ? 'true' : '');
                try {
                    const response = await fetch('/api/reports', {
                        method: 'POST',
                        body: form
                    });
                    if (response.ok) {
                        let savedReportMeta = null;
                        try {
                            savedReportMeta = await response.json();
                        } catch { savedReportMeta = null; }
                        let savedReport = null;
                        if (savedReportMeta && savedReportMeta.id) {
                            // Получаем полный объект отчёта по id
                            const allReports = await fetch('/api/reports').then(r => r.json());
                            savedReport = allReports.find(r => r.id === savedReportMeta.id);
                        }
                        if (!savedReport) {
                            // Если не нашли — fallback на последний отчёт
                            const allReports = await fetch('/api/reports').then(r => r.json());
                            savedReport = allReports && allReports.length > 0 ? allReports[allReports.length - 1] : formData;
                        }
                        console.log('Calling saveAccountBalancesToHistory with', savedReport, employees, accounts);
                        await saveAccountBalancesToHistory(savedReport, employees, accounts);
                        setFormData({
                            employee_id: '',
                            shift_date: '',
                            shift_type: 'morning',
                            total_requests: 0,
                            bybit_requests: 0,
                            htx_requests: 0,
                            bliss_requests: 0,
                            balances: { bybit: [], htx: [], bliss: [], gate: [] },
                            scam_amount: 0,
                            scam_comment: '',
                            scam_personal: false,
                            dokidka_amount: 0,
                            dokidka_comment: '',
                            internal_transfer_amount: 0,
                            internal_transfer_comment: '',
                            bybit_file: null,
                            htx_file: null,
                            bliss_file: null,
                            start_photo: null,
                            end_photo: null
                        });
                        setShowForm(false);
                        loadReports();
                        if (onUpdate) onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating report:', error);
                    alert('Ошибка создания отчёта: ' + error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('Для удаления отчета введите пароль:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/reports/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        loadReports();
                        if (onUpdate) onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Ошибка удаления');
                    }
                } catch (error) {
                    alert('Ошибка удаления');
                }
            };

            const loadReports = async () => {
                try {
                    const params = new URLSearchParams();
                    Object.entries(filters).forEach(([key, value]) => {
                        if (value) params.append(key, value);
                    });
                    const response = await fetch(`/api/reports?${params}`);
                    const data = await response.json();
                    setReports(data); // обновляем только локально!
                } catch (error) {
                    console.error('Error loading reports:', error);
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-file-alt"></i> Отчеты по сменам</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> Добавить отчет
                            </button>
                        </div>

                        <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap'}}>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Сегодня
                                const today = new Date();
                                const d = today.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: d, end_date: d}));
                                setTimeout(loadReports, 0);
                            }}>Сегодня</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Вчера
                                const y = new Date(); y.setDate(y.getDate()-1);
                                const d = y.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: d, end_date: d}));
                                setTimeout(loadReports, 0);
                            }}>Вчера</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Текущая неделя
                                const now = new Date();
                                const day = now.getDay() || 7;
                                const monday = new Date(now); monday.setDate(now.getDate() - day + 1);
                                setFilters(f => ({...f, start_date: monday.toISOString().slice(0,10), end_date: now.toISOString().slice(0,10)}));
                                setTimeout(loadReports, 0);
                            }}>Текущая неделя</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Текущий месяц
                                const now = new Date();
                                const start = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-01';
                                const end = now.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: start, end_date: end}));
                                setTimeout(loadReports, 0);
                            }}>Текущий месяц</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // Последние 7 дней
                                const now = new Date();
                                const start = new Date(now); start.setDate(now.getDate()-6);
                                setFilters(f => ({...f, start_date: start.toISOString().slice(0,10), end_date: now.toISOString().slice(0,10)}));
                                setTimeout(loadReports, 0);
                            }}>Последние 7 дней</button>
                            <button className="btn btn-secondary" type="button" onClick={async () => { // Всё время
                                // Получаем самую раннюю дату из отчетов
                                const response = await fetch('/api/reports');
                                const data = await response.json();
                                if (data.length > 0) {
                                    const minDate = data.map(r => r.shift_date).sort()[0];
                                    const maxDate = data.map(r => r.shift_date).sort().reverse()[0];
                                    setFilters(f => ({...f, start_date: minDate, end_date: maxDate}));
                                    setTimeout(loadReports, 0);
                                }
                            }}>Всё время</button>
                            {/* --- Кнопка Экспорт в CSV --- */}
                            <button className="btn" type="button" style={{marginLeft:16,background:'#27ae60'}} onClick={() => {
                                // Формируем CSV из видимых отчетов
                                function escapeCSV(val, forceQuotes=false) {
                                    if (val == null) return '';
                                    let s = String(val);
                                    if (forceQuotes || s.search(/[",;\n]/) >= 0) {
                                        s = s.replace(/"/g, '""');
                                        return '"'+s+'"';
                                    }
                                    return s;
                                }
                                const header = [
                                    'Дата','Сотрудник','Смена','Всего заявок','Bybit заявки','HTX заявки','Bliss заявки',
                                    'Балансы (JSON)','СКАМ','Комментарий СКАМ','Докидка (внешний перевод, USDT)','Комментарий докидки','Внутренний перевод (USDT)','Комментарий внутреннего перевода',
                                    'BYBIT первая сделка','BYBIT последняя сделка','HTX первая сделка','HTX последняя сделка','BLISS первая сделка','BLISS последняя сделка','GATE первая сделка','GATE последняя сделка'
                                ];
                                const rows = reports.map(r => {
                                    const employee = employees.find(e => e.id === r.employee_id);
                                    let balancesStr = '';
                                    try {
                                        balancesStr = JSON.stringify(JSON.parse(r.balances_json || '{}'));
                                    } catch {
                                        balancesStr = r.balances_json || '';
                                    }
                                    return [
                                        r.shift_date,
                                        employee ? employee.name : '',
                                        r.shift_type,
                                        r.total_requests,
                                        r.bybit_requests,
                                        r.htx_requests,
                                        r.bliss_requests,
                                        balancesStr, // теперь корректный JSON без двойного экранирования
                                        r.scam_amount,
                                        r.scam_comment,
                                        r.dokidka_amount,
                                        r.dokidka_comment,
                                        r.internal_transfer_amount,
                                        r.internal_transfer_comment,
                                        r.bybit_first_trade,
                                        r.bybit_last_trade,
                                        r.htx_first_trade,
                                        r.htx_last_trade,
                                        r.bliss_first_trade,
                                        r.bliss_last_trade,
                                        r.gate_first_trade,
                                        r.gate_last_trade
                                    ].map(v => escapeCSV(v)); // balances_json теперь тоже экранируется escapeCSV
                                });
                                const csv = [header.join(','), ...rows].join('\r\n');
                                const blob = new Blob([csv], {type: 'text/csv'});
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'reports_export.csv';
                                document.body.appendChild(a);
                                a.click();
                                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
                            }}><i className="fas fa-file-csv"></i> Экспорт в CSV</button>
                            {/* --- Кнопка Импорт из CSV --- */}
                            <input id="import-csv-input" type="file" accept=".csv" style={{display:'none'}} onChange={async e => {
                                const file = e.target.files[0];
                                if (!file) return;
                                const text = await file.text();
                                // Парсим CSV через SheetJS
                                const workbook = XLSX.read(text, {type: 'string'});
                                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                const data = XLSX.utils.sheet_to_json(sheet, {header:1});
                                const header = data[0];
                                const rows = data.slice(1);
                                // Проверяем структуру
                                const required = ['Дата','Сотрудник','Смена','Всего заявок'];
                                const missing = required.filter(f => !header.includes(f));
                                if (missing.length > 0) {
                                    alert('Ошибка: отсутствуют обязательные столбцы: ' + missing.join(', ') + '\n\nПример шаблона:\nДата,Сотрудник,Смена,Всего заявок,Bybit заявки,HTX заявки,Bliss заявки,Балансы (JSON),СКАМ,Комментарий СКАМ,Докидка (внешний перевод, USDT),Комментарий докидки,Внутренний перевод (USDT),Комментарий внутреннего перевода,BYBIT первая сделка,BYBIT последняя сделка,HTX первая сделка,HTX последняя сделка,BLISS первая сделка,BLISS последняя сделка,GATE первая сделка,GATE последняя сделка');
                                    e.target.value = '';
                                    return;
                                }
                                // Маппинг по заголовкам
                                const idx = {};
                                header.forEach((h,i) => { idx[h.trim()] = i; });
                                let ok = 0, fail = 0;
                                let errorDetails = [];
                                for (let i = 0; i < rows.length; i++) {
                                    if (rows[i].length < 4) { fail++; errorDetails.push(`Строка ${i+2}: неверный формат данных`); continue; }
                                    let balances = rows[i][idx['Балансы (JSON)']];
                                    let valid = true;
                                    // Первая попытка
                                    try {
                                        JSON.parse(balances || '{}');
                                    } catch {
                                        valid = false;
                                    }
                                    if (!valid) {
                                        fail++;
                                        errorDetails.push(`Строка ${i+2}: невалидный JSON (пример: ${String(rows[i][idx['Балансы (JSON)']]).slice(0, 40)}...)`);
                                        continue;
                                    }
                                    const payload = {
                                        shift_date: (() => {
                                            let val = rows[i][idx['Дата']];
                                            // Если это число (Excel date), преобразуем в YYYY-MM-DD
                                            if (typeof val === 'number' || (!isNaN(val) && val !== '' && typeof val !== 'string')) {
                                                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                                const jsDate = new Date(excelEpoch.getTime() + (Math.floor(val) * 86400000));
                                                if (val % 1 !== 0) {
                                                    jsDate.setTime(jsDate.getTime() + Math.round((val % 1) * 86400000));
                                                }
                                                return jsDate.toISOString().slice(0, 10);
                                            }
                                            // Если строка — пробуем привести к дате
                                            if (typeof val === 'string' && val.match(/^\d+(\.\d+)?$/)) {
                                                const num = parseFloat(val);
                                                if (!isNaN(num)) {
                                                    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                                    const jsDate = new Date(excelEpoch.getTime() + (Math.floor(num) * 86400000));
                                                    if (num % 1 !== 0) {
                                                        jsDate.setTime(jsDate.getTime() + Math.round((num % 1) * 86400000));
                                                    }
                                                    return jsDate.toISOString().slice(0, 10);
                                                }
                                            }
                                            return String(val).trim();
                                        })(),
                                        employee_name: rows[i][idx['Сотрудник']],
                                        shift_type: rows[i][idx['Смена']],
                                        total_requests: rows[i][idx['Всего заявок']],
                                        bybit_requests: rows[i][idx['Bybit заявки']],
                                        htx_requests: rows[i][idx['HTX заявки']],
                                        bliss_requests: rows[i][idx['Bliss заявки']],
                                        balances_json: balances,
                                        scam_amount: rows[i][idx['СКАМ']],
                                        scam_comment: rows[i][idx['Комментарий СКАМ']],
                                        dokidka_amount: rows[i][idx['Докидка (внешний перевод, USDT)']],
                                        dokidka_comment: rows[i][idx['Комментарий докидки']],
                                        internal_transfer_amount: rows[i][idx['Внутренний перевод (USDT)']],
                                        internal_transfer_comment: rows[i][idx['Комментарий внутреннего перевода']],
                                        bybit_first_trade: rows[i][idx['BYBIT первая сделка']],
                                        bybit_last_trade: rows[i][idx['BYBIT последняя сделка']],
                                        htx_first_trade: rows[i][idx['HTX первая сделка']],
                                        htx_last_trade: rows[i][idx['HTX последняя сделка']],
                                        bliss_first_trade: rows[i][idx['BLISS первая сделка']],
                                        bliss_last_trade: rows[i][idx['BLISS последняя сделка']],
                                        gate_first_trade: rows[i][idx['GATE первая сделка']],
                                        gate_last_trade: rows[i][idx['GATE последняя сделка']]
                                    };
                                    // Получаем employee_id по имени
                                    const emp = employees.find(e => String(e.name).trim() === String(payload.employee_name).trim());
                                    if (!emp) { fail++; errorDetails.push(`Строка ${i+2}: сотрудник не найден`); continue; }
                                    payload.employee_id = emp.id;
                                    // Отправляем на бэкенд
                                    try {
                                        const resp = await fetch('/api/reports', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(payload)
                                        });
                                        if (resp.ok) ok++; else fail++;
                                    } catch { fail++; errorDetails.push(`Строка ${i+2}: ошибка при отправке на сервер`); }
                                }
                                let msg = `Импорт завершен. Успешно: ${ok} строк, ошибок: ${fail}`;
                                if (errorDetails.length > 0) msg += '\n\nОшибки:\n' + errorDetails.join('\n');
                                alert(msg);
                                loadReports();
                                e.target.value = '';
                            }} />
                            <button className="btn btn-secondary" type="button" style={{background:'#f7b731'}} onClick={() => document.getElementById('import-csv-input').click()}><i className="fas fa-file-import"></i> Импорт из CSV</button>
                            <button className="btn" type="button" style={{marginLeft:8,background:'#3c78d8'}} onClick={() => {
                                // Экспорт в Excel (XLSX) через SheetJS
                                const header = [
                                    'Дата','Сотрудник','Смена','Всего заявок','Bybit заявки','HTX заявки','Bliss заявки',
                                    'Балансы (JSON)','СКАМ','Комментарий СКАМ','Докидка (внешний перевод, USDT)','Комментарий докидки','Внутренний перевод (USDT)','Комментарий внутреннего перевода',
                                    'BYBIT первая сделка','BYBIT последняя сделка','HTX первая сделка','HTX последняя сделка','BLISS первая сделка','BLISS последняя сделка','GATE первая сделка','GATE последняя сделка'
                                ];
                                const rows = reports.map(r => {
                                    const employee = employees.find(e => e.id === r.employee_id);
                                    let balancesStr = '';
                                    try {
                                        balancesStr = JSON.stringify(JSON.parse(r.balances_json || '{}'));
                                    } catch {
                                        balancesStr = r.balances_json || '';
                                    }
                                    return [
                                        r.shift_date,
                                        employee ? employee.name : '',
                                        r.shift_type,
                                        r.total_requests,
                                        r.bybit_requests,
                                        r.htx_requests,
                                        r.bliss_requests,
                                        balancesStr, // теперь корректный JSON без двойного экранирования
                                        r.scam_amount,
                                        r.scam_comment,
                                        r.dokidka_amount,
                                        r.dokidka_comment,
                                        r.internal_transfer_amount,
                                        r.internal_transfer_comment,
                                        r.bybit_first_trade,
                                        r.bybit_last_trade,
                                        r.htx_first_trade,
                                        r.htx_last_trade,
                                        r.bliss_first_trade,
                                        r.bliss_last_trade,
                                        r.gate_first_trade,
                                        r.gate_last_trade
                                    ].map(v => escapeCSV(v)); // balances_json теперь тоже экранируется escapeCSV
                                });
                                const ws = window.XLSX.utils.aoa_to_sheet([header, ...rows]);
                                const wb = window.XLSX.utils.book_new();
                                window.XLSX.utils.book_append_sheet(wb, ws, 'Отчеты');
                                window.XLSX.writeFile(wb, 'reports_export.xlsx');
                            }}><i className="fas fa-file-excel"></i> Экспорт в Excel</button>
                        </div>
                        <div className="filters" style={{marginBottom: '8px'}}>
                            <div className="filter-item">
                                <label>Дата начала</label>
                                <input type="date" className="form-control" value={filters.start_date} onChange={e => setFilters({...filters, start_date: e.target.value})} />
                            </div>
                            <div className="filter-item">
                                <label>Дата окончания</label>
                                <input type="date" className="form-control" value={filters.end_date} onChange={e => setFilters({...filters, end_date: e.target.value})} />
                            </div>
                            <div className="filter-item">
                                <label>Сотрудник</label>
                                <select className="form-control" value={filters.employee_id} onChange={e => setFilters({...filters, employee_id: e.target.value})}>
                                    <option value="">Все сотрудники</option>
                                    {employees.map(emp => (
                                        <option key={emp.id} value={emp.id}>{emp.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="filter-item" style={{ display: 'flex', alignItems: 'end' }}>
                                <button className="btn" onClick={loadReports}>
                                    <i className="fas fa-search"></i> Применить фильтры
                                </button>
                            </div>
                        </div>
                        <hr style={{margin: '24px 0', border: 'none', borderTop: '2px solid #e1e8ed'}} />
                        {showForm && (
                            <div>
                                <h4 style={{marginBottom: '16px', color: '#667eea'}}>Добавить отчет</h4>
                                <form onSubmit={handleSubmit} encType="multipart/form-data" style={{ marginBottom: '20px', padding: '28px', background: '#f8f9fa', borderRadius: '14px', marginTop: '16px', boxShadow: '0 2px 12px rgba(102,126,234,0.07)', maxWidth: 1100, marginLeft: 'auto', marginRight: 'auto' }}>
                                    {/* Основная информация */}
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(260px, 1fr))',gap:'18px',marginBottom:24}}>
                                        <div className="form-group">
                                            <label>Сотрудник</label>
                                            <select className="form-control" value={formData.employee_id} onChange={e => setFormData({...formData, employee_id: e.target.value})} required>
                                                <option value="">Выберите сотрудника</option>
                                                {employees.map(emp => (
                                                    <option key={emp.id} value={emp.id}>{emp.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div className="form-group">
                                            <label>Дата смены</label>
                                            <input type="date" className="form-control" value={formData.shift_date} onChange={e => setFormData({...formData, shift_date: e.target.value})} required />
                                        </div>
                                        <div className="form-group">
                                            <label>Тип смены</label>
                                            <select className="form-control" value={formData.shift_type} onChange={e => setFormData({...formData, shift_type: e.target.value})}>
                                                <option value="morning">Утренняя</option>
                                                <option value="evening">Вечерняя</option>
                                            </select>
                                        </div>
                                    </div>
                                    <hr style={{margin:'18px 0'}} />
                                    {/* Заявки по площадкам */}
                                    <div style={{marginBottom:16}}><b style={{color:'#764ba2'}}>Заявки по площадкам</b></div>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))',gap:'16px',marginBottom:24}}>
                                        <div className="form-group">
                                            <label>Заявок на Bybit</label>
                                            <input
                                                type="number"
                                                onWheel={e => e.target.blur()}
                                                className="form-control"
                                                value={formData.bybit_requests || ''}
                                                onChange={e => setFormData({...formData, bybit_requests: e.target.value})}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Заявок на HTX</label>
                                            <input
                                                type="number"
                                                onWheel={e => e.target.blur()}
                                                className="form-control"
                                                value={formData.htx_requests || ''}
                                                onChange={e => setFormData({...formData, htx_requests: e.target.value})}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Заявок на Bliss</label>
                                            <input
                                                type="number"
                                                onWheel={e => e.target.blur()}
                                                className="form-control"
                                                value={formData.bliss_requests || ''}
                                                onChange={e => setFormData({...formData, bliss_requests: e.target.value})}
                                            />
                                        </div>
                                    </div>
                                    <hr style={{margin:'18px 0'}} />
                                    {/* Балансы по аккаунтам */}
                                    <div style={{marginBottom:16}}><b style={{color:'#764ba2'}}>Балансы по аккаунтам</b></div>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(260px, 1fr))',gap:'18px',marginBottom:24}}>
                                        {["bybit", "htx", "bliss", "gate"].map(platform => (
                                            <div className="form-group" key={platform}>
                                                <label style={{fontWeight:600}}>{platform.toUpperCase()} аккаунты</label>
                                                <div style={{display:'flex',flexWrap:'wrap',gap:'10px',marginBottom:6}}>
                                                    {accounts.filter(a => a.platform === platform).map(acc => {
                                                        const checked = formData.balances[platform].some(a2 => a2.id === acc.id);
                                                        return (
                                                            <label key={acc.id} style={{marginRight:10,display:'flex',alignItems:'center',gap:4}}>
                                                                <input
                                                                    type="checkbox"
                                                                    checked={checked}
                                                                    onChange={e => {
                                                                        if (e.target.checked) {
                                                                            handleAccountChange(platform, [...formData.balances[platform].map(a => a.id.toString()), acc.id.toString()]);
                                                                        } else {
                                                                            handleAccountChange(platform, formData.balances[platform].filter(a => a.id !== acc.id).map(a => a.id.toString()));
                                                                        }
                                                                    }}
                                                                />
                                                                {acc.account_name}
                                                            </label>
                                                        );
                                                    })}
                                                </div>
                                                {/* Для каждого выбранного аккаунта отдельное поле баланса */}
                                                {formData.balances[platform].map((acc, idx) => (
                                                    <div key={acc.id || acc.account_id} style={{ marginTop: 5 }}>
                                                        <label>Начальный баланс для {acc.account_name}:</label>
                                                        <input
                                                            type="number"
                                                            onWheel={e => e.target.blur()}
                                                            className="form-control"
                                                            value={acc.start_balance}
                                                            onChange={e => handleBalanceChange(platform, idx, 'start_balance', e.target.value)}
                                                        />
                                                        <label style={{marginTop:4}}>Конечный баланс для {acc.account_name}:</label>
                                                        <input
                                                            type="number"
                                                            onWheel={e => e.target.blur()}
                                                            className="form-control"
                                                            value={acc.end_balance}
                                                            onChange={e => handleBalanceChange(platform, idx, 'end_balance', e.target.value)}
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                    <hr style={{margin:'18px 0'}} />
                                    {/* СКАМ и переводы */}
                                    <div style={{marginBottom:16}}><b style={{color:'#764ba2'}}>СКАМ и переводы</b></div>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(260px, 1fr))',gap:'18px',marginBottom:24}}>
                                        <div className="form-group">
                                            <label>СКАМ (сумма, USDT)</label>
                                            <input
                                                type="number"
                                                onWheel={e => e.target.blur()}
                                                className="form-control"
                                                value={formData.scam_amount}
                                                onChange={e => setFormData({ ...formData, scam_amount: e.target.value })}
                                            />
                                            <label>Комментарий по СКАМ</label>
                                            <input
                                                type="text"
                                                onWheel={e => e.target.blur()}
                                                className="form-control"
                                                value={formData.scam_comment}
                                                onChange={e => setFormData({ ...formData, scam_comment: e.target.value })}
                                            />
                                            <div style={{marginTop:8}}>
                                                <label style={{fontWeight:400, fontSize:'0.98em'}}>
                                                    <input type="checkbox" checked={formData.scam_personal || false} onChange={e => setFormData({ ...formData, scam_personal: e.target.checked })} /> По моей вине (вычитается из чистой прибыли)
                                                </label>
                                            </div>
                                        </div>
                                        <div className="form-group">
                                            <label>Докидка (внешний перевод, USDT)</label>
                                            <input
                                                type="number"
                                                onWheel={e => e.target.blur()}
                                                className="form-control"
                                                value={formData.dokidka_amount}
                                                onChange={e => setFormData({ ...formData, dokidka_amount: e.target.value })}
                                            />
                                            <label>Комментарий по докидке</label>
                                            <input
                                                type="text"
                                                className="form-control"
                                                value={formData.dokidka_comment}
                                                onChange={e => setFormData({ ...formData, dokidka_comment: e.target.value })}
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>Внутренний перевод (USDT)</label>
                                            <input
                                                type="number"
                                                onWheel={e => e.target.blur()}
                                                className="form-control"
                                                value={formData.internal_transfer_amount}
                                                onChange={e => setFormData({ ...formData, internal_transfer_amount: e.target.value })}
                                            />
                                            <label>Комментарий по внутреннему переводу</label>
                                            <input
                                                type="text"
                                                className="form-control"
                                                value={formData.internal_transfer_comment}
                                                onChange={e => setFormData({ ...formData, internal_transfer_comment: e.target.value })}
                                            />
                                        </div>
                                    </div>
                                    <hr style={{margin:'18px 0'}} />
                                    {/* Файлы и фото */}
                                    <div style={{marginBottom:16}}><b style={{color:'#764ba2'}}>Файлы и фото</b></div>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(260px, 1fr))',gap:'18px',marginBottom:24}}>
                                        <div className="form-group">
                                            <label>Выгрузка Bybit</label>
                                            <input type="file" className="form-control" accept=".csv,.xlsx,.xls" onChange={e => setFormData(fd => ({...fd, bybit_file: e.target.files[0]}))} />
                                        </div>
                                        <div className="form-group">
                                            <label>Выгрузка HTX</label>
                                            <input type="file" className="form-control" accept=".csv,.xlsx,.xls" onChange={e => setFormData(fd => ({...fd, htx_file: e.target.files[0]}))} />
                                        </div>
                                        <div className="form-group">
                                            <label>Выгрузка Bliss</label>
                                            <input type="file" className="form-control" accept=".csv,.xlsx,.xls" onChange={e => setFormData(fd => ({...fd, bliss_file: e.target.files[0]}))} />
                                        </div>
                                        <div className="form-group">
                                            <label>Фото начала смены</label>
                                            <input type="file" className="form-control" accept="image/*" onChange={e => setFormData(fd => ({...fd, start_photo: e.target.files[0]}))} />
                                        </div>
                                        <div className="form-group">
                                            <label>Фото конца смены</label>
                                            <input type="file" className="form-control" accept="image/*" onChange={e => setFormData(fd => ({...fd, end_photo: e.target.files[0]}))} />
                                        </div>
                                    </div>
                                    <div style={{marginBottom:16}}><b style={{color:'#764ba2'}}>Даты сделок по площадкам</b></div>
                                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))',gap:'16px',marginBottom:24}}>
                                      {['bybit','htx','bliss','gate'].map(platform => (
                                        <div className="form-group" key={platform}>
                                          <label style={{fontWeight:600}}>{platform.toUpperCase()}</label>
                                          <input
                                            type="text"
                                            className="form-control"
                                            placeholder="Дата первой сделки"
                                            value={formData[platform + '_first_trade'] || ''}
                                            onChange={e => setFormData(fd => ({...fd, [platform + '_first_trade']: e.target.value}))}
                                          />
                                          <input
                                            type="text"
                                            className="form-control"
                                            placeholder="Дата последней сделки"
                                            style={{marginTop:8}}
                                            value={formData[platform + '_last_trade'] || ''}
                                            onChange={e => setFormData(fd => ({...fd, [platform + '_last_trade']: e.target.value}))}
                                          />
                                        </div>
                                      ))}
                                    </div>
                                    <div style={{display:'flex',gap:12,marginTop:18}}>
                                        <button type="submit" className="btn">Сохранить</button>
                                        <button type="button" className="btn btn-secondary" onClick={() => setShowForm(false)}>Отмена</button>
                                    </div>
                                </form>
                            </div>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Сотрудник</th>
                                    <th>Смена</th>
                                    <th>Всего заявок</th>
                                    <th>Баланс по аккаунтам (Δ)</th>
                                    <th>СКАМ</th>
                                    <th>Докидка (внешний перевод, USDT)</th>
                                    <th>Внутренний перевод (USDT)</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {reports.map((report, idx) => {
                                    const employee = employees.find(emp => emp.id === report.employee_id);
                                    let balances = {};
                                    try { balances = JSON.parse(report.balances_json || '{}'); } catch { balances = {}; }
                                    // Для расчета Δ ищем предыдущий отчет по каждому аккаунту (не по сотруднику)
                                    function findPrevBalance(account_id, platform) {
                                        // Ищем все отчеты до текущего (по времени и смене), где есть этот аккаунт
                                        const prev = reports
                                            .filter(r => {
                                                if (r.id === report.id) return false;
                                                // Сравниваем дату+смену
                                                if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                                                let b = {};
                                                try { b = JSON.parse(r.balances_json || '{}'); } catch { b = {}; }
                                                return b[platform] && b[platform].some(a => (a.account_id || a.id) == account_id);
                                            })
                                            .sort((a, b) => {
                                                // Сортируем по времени убыванию (последний раньше)
                                                if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                                                if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                                                return 0;
                                            });
                                        if (prev.length > 0) {
                                            let b = {};
                                            try { b = JSON.parse(prev[0].balances_json || '{}'); } catch { b = {}; }
                                            const acc = b[platform].find(a => (a.account_id || a.id) == account_id);
                                            return acc && acc.balance !== undefined ? parseFloat(acc.balance) : 0;
                                        }
                                        // Если нет предыдущего отчета — ищем начальный баланс
                                        if (window.settingsInitialBalances) {
                                            const acc = window.settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts.find(a => a.id == account_id)?.account_name)));
                                            return acc && acc.balance !== undefined ? parseFloat(acc.balance) : 0;
                                        }
                                        return 0;
                                    }
                                    return (
                                        <React.Fragment key={report.id}>
                                            <tr>
                                                <td>{new Date(report.shift_date).toLocaleDateString('ru-RU')}</td>
                                                <td>{employee ? employee.name : 'Неизвестно'}</td>
                                                <td>{report.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'}</td>
                                                <td>{report.total_requests}</td>
                                                <td>
                                                    {/* Кратко: количество аккаунтов и суммарный Δ */}
                                                    {['bybit','htx','bliss','gate'].map(platform => {
                                                        let sumDelta = 0;
                                                        if (balances[platform] && balances[platform].length > 0) {
                                                            sumDelta = balances[platform].reduce((accum, acc) => {
                                                                const prev = findPrevBalance(acc.account_id || acc.id, platform);
                                                                const diff = acc.balance !== '' ? (parseFloat(acc.balance) - prev) : 0;
                                                                return accum + diff;
                                                            }, 0);
                                                        }
                                                        return (
                                                            <div key={platform} style={{marginBottom: 3}}>
                                                                <b>{platform.toUpperCase()}:</b> {balances[platform]?.length || 0} аккаунтов, Изменение {sumDelta >= 0 ? '+' : ''}{sumDelta.toFixed(2)}
                                                            </div>
                                                        );
                                                    })}
                                                </td>
                                                <td>{report.scam_amount > 0 ? `${report.scam_amount} USDT` : '—'}</td>
                                                <td>{report.dokidka_amount !== 0 ? <span style={{color: report.dokidka_amount < 0 ? '#27ae60' : '#f7b731', fontWeight:600}}>{report.dokidka_amount > 0 ? '+' : ''}{report.dokidka_amount} USDT</span> : '—'}</td>
                                                <td>{report.internal_transfer_amount !== 0 ? <span style={{color: report.internal_transfer_amount < 0 ? '#27ae60' : '#f7b731', fontWeight:600}}>{report.internal_transfer_amount > 0 ? '+' : ''}{report.internal_transfer_amount} USDT</span> : '—'}</td>
                                                <td>
                                                    <button className="btn btn-secondary" style={{padding:'4px 10px',fontSize:'0.9em'}} onClick={() => setExpandedReportId(expandedReportId === report.id ? null : report.id)}>
                                                        {expandedReportId === report.id ? 'Скрыть' : 'Подробнее'}
                                                    </button>
                                                </td>
                                                <td>
                                                    <button className="btn btn-secondary" onClick={() => handleDelete(report.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>Удалить</button>
                                                </td>
                                            </tr>
                                            {expandedReportId === report.id && (
                                                <ReportDetails report={report} reports={reports} employees={employees} accounts={accounts} setShowDetails={setShowDetails} showDetails={showDetails} setZoomedImage={setZoomedImage} />
                                            )}
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    {/* Модальное окно для увеличенного фото */}
                    {zoomedImage && (
                        <div style={{position:'fixed',top:0,left:0,width:'100vw',height:'100vh',background:'rgba(0,0,0,0.7)',zIndex:9999,display:'flex',alignItems:'center',justifyContent:'center'}} onClick={() => setZoomedImage(null)}>
                            <img src={zoomedImage} alt="Увеличенное фото" style={{maxHeight:'90vh',maxWidth:'90vw',borderRadius:12,boxShadow:'0 4px 32px #000'}} onClick={e => e.stopPropagation()} />
                            <button onClick={() => setZoomedImage(null)} style={{position:'fixed',top:30,right:40,fontSize:32,color:'#fff',background:'none',border:'none',cursor:'pointer',zIndex:10000}} title="Закрыть">&times;</button>
                        </div>
                    )}
                </div>
            );
        }

        // Добавляю компонент ReportDetails
        function ReportDetails({ report, reports, employees, accounts, setShowDetails, showDetails, setZoomedImage }) {
            const employee = employees.find(emp => emp.id === report.employee_id);
            let balances = {};
            try { balances = JSON.parse(report.balances_json || '{}'); } catch { balances = {}; }
            
            // Получаем статистику по ордерам для этой смены
            const [orderStats, setOrderStats] = useState(null);
            
            useEffect(() => {
                // Загружаем статистику по ордерам при открытии деталей
                if (showDetails) {
                    const url = `/api/orders/statistics?exclude_canceled=true&start_date=${report.shift_date}&end_date=${report.shift_date}&dokidka_amount=${report.dokidka_amount || 0}&internal_transfer_amount=${report.internal_transfer_amount || 0}&scam_amount=${report.scam_amount || 0}`;
                    
                    fetch(url)
                        .then(res => res.json())
                        .then(data => setOrderStats(data))
                        .catch(err => console.error('Ошибка загрузки статистики:', err));
                }
            }, [report.id, showDetails]);

            return (
                <div className="report-details" style={{display: showDetails ? 'block' : 'none'}}>
                    {/* Заголовок */}
                    <div className="report-header">
                        <h3>
                            <i className="fas fa-file-alt" style={{marginRight: '8px', color: '#667eea'}}></i>
                            Детали отчета от {new Date(report.shift_date).toLocaleDateString('ru-RU')} 
                            ({report.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'} смена)
                        </h3>
                        <button onClick={() => setShowDetails(false)}>✕</button>
                    </div>
                    
                    {/* Основная информация */}
                    <div style={{marginBottom: '24px', display: 'flex', gap: '16px', flexWrap: 'wrap'}}>
                        <div style={{background: '#fff', padding: '12px 16px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <i className="fas fa-user" style={{color: '#667eea'}}></i>
                            <span>Сотрудник: <b>{employee ? employee.name : 'Неизвестно'}</b></span>
                        </div>
                        <div style={{background: '#fff', padding: '12px 16px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '8px'}}>
                            <i className="fas fa-clock" style={{color: '#667eea'}}></i>
                            <span>Время смены: <b>{report.shift_start_time ? report.shift_start_time.slice(0,5) : '??:??'} - {report.shift_end_time ? report.shift_end_time.slice(0,5) : '??:??'}</b></span>
                        </div>
                    </div>
                    
                    {/* Статистика по ордерам */}
                    <div className="stats-section">
                        <h4>
                            <i className="fas fa-chart-line" style={{marginRight: '8px'}}></i>
                            Статистика по ордерам
                        </h4>
                        {orderStats ? (
                            <div className="stats-grid">
                                <div className="stat-item">
                                    <label>Общая сумма продаж:</label>
                                    <div>
                                        <div>{formatNumber(orderStats.sell_volume_rub)} ₽</div>
                                        <div style={{fontSize: '0.9em', color: '#667eea'}}>{formatNumber(orderStats.sell_volume_usdt)} USDT</div>
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <label>Общая сумма покупок:</label>
                                    <div>
                                        <div>{formatNumber(orderStats.buy_volume_rub)} ₽</div>
                                        <div style={{fontSize: '0.9em', color: '#667eea'}}>{formatNumber(orderStats.buy_volume_usdt)} USDT</div>
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <label>Базовая прибыль:</label>
                                    <div style={{color: orderStats.profit_usdt >= 0 ? '#27ae60' : '#e74c3c'}}>
                                        {orderStats.profit_usdt >= 0 ? '+' : ''}{formatNumber(orderStats.profit_usdt + orderStats.dokidka_amount + orderStats.internal_transfer_amount + orderStats.scam_amount)} USDT
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <label>Докидка:</label>
                                    <div style={{color: '#e74c3c'}}>
                                        -{formatNumber(orderStats.dokidka_amount)} USDT
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <label>Внутренний перевод:</label>
                                    <div style={{color: '#e74c3c'}}>
                                        -{formatNumber(orderStats.internal_transfer_amount)} USDT
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <label>Скам:</label>
                                    <div style={{color: '#e74c3c'}}>
                                        -{formatNumber(orderStats.scam_amount)} USDT
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <label>Итоговая прибыль:</label>
                                    <div style={{color: orderStats.profit_usdt >= 0 ? '#27ae60' : '#e74c3c', fontWeight: 'bold'}}>
                                        {orderStats.profit_usdt >= 0 ? '+' : ''}{formatNumber(orderStats.profit_usdt)} USDT
                                    </div>
                                </div>
                                <div className="stat-item">
                                    <label>Средняя цена продажи:</label>
                                    <div>{formatNumber(orderStats.avg_sell_rate)} ₽/USDT</div>
                                </div>
                                <div className="stat-item">
                                    <label>Средняя цена покупки:</label>
                                    <div>{formatNumber(orderStats.avg_buy_rate)} ₽/USDT</div>
                                </div>
                                <div className="stat-item">
                                    <label>Количество ордеров:</label>
                                    <div>
                                        <div>Продажа: {orderStats.sell_orders}</div>
                                        <div>Покупка: {orderStats.buy_orders}</div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div style={{textAlign: 'center', padding: '20px', color: '#888'}}>
                                <i className="fas fa-spinner fa-spin" style={{marginRight: '8px'}}></i>
                                Загрузка статистики...
                            </div>
                        )}
                    </div>
                    
                    {/* Остальные секции */}
                    <div className="balances-section">
                        {/* ... существующий код для отображения балансов ... */}
                    </div>
                </div>
            );
        }

        // Вспомогательная функция для форматирования чисел
        function formatNumber(num) {
            if (num === null || num === undefined) return '0.00';
            return Number(num).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }

        // --- ДОБАВЛЯЮ КОМПОНЕНТ AccountBalancesTable ---
        function AccountBalancesTable({ balances, reports, report, accounts }) {
            function findPrevBalance(account_id, platform) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        let b = {};
                        try { b = JSON.parse(r.balances_json || '{}'); } catch { b = {}; }
                        return b[platform] && b[platform].some(a => (a.account_id || a.id) == account_id);
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let b = {};
                    try { b = JSON.parse(prev[0].balances_json || '{}'); } catch { b = {}; }
                    const acc = b[platform].find(a => (a.account_id || a.id) == account_id);
                    return acc && acc.balance !== undefined ? parseFloat(acc.balance) : 0;
                }
                if (window.settingsInitialBalances) {
                    const acc = window.settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts.find(a => a.id == account_id)?.account_name)));
                    return acc && acc.balance !== undefined ? parseFloat(acc.balance) : 0;
                }
                return 0;
            }
            return (
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(320px, 1fr))',gap:'18px',marginTop:8,marginBottom:18}}>
                    {['bybit','htx','bliss','gate'].map(platform => (
                        <div key={platform} style={{background:'#f8f9fa',borderRadius:12,padding:'14px 18px',boxShadow:'0 2px 8px #e1e8ed'}}>
                            <div style={{fontWeight:600,color:'#667eea',marginBottom:6}}><i className="fas fa-circle" style={{fontSize:10,marginRight:6,color:'#764ba2'}}></i>{platform.toUpperCase()}</div>
                            {balances[platform] && balances[platform].length > 0 ? (
                                <table style={{width:'100%',fontSize:'1em'}}>
                                    <thead><tr><th style={{textAlign:'left'}}>Аккаунт</th><th style={{textAlign:'right'}}>Начальный</th><th style={{textAlign:'right'}}>Конечный</th><th style={{textAlign:'right'}}>Δ</th></tr></thead>
                                    <tbody>
                                        {balances[platform].map(acc => {
                                            const start = acc.start_balance !== '' && !isNaN(acc.start_balance) ? parseFloat(acc.start_balance) : 0;
                                            const end = acc.end_balance !== '' && !isNaN(acc.end_balance) ? parseFloat(acc.end_balance) : 0;
                                            const diff = end - start;
                                            return (
                                                <tr key={acc.account_id || acc.id}>
                                                    <td>{acc.account_name}</td>
                                                    <td style={{textAlign:'right'}}>{start} USDT</td>
                                                    <td style={{textAlign:'right'}}>{end} USDT</td>
                                                    <td style={{textAlign:'right',color:diff>=0?'#27ae60':'#e74c3c',fontWeight:600}} title="Разница за смену">{diff>=0?'+':''}{diff.toFixed(2)}</td>
                                                </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                            ) : (
                                <span style={{color:'#aaa',marginLeft:8}}>—</span>
                            )}
                        </div>
                    ))}
                </div>
            );
        }

        // --- ДОБАВЛЯЮ КОМПОНЕНТ ReportFilesSection ---
        function ReportFilesSection({ report, setZoomedImage }) {
            // Состояния для ошибок загрузки фото
            const [startPhotoError, setStartPhotoError] = React.useState(false);
            const [endPhotoError, setEndPhotoError] = React.useState(false);
            // Состояния для ошибок файлов (можно расширить при необходимости)
            // ...
            return (
                <>
                    <div style={{margin:'24px 0 10px 0',display:'flex',alignItems:'center',gap:16}}>
                        <i className="fas fa-paperclip" style={{color:'#764ba2',fontSize:20}}></i>
                        <span style={{fontWeight:700,fontSize:'1.1em',color:'#764ba2'}}>Файлы и фото:</span>
                    </div>
                    <div style={{display:'flex',gap:32,flexWrap:'wrap',alignItems:'flex-start',marginTop:8}}>
                        <div style={{minWidth:180}}>
                            <b style={{color:'#764ba2'}}>Выгрузки с площадок:</b>
                            <ul style={{margin:'8px 0 0 18px',padding:0}}>
                                {report.bybit_file ? (
                                    <li><i className="fab fa-btc" style={{color:'#f7b731',marginRight:6}}></i><a href={report.bybit_file} target="_blank" rel="noopener noreferrer">Bybit</a></li>
                                ) : <li style={{color:'#aaa'}}>Bybit: файл не найден</li>}
                                {report.htx_file ? (
                                    <li><i className="fab fa-hubspot" style={{color:'#27ae60',marginRight:6}}></i><a href={report.htx_file} target="_blank" rel="noopener noreferrer">HTX</a></li>
                                ) : <li style={{color:'#aaa'}}>HTX: файл не найден</li>}
                                {report.bliss_file ? (
                                    <li><i className="fas fa-bolt" style={{color:'#e74c3c',marginRight:6}}></i><a href={report.bliss_file} target="_blank" rel="noopener noreferrer">Bliss</a></li>
                                ) : <li style={{color:'#aaa'}}>Bliss: файл не найден</li>}
                            </ul>
                        </div>
                        <div style={{display:'flex',gap:24}}>
                            {report.start_photo && !startPhotoError ? (
                                <div><b>Фото начала смены:</b><br/>
                                    <img src={report.start_photo} alt="Фото начала" style={{maxWidth:120, borderRadius:12, marginTop:4, cursor:'zoom-in',boxShadow:'0 2px 8px #aaa'}} onClick={() => setZoomedImage(report.start_photo)} onError={() => setStartPhotoError(true)} />
                                </div>
                            ) : report.start_photo ? (
                                <div style={{color:'#e74c3c',marginTop:12}}><b>Фото начала не найдено</b></div>
                            ) : null}
                            {report.end_photo && !endPhotoError ? (
                                <div><b>Фото конца смены:</b><br/>
                                    <img src={report.end_photo} alt="Фото конца" style={{maxWidth:120, borderRadius:12, marginTop:4, cursor:'zoom-in',boxShadow:'0 2px 8px #aaa'}} onClick={() => setZoomedImage(report.end_photo)} onError={() => setEndPhotoError(true)} />
                                </div>
                            ) : report.end_photo ? (
                                <div style={{color:'#e74c3c',marginTop:12}}><b>Фото конца не найдено</b></div>
                            ) : null}
                        </div>
                    </div>
                </>
            );
        }

        function Settings({ authed, setAuthed, password, setPassword, initialBalances, setInitialBalances, accounts, loading }) {
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            // Группируем аккаунты по платформам
            const platforms = [
                { value: 'bybit', label: 'Bybit' },
                { value: 'htx', label: 'HTX' },
                { value: 'bliss', label: 'Bliss' },
                { value: 'gate', label: 'Gate' }
            ];
            const grouped = {};
            platforms.forEach(p => grouped[p.value] = []);
            accounts.forEach(acc => {
                if (grouped[acc.platform]) grouped[acc.platform].push(acc);
            });
            // Сопоставляем балансы с аккаунтами
            const getBalance = (platform, account_name) => {
                const found = initialBalances.find(b => b.platform === platform && b.account_name === account_name);
                return found ? found.balance : '';
            };
            const handleBalanceChange = (platform, account_name, value) => {
                setInitialBalances(balances => {
                    const idx = balances.findIndex(b => b.platform === platform && b.account_name === account_name);
                    if (idx >= 0) {
                        const updated = [...balances];
                        updated[idx] = { ...updated[idx], balance: value };
                        return updated;
                    } else {
                        return [...balances, { platform, account_name, balance: value }];
                    }
                });
            };
            const handleSave = async () => {
                setSaving(true); setError(''); setSuccess('');
                try {
                    const response = await fetch('/api/settings/balances', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password, balances: initialBalances })
                    });
                    if (response.ok) {
                        setSuccess('Сохранено!');
                    } else {
                        const data = await response.json();
                        setError(data.error || 'Ошибка сохранения');
                    }
                } catch (e) {
                    setError('Ошибка сохранения');
                }
                setSaving(false);
            };
            if (!authed) {
                return (
                    <div className="card" style={{maxWidth:400,margin:'40px auto',textAlign:'center'}}>
                        <h3><i className="fas fa-lock"></i> Вход в настройки</h3>
                        <input type="password" className="form-control" placeholder="Пароль администратора" value={password} onChange={e => setPassword(e.target.value)} style={{margin:'20px 0'}} />
                        <button className="btn" onClick={() => { if (password === 'Blalala2') setAuthed(true); else setError('Неверный пароль'); }}>Войти</button>
                        {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                    </div>
                );
            }
            if (loading) return <div className="loading">Загрузка...</div>;
            return (
                <div className="card">
                    <h3><i className="fas fa-cog"></i> Начальные балансы аккаунтов</h3>
                    <p style={{color:'#888'}}>Эти значения будут использоваться как стартовые для расчета дельт и первой статистики.</p>
                    <div className="form-group" style={{maxWidth:300,margin:'0 0 18px 0'}}>
                        <label>Пароль администратора для сохранения</label>
                        <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} placeholder="Пароль администратора" />
                    </div>
                    {platforms.map(p => (
                        <div key={p.value} style={{marginBottom:20}}>
                            <b>{p.label}</b>
                            {grouped[p.value].length === 0 ? <div style={{color:'#aaa'}}>Нет аккаунтов</div> : (
                                <table className="table" style={{marginTop:8}}>
                                    <thead><tr><th>Аккаунт</th><th>Начальный баланс</th></tr></thead>
                                    <tbody>
                                        {grouped[p.value].map(acc => (
                                            <tr key={acc.id}>
                                                <td>{acc.account_name}</td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        onWheel={e => e.target.blur()}
                                                        className="form-control"
                                                        style={{maxWidth:120}}
                                                        value={getBalance(p.value, acc.account_name)}
                                                        onChange={e => handleBalanceChange(p.value, acc.account_name, e.target.value)}
                                                    />
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    ))}
                    <button className="btn" onClick={handleSave} disabled={saving}>{saving ? 'Сохранение...' : 'Сохранить'}</button>
                    {(!password || password.length < 3) && <div style={{color:'#e74c3c',marginTop:10}}>Введите пароль администратора для сохранения изменений</div>}
                    {success && <div style={{color:'#27ae60',marginTop:10}}>{success}</div>}
                    {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                </div>
            );
        }

        function Statistics({ stats, start, end, setStart, setEnd, loading }) {
            return (
                <div className="card">
                    <h3><i className="fas fa-chart-pie"></i> Подробная статистика по сотрудникам</h3>
                    <div style={{display:'flex',gap:16,alignItems:'end',margin:'18px 0 28px 0',flexWrap:'wrap'}}>
                        <div>
                            <label>Период с</label>
                            <input type="date" className="form-control" value={start} onChange={e => setStart(e.target.value)} style={{minWidth:140}} />
                        </div>
                        <div>
                            <label>по</label>
                            <input type="date" className="form-control" value={end} onChange={e => setEnd(e.target.value)} style={{minWidth:140}} />
                        </div>
                    </div>
                    {loading ? <div className="loading">Загрузка...</div> : (
                        <div style={{overflowX:'auto'}}>
                            <table className="table" style={{minWidth:900}}>
                                <thead>
                                    <tr>
                                        <th>Сотрудник</th>
                                        <th>Смен</th>
                                        <th>Дней</th>
                                        <th>Заявок (всего)</th>
                                        <th>Bybit</th>
                                        <th>HTX</th>
                                        <th>Bliss</th>
                                        <th>Сред. заявок/день</th>
                                        <th><span title="Прибыль минус скам и переводы"><i className='fas fa-coins' style={{color:'#27ae60'}}></i> Прибыль</span></th>
                                        <th><span title="Прибыль минус скам"><i className='fas fa-wallet' style={{color:'#764ba2'}}></i> Чистая прибыль</span></th>
                                        <th><span title="30% от чистой прибыли"><i className='fas fa-money-bill-wave' style={{color:'#27ae60'}}></i> Зарплата</span></th>
                                        <th><span title="Сумма скама"><i className='fas fa-skull-crossbones' style={{color:'#e74c3c'}}></i> Скам</span></th>
                                        <th><span title="Сумма переводов"><i className='fas fa-exchange-alt' style={{color:'#f7b731'}}></i> Переводы</span></th>
                                        <th><span title="Средняя чистая прибыль за смену"><i className='fas fa-chart-line' style={{color:'#3c78d8'}}></i> Сред. прибыль/смену</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {stats.map(emp => (
                                        <tr key={emp.id} style={{background: emp.total_profit > 0 ? '#f8fff8' : emp.total_profit < 0 ? '#fff8f8' : undefined}}>
                                            <td><b>{emp.name}</b><br/><span style={{color:'#888',fontSize:'0.95em'}}>{emp.telegram}</span></td>
                                            <td>{emp.total_shifts}</td>
                                            <td>{emp.total_days}</td>
                                            <td>{emp.total_requests}</td>
                                            <td>{emp.total_bybit}</td>
                                            <td>{emp.total_htx}</td>
                                            <td>{emp.total_bliss}</td>
                                            <td>{emp.avg_requests_per_day}</td>
                                            <td style={{color:'#27ae60',fontWeight:700,fontSize:'1.1em'}}>{emp.total_profit >= 0 ? '+' : ''}{emp.total_profit} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#764ba2',fontWeight:700}}>{emp.net_profit >= 0 ? '+' : ''}{emp.net_profit} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#27ae60',fontWeight:700}}>{emp.salary} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#e74c3c',fontWeight:700}}>{emp.total_scam} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#f7b731',fontWeight:700}}>{emp.total_transfer} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#3c78d8',fontWeight:700}}>{emp.avg_profit_per_shift} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        // --- UI-раздел для истории балансов ---
        function AccountBalanceHistoryViewer({ accounts, employees }) {
            const [history, setHistory] = React.useState([]);
            const [filters, setFilters] = React.useState({ account_id: '', platform: '', employee_id: '', date_from: '', date_to: '' });
            const [page, setPage] = React.useState(1);
            const rowsPerPage = 20;
            React.useEffect(() => {
                let url = '/api/account-balance-history?';
                if (filters.account_id) url += `account_id=${filters.account_id}&`;
                if (filters.platform) url += `platform=${filters.platform}&`;
                if (filters.employee_id) url += `employee_id=${filters.employee_id}&`;
                if (filters.date_from) url += `start_date=${filters.date_from}&`;
                if (filters.date_to) url += `end_date=${filters.date_to}`;
                fetch(url).then(r => r.json()).then(data => { setHistory(data); setPage(1); });
            }, [filters]);
            const filtered = history.filter(h =>
                (!filters.account_id || String(h.account_id) === String(filters.account_id)) &&
                (!filters.platform || h.platform === filters.platform) &&
                (!filters.employee_id || String(h.employee_id) === String(filters.employee_id)) &&
                (!filters.date_from || h.shift_date >= filters.date_from) &&
                (!filters.date_to || h.shift_date <= filters.date_to)
            );
            // Пагинация
            const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
            const paginated = filtered.slice((page-1)*rowsPerPage, page*rowsPerPage);
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) setPage(newPage);
            };
            return (
                <div className="card">
                    <h3><i className="fas fa-database"></i> История балансов аккаунтов</h3>
                    <div style={{display:'flex',gap:12,marginBottom:16,flexWrap:'wrap'}}>
                        <select className="form-control" value={filters.account_id} onChange={e => setFilters(f => ({...f, account_id: e.target.value}))} style={{maxWidth:180}}>
                            <option value="">Все аккаунты</option>
                            {[...new Set(history.map(h => h.account_id))].map(id => (
                                <option key={id} value={id}>{accounts.find(a => a.id == id)?.account_name || id}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.platform} onChange={e => setFilters(f => ({...f, platform: e.target.value}))} style={{maxWidth:140}}>
                            <option value="">Все платформы</option>
                            {[...new Set(history.map(h => h.platform))].map(p => (
                                <option key={p} value={p}>{p.toUpperCase()}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.employee_id} onChange={e => setFilters(f => ({...f, employee_id: e.target.value}))} style={{maxWidth:180}}>
                            <option value="">Все сотрудники</option>
                            {[...new Set(history.map(h => h.employee_id))].map(id => (
                                <option key={id} value={id}>{employees.find(e => e.id == id)?.name || id}</option>
                            ))}
                        </select>
                        <input type="date" className="form-control" value={filters.date_from} onChange={e => setFilters(f => ({...f, date_from: e.target.value}))} style={{maxWidth:160}} placeholder="С даты" />
                        <input type="date" className="form-control" value={filters.date_to} onChange={e => setFilters(f => ({...f, date_to: e.target.value}))} style={{maxWidth:160}} placeholder="По дату" />
                    </div>
                    <div style={{overflowX:'auto'}}>
                        <table className="table" style={{minWidth:900}}>
                            <thead>
                                <tr>
                                    <th>Аккаунт</th>
                                    <th>Платформа</th>
                                    <th>Дата</th>
                                    <th>Смена</th>
                                    <th>Баланс</th>
                                    <th>Сотрудник</th>
                                </tr>
                            </thead>
                            <tbody>
                                {paginated.map((h, idx) => (
                                    <tr key={idx}>
                                        <td>{accounts.find(a => a.id == h.account_id)?.account_name || h.account_id}</td>
                                        <td>{h.platform.toUpperCase()}</td>
                                        <td>{h.shift_date}</td>
                                        <td>{h.shift_type === 'morning' ? 'Утренняя' : 'Вечерняя'}</td>
                                        <td>{h.balance}</td>
                                        <td>{h.employee_name}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {/* Пагинация */}
                    <div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:8,marginTop:18}}>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page-1)} disabled={page<=1}>Назад</button>
                        <span style={{fontWeight:600}}>{page} / {totalPages}</span>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page+1)} disabled={page>=totalPages}>Вперёд</button>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html> 