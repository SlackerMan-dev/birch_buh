<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏ –∞—Ä–±–∏—Ç—Ä–∞–∂–∞</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .header p {
            color: #7f8c8d;
            text-align: center;
            font-size: 1.1em;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
        }

        .nav-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #7f8c8d;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .stat-card h3 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 8px 6px;
            height: 40px;
            font-size: 0.98em;
            vertical-align: middle;
        }

        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .table tr:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .positive {
            color: #27ae60;
            font-weight: 600;
        }

        .negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
        }

        .employee-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .employee-card h4 {
            margin-bottom: 10px;
        }

        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .filters {
                flex-direction: column;
            }
            .filter-item {
                min-width: auto;
            }
            .nav-tabs {
                flex-direction: column;
                gap: 8px;
                padding: 8px 0;
            }
            .nav-tab {
                font-size: 1.1em;
                padding: 14px 0;
                border-radius: 8px;
            }
            .header {
                padding: 18px 8px;
            }
            .container {
                padding: 8px;
            }
            .btn, .btn-secondary {
                font-size: 1.1em;
                padding: 16px 0;
                width: 100%;
                margin-bottom: 8px;
            }
            .form-control {
                font-size: 1.1em;
                padding: 16px 12px;
            }
            .table {
                display: block;
                width: 100%;
                overflow-x: auto;
                font-size: 0.98em;
            }
            .table thead, .table tbody, .table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            .table th, .table td {
                padding: 10px 6px;
            }
        }
        @media (max-width: 500px) {
            .table, .table thead, .table tbody, .table tr, .table th, .table td {
                display: block;
                width: 100%;
            }
            .table thead { display: none; }
            .table tr {
                margin-bottom: 18px;
                background: #fff;
                border-radius: 12px;
                box-shadow: 0 2px 8px #e1e8ed;
                padding: 10px 8px;
            }
            .table td {
                padding: 8px 4px;
                border: none;
                position: relative;
            }
            .table td:before {
                content: attr(data-label);
                font-weight: bold;
                color: #764ba2;
                display: block;
                margin-bottom: 2px;
                font-size: 0.98em;
            }
        }

        /* --- –ù–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞ ---
           1. –°–µ–∫—Ü–∏–∏: –∫–∞—Ä—Ç–æ—á–∫–∏ —Å —Ç–µ–Ω—å—é –∏ —Ü–≤–µ—Ç–Ω—ã–º–∏ –ø–æ–ª–æ—Å–∫–∞–º–∏
           2. –ë–∞–ª–∞–Ω—Å—ã –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º: —Ç–∞–±–ª–∏—Ü–∞ —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª, —Ü–≤–µ—Ç –¥–µ–ª—å—Ç—ã
           3. –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∏—Ç–æ–≥–∏: –∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö —Å –∏–∫–æ–Ω–∫–∞–º–∏
           4. –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ (—Ñ–∞–π–ª—ã, –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) ‚Äî —Å–≤–µ—Ä–Ω—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
           5. –í—Å—ë –∞–¥–∞–ø—Ç–∏–≤–Ω–æ, –Ω–µ –º–µ–Ω—è—é –Ω–∞–∑–≤–∞–Ω–∏—è –±–ª–æ–∫–æ–≤ –∏ –ø–æ–ª–µ–π */
        .table th:last-child,
        .table th:nth-last-child(2),
        .table td:last-child,
        .table td:nth-last-child(2) {
            text-align: center !important;
            width: 120px;
            min-width: 100px;
            max-width: 140px;
            padding-left: 0 !important;
            padding-right: 0 !important;
            vertical-align: middle;
        }
        .btn-xs {
          padding: 3px 7px;
          font-size: 1em;
          margin: 0 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–°–ß–Å–¢–û–í ---
        const PLATFORMS = ['bybit','htx','bliss','gate'];

        function compareShifts(dateA, shiftA, dateB, shiftB) {
            const dA = new Date(dateA);
            const dB = new Date(dateB);
            if (dA < dB) return -1;
            if (dA > dB) return 1;
            if (shiftA === shiftB) return 0;
            if (shiftA === 'morning' && shiftB === 'evening') return -1;
            if (shiftA === 'evening' && shiftB === 'morning') return 1;
            return 0;
        }

        function findPrevBalanceJS(account_id, platform, reports, report, settingsInitialBalances, accounts) {
            if (reports && Array.isArray(reports)) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        return true;
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let prevBalances = {};
                    try { prevBalances = JSON.parse(prev[0].balances_json || '{}'); } catch { prevBalances = {}; }
                    const found = prevBalances[platform]?.find(a => (a.account_id || a.id) == account_id);
                    if (found && found.balance !== '' && !isNaN(found.balance)) return parseFloat(found.balance);
                }
            }
            if (settingsInitialBalances) {
                const acc = settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts?.find(a => a.id == account_id)?.account_name)));
                if (acc && acc.balance !== undefined) return parseFloat(acc.balance);
            }
            return 0;
        }

        function getTotalBalance(balances, internal) {
            let total = 0;
            PLATFORMS.forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        if (acc.balance !== '' && !isNaN(acc.balance)) total += parseFloat(acc.balance);
                    });
                }
            });
            return total + (parseFloat(internal) || 0);
        }

        function getPrevTotal(report, reports, settingsInitialBalances, accounts) {
            let prevTotal = null;
            let usedInitial = false;
            if (reports && Array.isArray(reports)) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        return true;
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let prevBalances = {};
                    try { prevBalances = JSON.parse(prev[0].balances_json || '{}'); } catch { prevBalances = {}; }
                    let prevSum = 0;
                    PLATFORMS.forEach(platform => {
                        if (prevBalances[platform]) {
                            prevBalances[platform].forEach(acc => {
                                if (acc.balance !== '' && !isNaN(acc.balance)) prevSum += parseFloat(acc.balance);
                            });
                        }
                    });
                    const prevInternal = parseFloat(prev[0].internal_transfer_amount) || 0;
                    prevTotal = prevSum + prevInternal;
                }
            }
            if (prevTotal === null && settingsInitialBalances) {
                prevTotal = 0;
                settingsInitialBalances.forEach(b => {
                    if (b.balance !== '' && !isNaN(b.balance)) prevTotal += parseFloat(b.balance);
                });
                usedInitial = true;
            }
            return { prevTotal, usedInitial };
        }

        // --- –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ---
        window.accountBalanceHistory = window.accountBalanceHistory || [];

        // --- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–æ–≤ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ—Ç—á—ë—Ç–∞ ---
        async function saveAccountBalancesToHistory(report, employees, accounts) {
            console.log('saveAccountBalancesToHistory called', {report, employees, accounts});
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            const employee = employees.find(emp => emp.id === report.employee_id);
            for (const platform of ['bybit','htx','bliss','gate']) {
                if (!balances[platform]) continue;
                    for (const acc of balances[platform]) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
                    const bodyStart = {
                            account_id: acc.account_id || acc.id,
                            account_name: acc.account_name,
                            platform,
                            shift_date: report.shift_date,
                            shift_type: report.shift_type,
                        balance: acc.start_balance !== '' && !isNaN(acc.start_balance) ? parseFloat(acc.start_balance) : 0,
                            employee_id: employee ? employee.id : null,
                        employee_name: employee ? employee.name : '‚Äî',
                        balance_type: 'start'
                        };
                        try {
                        await fetch('/api/account-balance-history', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(bodyStart)
                        });
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é:', e);
                    }
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω–µ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å
                    const bodyEnd = {
                        account_id: acc.account_id || acc.id,
                        account_name: acc.account_name,
                        platform,
                        shift_date: report.shift_date,
                        shift_type: report.shift_type,
                        balance: acc.end_balance !== '' && !isNaN(acc.end_balance) ? parseFloat(acc.end_balance) : 0,
                        employee_id: employee ? employee.id : null,
                        employee_name: employee ? employee.name : '‚Äî',
                        balance_type: 'end'
                    };
                    try {
                        await fetch('/api/account-balance-history', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(bodyEnd)
                        });
                        } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω–µ—á–Ω–æ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é:', e);
                    }
                }
            }
        }

        // --- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–µ–ª—å—Ç—ã ---
        function findPrevAccountBalanceInHistory(account_id, platform, shift_date, shift_type, accounts = []) {
            // –ù–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–∏—Å—å –ø–æ —ç—Ç–æ–º—É –∞–∫–∫–∞—É–Ω—Ç—É –¥–æ —Ç–µ–∫—É—â–µ–π —Å–º–µ–Ω—ã
            const prev = window.accountBalanceHistory
                .filter(h => h.account_id == account_id && h.platform === platform && compareShifts(h.shift_date, h.shift_type, shift_date, shift_type) < 0)
                .sort((a, b) => compareShifts(b.shift_date, b.shift_type, a.shift_date, a.shift_type));
            if (prev.length > 0) return prev[0].balance;
            // –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏—â–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            if (window.settingsInitialBalances) {
                const found = window.settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts.find(a => a.id == account_id)?.account_name)));
                if (found && found.balance !== undefined && found.balance !== '' && !isNaN(found.balance)) return parseFloat(found.balance);
            }
            return 0;
        }

        // --- –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å calculateProfit –∏ calculateSalaryProfit ---
        function calculateProfit(report, reports, settingsInitialBalances, accounts, employees) {
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            let endSum = 0;
            let startSum = 0;
            ['bybit','htx','bliss','gate'].forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        if (acc.end_balance !== '' && !isNaN(acc.end_balance)) endSum += parseFloat(acc.end_balance);
                        if (acc.start_balance !== '' && !isNaN(acc.start_balance)) startSum += parseFloat(acc.start_balance);
                    });
                }
            });
            const dokidka = parseFloat(report.dokidka_amount) || 0;
            const internal = parseFloat(report.internal_transfer_amount) || 0;
            const profit = (endSum - startSum) - dokidka - internal;
            return { endSum, startSum, dokidka, internal, profit };
        }
        function calculateSalaryProfit(report, reports, settingsInitialBalances, accounts, employees) {
            let balances = {};
            try { balances = typeof report.balances_json === 'string' ? JSON.parse(report.balances_json) : report.balances_json || {}; } catch { balances = {}; }
            let endSum = 0;
            let startSum = 0;
            ['bybit','htx','bliss','gate'].forEach(platform => {
                if (balances[platform]) {
                    balances[platform].forEach(acc => {
                        if (acc.end_balance !== '' && !isNaN(acc.end_balance)) endSum += parseFloat(acc.end_balance);
                        if (acc.start_balance !== '' && !isNaN(acc.start_balance)) startSum += parseFloat(acc.start_balance);
                    });
                }
            });
            const dokidka = parseFloat(report.dokidka_amount) || 0;
            const internal = parseFloat(report.internal_transfer_amount) || 0;
            const scam = (report.scam_personal ? (parseFloat(report.scam_amount) || 0) : 0);
            const profit = endSum - startSum - dokidka - internal - scam;
            return { endSum, startSum, dokidka, internal, scam, profit };
        }

        // --- –°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –±–∞–ª–∞–Ω—Å–æ–≤ –≤ localStorage ---
        function saveAccountBalanceHistoryToStorage() {
            try {
                localStorage.setItem('accountBalanceHistory', JSON.stringify(window.accountBalanceHistory));
            } catch {}
        }
        function loadAccountBalanceHistoryFromStorage() {
            try {
                const data = localStorage.getItem('accountBalanceHistory');
                if (data) window.accountBalanceHistory = JSON.parse(data);
            } catch {}
        }
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        loadAccountBalanceHistoryFromStorage();

        function App() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [dashboardData, setDashboardData] = useState(null);
            const [employees, setEmployees] = useState([]);
            const [reports, setReports] = useState([]);
            const [loading, setLoading] = useState(true);
            const [settingsVisible, setSettingsVisible] = useState(false);
            const [settingsPassword, setSettingsPassword] = useState('');
            const [settingsAuthed, setSettingsAuthed] = useState(false);
            const [settingsInitialBalances, setSettingsInitialBalances] = useState([]);
            const [settingsAccounts, setSettingsAccounts] = useState([]);
            const [settingsLoading, setSettingsLoading] = useState(false);
            const [stats, setStats] = useState([]);
            const [statsStart, setStatsStart] = useState(() => {
                const d = new Date();
                return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-01';
            });
            const [statsEnd, setStatsEnd] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [statsLoading, setStatsLoading] = useState(false);
            const [globalAuthed, setGlobalAuthed] = useState(false);
            const [globalPassword, setGlobalPassword] = useState('');
            const [globalError, setGlobalError] = useState('');
            const [showDetails, setShowDetails] = useState({id: null, type: null});
            const [expandedReportId, setExpandedReportId] = useState(null);

            // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–ª–æ—â–∞–¥–æ–∫
            const platforms = [
                { id: 1, name: 'Bybit', type: 'exchange' },
                { id: 2, name: 'HTX', type: 'exchange' },
                { id: 3, name: 'Bliss', type: 'arbitrage' },
                { id: 4, name: 'Gate', type: 'arbitrage' }
            ];

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            useEffect(() => {
                const isAuthenticated = sessionStorage.getItem('authenticated');
                if (isAuthenticated === 'true') {
                    setGlobalAuthed(true);
                }
            }, []);

            useEffect(() => {
                if (globalAuthed) {
                loadData();
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                fetch('/api/settings/balances').then(r => r.json()).then(balances => {
                    window.settingsInitialBalances = balances;
                });
                }
            }, [activeTab, globalAuthed]);

            useEffect(() => {
                if (activeTab === 'settings' && settingsAuthed && globalAuthed) {
                    setSettingsLoading(true);
                    fetch('/api/accounts').then(r => r.json()).then(setSettingsAccounts);
                    fetch('/api/settings/balances').then(r => r.json()).then(balances => {
                        setSettingsInitialBalances(balances);
                        window.settingsInitialBalances = balances;
                        setSettingsLoading(false);
                    });
                }
            }, [activeTab, settingsAuthed, globalAuthed]);

            useEffect(() => {
                if (activeTab === 'statistics' && globalAuthed) {
                    setStatsLoading(true);
                    fetch(`/api/statistics?start_date=${statsStart}&end_date=${statsEnd}`)
                        .then(r => r.json())
                        .then(data => { setStats(data); setStatsLoading(false); });
                }
            }, [activeTab, statsStart, statsEnd, globalAuthed]);

            const loadData = async () => {
                try {
                    const [dashboardRes, employeesRes, reportsRes] = await Promise.all([
                        fetch('/api/dashboard'),
                        fetch('/api/employees'),
                        fetch('/api/reports')
                    ]);

                    const dashboard = await dashboardRes.json();
                    const employeesData = await employeesRes.json();
                    const reportsData = await reportsRes.json();

                    setDashboardData(dashboard);
                    setEmployees(employeesData);
                    setReports(reportsData);
                    setLoading(false);
                } catch (error) {
                    console.error('Error loading data:', error);
                    setLoading(false);
                }
            };

            const handleLogin = () => {
                if (globalPassword === '7605203') {
                    setGlobalAuthed(true);
                    setGlobalError('');
                    sessionStorage.setItem('authenticated', 'true');
                } else {
                    setGlobalError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                }
            };

            const handleLogout = () => {
                setGlobalAuthed(false);
                setGlobalPassword('');
                setGlobalError('');
                sessionStorage.removeItem('authenticated');
                setDashboardData(null);
                setEmployees([]);
                setReports([]);
                setLoading(true);
            };

            // –ï—Å–ª–∏ –Ω–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤—Ö–æ–¥–∞
            if (!globalAuthed) {
                return (
                    <div className="container">
                        <div className="header">
                            <h1><i className="fas fa-coins"></i> Birch Team</h1>
                            <p>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ P2P –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã</p>
                        </div>
                        <div className="card" style={{maxWidth: 400, margin: '40px auto', textAlign: 'center'}}>
                            <h3><i className="fas fa-lock"></i> –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
                            <div className="form-group">
                                <input 
                                    type="password" 
                                    className="form-control" 
                                    placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
                                    value={globalPassword} 
                                    onChange={e => setGlobalPassword(e.target.value)}
                                    onKeyPress={e => e.key === 'Enter' && handleLogin()}
                                    style={{margin: '20px 0'}} 
                                />
                            </div>
                            <button className="btn" onClick={handleLogin}>
                                <i className="fas fa-sign-in-alt"></i> –í–æ–π—Ç–∏
                            </button>
                            {globalError && <div style={{color: '#e74c3c', marginTop: 10}}>{globalError}</div>}
                        </div>
                    </div>
                );
            }

            if (loading) {
                return (
                    <div className="container">
                        <div className="loading">
                            <i className="fas fa-spinner fa-spin fa-2x"></i>
                            <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container">
                    <div className="header">
                        <h1><i className="fas fa-coins"></i> Birch Team</h1>
                        <p>–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ P2P –∞—Ä–±–∏—Ç—Ä–∞–∂–Ω–æ–π –∫–æ–º–∞–Ω–¥—ã</p>
                        <button className="logout-btn" onClick={handleLogout}>
                            <i className="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏
                        </button>
                    </div>

                    <div className="nav-tabs">
                        <div className={`nav-tab ${activeTab === 'dashboard' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('dashboard')}>
                            <i className="fas fa-tachometer-alt"></i> –î–∞—à–±–æ—Ä–¥
                        </div>
                        <div className={`nav-tab ${activeTab === 'employees' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('employees')}>
                            <i className="fas fa-users"></i> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
                        </div>
                        <div className={`nav-tab ${activeTab === 'platforms' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('platforms')}>
                            <i className="fas fa-exchange-alt"></i> –ü–ª–æ—â–∞–¥–∫–∏
                        </div>
                        <div className={`nav-tab ${activeTab === 'reports' ? 'active' : ''}`} 
                             onClick={() => setActiveTab('reports')}>
                            <i className="fas fa-file-alt"></i> –û—Ç—á–µ—Ç—ã
                        </div>
                        <div className={`nav-tab ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>
                            <i className="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                        </div>
                        <div className={`nav-tab ${activeTab === 'statistics' ? 'active' : ''}`} onClick={() => setActiveTab('statistics')}>
                            <i className="fas fa-chart-pie"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                        </div>
                        <div className={`nav-tab ${activeTab === 'accountBalanceHistory' ? 'active' : ''}`} onClick={() => setActiveTab('accountBalanceHistory')}>
                            <i className="fas fa-database"></i> –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–æ–≤
                        </div>
                    </div>

                    {activeTab === 'dashboard' && <Dashboard data={dashboardData} />}
                    {activeTab === 'employees' && <Employees employees={employees} onUpdate={loadData} />}
                    {activeTab === 'platforms' && <Platforms platforms={platforms} employees={employees} onUpdate={loadData} />}
                    {activeTab === 'reports' && <Reports reports={reports} employees={employees} platforms={platforms} onUpdate={loadData} />}
                    {activeTab === 'settings' && (
                        <Settings
                            authed={settingsAuthed}
                            setAuthed={setSettingsAuthed}
                            password={settingsPassword}
                            setPassword={setSettingsPassword}
                            initialBalances={settingsInitialBalances}
                            setInitialBalances={setSettingsInitialBalances}
                            accounts={settingsAccounts}
                            loading={settingsLoading}
                        />
                    )}
                    {activeTab === 'statistics' && (
                        <Statistics
                            stats={stats}
                            start={statsStart}
                            end={statsEnd}
                            setStart={setStatsStart}
                            setEnd={setStatsEnd}
                            loading={statsLoading}
                        />
                    )}
                    {activeTab === 'accountBalanceHistory' && <AccountBalanceHistoryViewer accounts={settingsAccounts || []} employees={employees} />}
                </div>
            );
        }

        function Dashboard({ data: initialData }) {
            const [chart, setChart] = useState(null);
            const [dayChart, setDayChart] = useState(null);
            const dayChartRef = React.useRef(null); // –ù–æ–≤—ã–π ref –¥–ª—è canvas
            const now = new Date();
            const [selectedYear, setSelectedYear] = useState(now.getFullYear());
            const [selectedMonth, setSelectedMonth] = useState(now.getMonth() + 1); // 1-12
            const [startDate, setStartDate] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [endDate, setEndDate] = useState(() => {
                const d = new Date();
                return d.toISOString().slice(0,10);
            });
            const [data, setData] = useState(initialData);
            useEffect(() => { setData(initialData); }, [initialData]);

            // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Å—è—Ü–µ–≤ –∏ –ª–µ—Ç –∏–∑ –¥–∞–Ω–Ω—ã—Ö (–∏–ª–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞)
            const minYear = now.getFullYear() - 2;
            const years = [];
            for (let y = now.getFullYear(); y >= minYear; y--) years.push(y);
            const months = [
                { value: 1, label: '–Ø–Ω–≤–∞—Ä—å' }, { value: 2, label: '–§–µ–≤—Ä–∞–ª—å' }, { value: 3, label: '–ú–∞—Ä—Ç' },
                { value: 4, label: '–ê–ø—Ä–µ–ª—å' }, { value: 5, label: '–ú–∞–π' }, { value: 6, label: '–ò—é–Ω—å' },
                { value: 7, label: '–ò—é–ª—å' }, { value: 8, label: '–ê–≤–≥—É—Å—Ç' }, { value: 9, label: '–°–µ–Ω—Ç—è–±—Ä—å' },
                { value: 10, label: '–û–∫—Ç—è–±—Ä—å' }, { value: 11, label: '–ù–æ—è–±—Ä—å' }, { value: 12, label: '–î–µ–∫–∞–±—Ä—å' }
            ];

            // --- –ù–æ–≤—ã–π useEffect –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –¥–∞—Ç–∞–º ---
            useEffect(() => {
                fetch(`/api/dashboard?start_date=${startDate}&end_date=${endDate}`)
                    .then(r => r.json())
                    .then(setData);
            }, [startDate, endDate]);

            const [showChart, setShowChart] = useState(false);
            const [chartReady, setChartReady] = useState(false);
            useEffect(() => {
                setChartReady(false);
                if (data && data.reports && data.reports.length > 0) {
                    const timer = setTimeout(() => setChartReady(true), 400);
                    return () => clearTimeout(timer);
                }
            }, [data, selectedYear, selectedMonth]);

            useEffect(() => {
                if (data && data.reports && dayChartRef.current) {
                        if (dayChart) dayChart.destroy();
                        const year = selectedYear;
                    const month = selectedMonth - 1;
                        const daysInMonth = new Date(year, month + 1, 0).getDate();
                        const labels = Array.from({length: daysInMonth}, (_,i) => new Date(year, month, i+1).toISOString().slice(0,10));
                        let profitByDay = {};
                            data.reports.forEach(r => {
                                const d = (r.shift_date || '').slice(0,10);
                                if (d.startsWith(`${year}-${String(selectedMonth).padStart(2,'0')}`)) {
                                    if (!profitByDay[d]) profitByDay[d] = 0;
                            let balances = {};
                            try { balances = typeof r.balances_json === 'string' ? JSON.parse(r.balances_json) : r.balances_json || {}; } catch { balances = {}; }
                            let endSum = 0, startSum = 0;
                            ['bybit','htx','bliss','gate'].forEach(platform => {
                                if (balances[platform]) {
                                    balances[platform].forEach(acc => {
                                        if (acc.end_balance !== '' && !isNaN(acc.end_balance)) endSum += parseFloat(acc.end_balance);
                                        if (acc.start_balance !== '' && !isNaN(acc.start_balance)) startSum += parseFloat(acc.start_balance);
                                    });
                                }
                            });
                            const dokidka = parseFloat(r.dokidka_amount) || 0;
                            const internal = parseFloat(r.internal_transfer_amount) || 0;
                            const profit = (endSum - startSum) - dokidka - internal;
                            profitByDay[d] += profit;
                        }
                    });
                        const dataArr = labels.map(d => profitByDay[d] || 0);
                        const minVal = Math.min(...dataArr, 0);
                        const maxVal = Math.max(...dataArr, 0);
                        const yMax = maxVal === minVal ? maxVal + 10 : undefined;
                    const newDayChart = new Chart(dayChartRef.current, {
                            type: 'line',
                            data: {
                                labels: labels.map(d => d.slice(8,10)+'.'+d.slice(5,7)),
                                datasets: [{
                                label: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –ø–æ –¥–Ω—è–º (–ø–æ –≤—Å–µ–º —Å–º–µ–Ω–∞–º)',
                                    data: dataArr,
                                    fill: true,
                                    backgroundColor: 'rgba(102, 126, 234, 0.15)',
                                    borderColor: 'rgba(102, 126, 234, 1)',
                                    tension: 0.2,
                                    pointRadius: 4,
                                    pointBackgroundColor: dataArr.map(v => v >= 0 ? '#27ae60' : '#e74c3c')
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        min: minVal,
                                        max: yMax,
                                        grace: '10%',
                                        ticks: {
                                            callback: function(value) { return value + ' USDT'; }
                                        }
                                    }
                                }
                            }
                        });
                        setDayChart(newDayChart);
                    return () => { newDayChart.destroy(); };
                }
            }, [data, selectedYear, selectedMonth]);

            // --- –ù–æ–≤—ã–π state –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –≥—Ä–∞—Ñ–∏–∫–∞ –∑–∞ –º–µ—Å—è—Ü ---
            const [monthReports, setMonthReports] = useState([]);
            const [loadingMonth, setLoadingMonth] = useState(false);
            useEffect(() => {
                setLoadingMonth(true);
                const year = selectedYear;
                const month = selectedMonth;
                const start = `${year}-${String(month).padStart(2, '0')}-01`;
                const end = new Date(year, month, 0).toISOString().slice(0, 10); // –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
                fetch(`/api/reports?start_date=${start}&end_date=${end}`)
                    .then(r => r.json())
                    .then(data => { setMonthReports(data); setLoadingMonth(false); });
            }, [selectedYear, selectedMonth]);

            if (!data) return <div className="loading">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>;

            return (
                <div>
                    <div className="stats-grid">
                        <div className="stat-card">
                            <h3>${(data.month_total_profit ?? 0).toFixed(2)}</h3>
                            <p>–û–±—â–∞—è –ø—Ä–∏–±—ã–ª—å (–∑–∞ –º–µ—Å—è—Ü)</p>
                        </div>
                        <div className="stat-card">
                            <h3>{data.month_total_requests ?? 0}</h3>
                            <p>–í—Å–µ–≥–æ –æ—Ä–¥–µ—Ä–æ–≤ (–∑–∞ –º–µ—Å—è—Ü)</p>
                        </div>
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-chart-line"></i> –î–∏–Ω–∞–º–∏–∫–∞ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ –ø–æ –¥–Ω—è–º –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–µ—Å—è—Ü</h3>
                        <div style={{display:'flex',gap:12,alignItems:'center',marginBottom:18}}>
                            <label>–ú–µ—Å—è—Ü:</label>
                            <select className="form-control" style={{maxWidth:140}} value={selectedMonth} onChange={e => setSelectedMonth(Number(e.target.value))}>
                                {months.map(m => <option key={m.value} value={m.value}>{m.label}</option>)}
                            </select>
                            <label>–ì–æ–¥:</label>
                            <select className="form-control" style={{maxWidth:100}} value={selectedYear} onChange={e => setSelectedYear(Number(e.target.value))}>
                                {years.map(y => <option key={y} value={y}>{y}</option>)}
                            </select>
                        </div>
                        {loadingMonth
                            ? <div style={{height: 300, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#888'}}>–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞...</div>
                            : (monthReports && monthReports.length > 0
                                ? <DayProfitChart reports={monthReports} year={selectedYear} month={selectedMonth} />
                                : <div style={{height: 300, display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#888'}}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</div>
                            )
                        }
                    </div>

                    <div className="card">
                        <h3><i className="fas fa-trophy" style={{color:'#f7b731'}}></i> –¢–æ–ø-3 —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –ø–æ –ø—Ä–∏–±—ã–ª–∏</h3>
                        <div style={{display:'flex',gap:24,justifyContent:'flex-start',marginTop:18,flexWrap:'wrap'}}>
                            {(data.employee_stats || []).slice().sort((a,b)=>Number(b.net_profit||0)-Number(a.net_profit||0)).slice(0,3).map((emp, idx) => (
                                <div key={emp.id || emp.name} style={{background:'#fffbe6',borderRadius:16,padding:'22px 28px',minWidth:220,boxShadow:'0 2px 12px #f7b73122',display:'flex',flexDirection:'column',alignItems:'center',position:'relative'}}>
                                    <div style={{position:'absolute',top:10,right:18,fontSize:22,color:'#f7b731',fontWeight:700}} title={`–ú–µ—Å—Ç–æ #${idx+1}`}>{['ü•á','ü•à','ü•â'][idx]}</div>
                                    <div style={{fontWeight:700,fontSize:'1.2em',marginBottom:6}}>{emp.name}</div>
                                    <div style={{color:'#888',marginBottom:8}}>–°–º–µ–Ω: {emp.total_shifts ?? '-'}</div>
                                    <div style={{fontSize:'1.5em',fontWeight:700,color:'#27ae60',marginBottom:4}} title="–°—É–º–º–∞—Ä–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ —Å–º–µ–Ω—ã">
                                      {(Number(emp.net_profit) >= 0 ? '+' : '') + (Number(emp.net_profit) || 0).toFixed(2)} USDT
                                    </div>
                                    <div style={{color:'#3c78d8',fontSize:'1em',marginBottom:2}}>
                                      –°—Ä–µ–¥–Ω—è—è –∑–∞ —Å–º–µ–Ω—É: {(emp.total_shifts ? ((Number(emp.net_profit)||0)/emp.total_shifts).toFixed(2) : '‚Äî')} USDT
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        function Employees({ employees, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                name: '',
                telegram: ''
            });

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    const response = await fetch('/api/employees', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    if (response.ok) {
                        setFormData({ name: '', telegram: '' });
                        setShowForm(false);
                        onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating employee:', error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/employees/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-users"></i> –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
                            </button>
                        </div>

                        {showForm && (
                            <form onSubmit={handleSubmit} style={{ marginBottom: '20px', padding: '20px', background: '#f8f9fa', borderRadius: '10px' }}>
                                <div className="form-group">
                                    <label>–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.name}
                                        onChange={(e) => setFormData({...formData, name: e.target.value})}
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>–ù–∏–∫ Telegram</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.telegram}
                                        onChange={(e) => setFormData({...formData, telegram: e.target.value})}
                                        required
                                    />
                                </div>
                                <button type="submit" className="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" className="btn btn-secondary" onClick={() => setShowForm(false)}>–û—Ç–º–µ–Ω–∞</button>
                            </form>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>–ò–º—è</th>
                                    <th>–ù–∏–∫ Telegram</th>
                                    <th>–î–∞—Ç–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {employees.map(emp => (
                                    <tr key={emp.id}>
                                        <td>{emp.name}</td>
                                        <td>{emp.telegram}</td>
                                        <td>{new Date(emp.created_at).toLocaleDateString('ru-RU')}</td>
                                        <td>
                                            <button className="btn btn-secondary" onClick={() => handleDelete(emp.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>–£–¥–∞–ª–∏—Ç—å</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function Platforms({ platforms, employees, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [accounts, setAccounts] = useState([]);
            const [formData, setFormData] = useState({
                platform: '',
                account_name: ''
            });
            const platformOptions = [
                { value: 'bybit', label: 'Bybit' },
                { value: 'htx', label: 'HTX' },
                { value: 'bliss', label: 'Bliss' },
                { value: 'gate', label: 'Gate' }
            ];

            useEffect(() => {
                fetch('/api/accounts').then(r => r.json()).then(setAccounts);
            }, [showForm]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫–∫–∞—É–Ω—Ç
                    const response = await fetch('/api/accounts', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            platform: formData.platform,
                            account_name: formData.account_name
                        })
                    });
                    if (response.ok) {
                        setFormData({ platform: '', account_name: '' });
                        setShowForm(false);
                        fetch('/api/accounts').then(r => r.json()).then(setAccounts);
                        if (onUpdate) onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating account:', error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/accounts/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        fetch('/api/accounts').then(r => r.json()).then(setAccounts);
                        if (onUpdate) onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-exchange-alt"></i> –ê–∫–∫–∞—É–Ω—Ç—ã –ø–ª–æ—â–∞–¥–æ–∫</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                            </button>
                        </div>

                        {showForm && (
                            <form onSubmit={handleSubmit} style={{ marginBottom: '20px', padding: '20px', background: '#f8f9fa', borderRadius: '10px' }}>
                                <div className="form-group">
                                    <label>–ü–ª–æ—â–∞–¥–∫–∞</label>
                                    <select className="form-control" value={formData.platform} onChange={e => setFormData({ ...formData, platform: e.target.value })} required>
                                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–æ—â–∞–¥–∫—É</option>
                                        {platformOptions.map(opt => (
                                            <option key={opt.value} value={opt.value}>{opt.label}</option>
                                        ))}
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</label>
                                    <input
                                        type="text"
                                        className="form-control"
                                        value={formData.account_name}
                                        onChange={e => setFormData({ ...formData, account_name: e.target.value })}
                                        required
                                    />
                                </div>
                                <button type="submit" className="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                <button type="button" className="btn btn-secondary" onClick={() => setShowForm(false)}>–û—Ç–º–µ–Ω–∞</button>
                            </form>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>–ü–ª–æ—â–∞–¥–∫–∞</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {accounts.map(acc => (
                                    <tr key={acc.id}>
                                        <td>{platformOptions.find(opt => opt.value === acc.platform)?.label || acc.platform}</td>
                                        <td>{acc.account_name}</td>
                                        <td>
                                            <button className="btn btn-secondary" onClick={() => handleDelete(acc.id)} style={{padding:'4px 10px',fontSize:'0.9em'}}>–£–¥–∞–ª–∏—Ç—å</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        function Reports({ reports: initialReports, employees, platforms, onUpdate }) {
            const [showForm, setShowForm] = useState(false);
            const [filters, setFilters] = useState({
                start_date: '',
                end_date: '',
                employee_id: ''
            });
            const [accounts, setAccounts] = useState([]);
            const [expandedReportId, setExpandedReportId] = useState(null);
            const [formData, setFormData] = useState({
                employee_id: '',
                shift_date: '',
                shift_type: 'morning',
                bybit_requests: 0,
                htx_requests: 0,
                bliss_requests: 0,
                balances: { bybit: [], htx: [], bliss: [], gate: [] },
                scam_amount: 0,
                scam_comment: '',
                scam_personal: false,
                dokidka_amount: 0,
                dokidka_comment: '',
                internal_transfer_amount: 0,
                internal_transfer_comment: '',
                bybit_file: null,
                htx_file: null,
                bliss_file: null,
                start_photo: null,
                end_photo: null,
                appeal_amount: 0,
                appeal_comment: ''
            });
            const [reports, setReports] = useState(initialReports || []);
            const [zoomedImage, setZoomedImage] = useState(null);
            const [showDetails, setShowDetails] = useState({id: null, type: null});

            useEffect(() => {
                fetch('/api/accounts').then(r => r.json()).then(setAccounts);
            }, []);

            const handleAccountChange = (platform, selectedIds) => {
                setFormData(fd => {
                    // –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –¥–ª—è —ç—Ç–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
                    const selectedAccounts = accounts
                        .filter(a => selectedIds.includes(a.id.toString()) && a.platform === platform)
                        .map(acc => {
                            // –ï—Å–ª–∏ —É–∂–µ –±—ã–ª–∏ –≤–≤–µ–¥–µ–Ω—ã –±–∞–ª–∞–Ω—Å—ã ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
                            const existing = fd.balances[platform].find(a => a.id === acc.id);
                            return existing ? existing : { ...acc, start_balance: '', end_balance: '' };
                        });
                    return {
                        ...fd,
                        balances: {
                            ...fd.balances,
                            [platform]: selectedAccounts
                        }
                    };
                });
            };

            const handleBalanceChange = (platform, idx, field, value) => {
                setFormData(fd => {
                    const updated = [...fd.balances[platform]];
                    updated[idx][field] = value;
                    return {
                        ...fd,
                        balances: {
                            ...fd.balances,
                            [platform]: updated
                        }
                    };
                });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const form = new FormData();
                form.append('employee_id', formData.employee_id);
                form.append('shift_date', formData.shift_date);
                form.append('shift_type', formData.shift_type);
                form.append('total_requests', formData.total_requests);
                form.append('bybit_requests', formData.bybit_requests || 0);
                form.append('htx_requests', formData.htx_requests || 0);
                form.append('bliss_requests', formData.bliss_requests || 0);
                form.append('balances_json', JSON.stringify(formData.balances));
                form.append('scam_amount', formData.scam_amount);
                form.append('scam_comment', formData.scam_comment);
                form.append('dokidka_amount', formData.dokidka_amount);
                form.append('dokidka_comment', formData.dokidka_comment);
                form.append('internal_transfer_amount', formData.internal_transfer_amount);
                form.append('internal_transfer_comment', formData.internal_transfer_comment);
                if (formData.bybit_file) form.append('bybit_file', formData.bybit_file);
                if (formData.htx_file) form.append('htx_file', formData.htx_file);
                if (formData.bliss_file) form.append('bliss_file', formData.bliss_file);
                if (formData.start_photo) form.append('start_photo', formData.start_photo);
                if (formData.end_photo) form.append('end_photo', formData.end_photo);
                ['bybit','htx','bliss','gate'].forEach(platform => {
                    form.append(platform + '_first_trade', formData[platform + '_first_trade'] || '');
                    form.append(platform + '_last_trade', formData[platform + '_last_trade'] || '');
                });
                form.append('scam_personal', formData.scam_personal ? 'true' : '');
                form.append('appeal_amount', formData.appeal_amount || '');
                form.append('appeal_comment', formData.appeal_comment || '');
                try {
                    const response = await fetch('/api/reports', {
                        method: 'POST',
                        body: form
                    });
                    if (response.ok) {
                        let savedReportMeta = null;
                        try {
                            savedReportMeta = await response.json();
                        } catch { savedReportMeta = null; }
                        let savedReport = null;
                        if (savedReportMeta && savedReportMeta.id) {
                            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—ã–π –æ–±—ä–µ–∫—Ç –æ—Ç—á—ë—Ç–∞ –ø–æ id
                            const allReports = await fetch('/api/reports').then(r => r.json());
                            savedReport = allReports.find(r => r.id === savedReportMeta.id);
                        }
                        if (!savedReport) {
                            // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ ‚Äî fallback –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç—á—ë—Ç
                            const allReports = await fetch('/api/reports').then(r => r.json());
                            savedReport = allReports && allReports.length > 0 ? allReports[allReports.length - 1] : formData;
                        }
                        console.log('Calling saveAccountBalancesToHistory with', savedReport, employees, accounts);
                        await saveAccountBalancesToHistory(savedReport, employees, accounts);
                        setFormData({
                            employee_id: '',
                            shift_date: '',
                            shift_type: 'morning',
                            total_requests: 0,
                            bybit_requests: 0,
                            htx_requests: 0,
                            bliss_requests: 0,
                            balances: { bybit: [], htx: [], bliss: [], gate: [] },
                            scam_amount: 0,
                            scam_comment: '',
                            scam_personal: false,
                            dokidka_amount: 0,
                            dokidka_comment: '',
                            internal_transfer_amount: 0,
                            internal_transfer_comment: '',
                            bybit_file: null,
                            htx_file: null,
                            bliss_file: null,
                            start_photo: null,
                            end_photo: null,
                            appeal_amount: 0,
                            appeal_comment: ''
                        });
                        setShowForm(false);
                        loadReports();
                        if (onUpdate) onUpdate();
                    }
                } catch (error) {
                    console.error('Error creating report:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ—Ç—á—ë—Ç–∞: ' + error);
                }
            };

            const handleDelete = async (id) => {
                const password = prompt('–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:');
                if (!password) return;
                try {
                    const response = await fetch(`/api/reports/${id}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    if (response.ok) {
                        loadReports();
                        if (onUpdate) onUpdate();
                    } else {
                        const data = await response.json();
                        alert(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            };

            const loadReports = async () => {
                try {
                    const params = new URLSearchParams();
                    Object.entries(filters).forEach(([key, value]) => {
                        if (value) params.append(key, value);
                    });
                    const response = await fetch(`/api/reports?${params}`);
                    const data = await response.json();
                    setReports(data); // –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ!
                } catch (error) {
                    console.error('Error loading reports:', error);
                }
            };

            return (
                <div>
                    <div className="card">
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3><i className="fas fa-file-alt"></i> –û—Ç—á–µ—Ç—ã –ø–æ —Å–º–µ–Ω–∞–º</h3>
                            <button className="btn" onClick={() => setShowForm(!showForm)}>
                                <i className="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç
                            </button>
                        </div>

                        <div style={{display:'flex',gap:8,marginBottom:12,flexWrap:'wrap'}}>
                            <button className="btn btn-secondary" type="button" onClick={() => { // –°–µ–≥–æ–¥–Ω—è
                                const today = new Date();
                                const d = today.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: d, end_date: d}));
                                setTimeout(loadReports, 0);
                            }}>–°–µ–≥–æ–¥–Ω—è</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // –í—á–µ—Ä–∞
                                const y = new Date(); y.setDate(y.getDate()-1);
                                const d = y.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: d, end_date: d}));
                                setTimeout(loadReports, 0);
                            }}>–í—á–µ—Ä–∞</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // –¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è
                                const now = new Date();
                                const day = now.getDay() || 7;
                                const monday = new Date(now); monday.setDate(now.getDate() - day + 1);
                                setFilters(f => ({...f, start_date: monday.toISOString().slice(0,10), end_date: now.toISOString().slice(0,10)}));
                                setTimeout(loadReports, 0);
                            }}>–¢–µ–∫—É—â–∞—è –Ω–µ–¥–µ–ª—è</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // –¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
                                const now = new Date();
                                const start = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-01';
                                const end = now.toISOString().slice(0,10);
                                setFilters(f => ({...f, start_date: start, end_date: end}));
                                setTimeout(loadReports, 0);
                            }}>–¢–µ–∫—É—â–∏–π –º–µ—Å—è—Ü</button>
                            <button className="btn btn-secondary" type="button" onClick={() => { // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
                                const now = new Date();
                                const start = new Date(now); start.setDate(now.getDate()-6);
                                setFilters(f => ({...f, start_date: start.toISOString().slice(0,10), end_date: now.toISOString().slice(0,10)}));
                                setTimeout(loadReports, 0);
                            }}>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</button>
                            <button className="btn btn-secondary" type="button" onClick={async () => { // –í—Å—ë –≤—Ä–µ–º—è
                                // –ü–æ–ª—É—á–∞–µ–º —Å–∞–º—É—é —Ä–∞–Ω–Ω—é—é –¥–∞—Ç—É –∏–∑ –æ—Ç—á–µ—Ç–æ–≤
                                const response = await fetch('/api/reports');
                                const data = await response.json();
                                if (data.length > 0) {
                                    const minDate = data.map(r => r.shift_date).sort()[0];
                                    const maxDate = data.map(r => r.shift_date).sort().reverse()[0];
                                    setFilters(f => ({...f, start_date: minDate, end_date: maxDate}));
                                    setTimeout(loadReports, 0);
                                }
                            }}>–í—Å—ë –≤—Ä–µ–º—è</button>
                            {/* --- –ö–Ω–æ–ø–∫–∞ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV --- */}
                            <button className="btn" type="button" style={{marginLeft:16,background:'#27ae60'}} onClick={() => {
                                // –§–æ—Ä–º–∏—Ä—É–µ–º CSV –∏–∑ –≤–∏–¥–∏–º—ã—Ö –æ—Ç—á–µ—Ç–æ–≤
                                function escapeCSV(val, forceQuotes=false) {
                                    if (val == null) return '';
                                    let s = String(val);
                                    if (forceQuotes || s.search(/[",;\n]/) >= 0) {
                                        s = s.replace(/"/g, '""');
                                        return '"'+s+'"';
                                    }
                                    return s;
                                }
                                const header = [
                                    '–î–∞—Ç–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','–°–º–µ–Ω–∞','–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫','Bybit –∑–∞—è–≤–∫–∏','HTX –∑–∞—è–≤–∫–∏','Bliss –∑–∞—è–≤–∫–∏',
                                    '–ë–∞–ª–∞–Ω—Å—ã (JSON)','–°–ö–ê–ú','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –°–ö–ê–ú','–î–æ–∫–∏–¥–∫–∞ (–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥, USDT)','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–∫–∏–¥–∫–∏','–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ (USDT)','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞',
                                    'BYBIT –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','BYBIT –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞','HTX –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','HTX –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞','BLISS –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','BLISS –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞','GATE –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','GATE –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞',
                                    '–ê–ø–ø–µ–ª—è—Ü–∏–∏ (—Å—É–º–º–∞, USDT)', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∞–ø–ø–µ–ª—è—Ü–∏–∏'
                                ];
                                const rows = reports.map(r => {
                                    const employee = employees.find(e => e.id === r.employee_id);
                                    let balancesStr = '';
                                    try {
                                        balancesStr = JSON.stringify(JSON.parse(r.balances_json || '{}'));
                                    } catch {
                                        balancesStr = r.balances_json || '';
                                    }
                                    return [
                                        r.shift_date,
                                        employee ? employee.name : '',
                                        r.shift_type,
                                        r.total_requests,
                                        r.bybit_requests,
                                        r.htx_requests,
                                        r.bliss_requests,
                                        balancesStr, // —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –±–µ–∑ –¥–≤–æ–π–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                        r.scam_amount,
                                        r.scam_comment,
                                        r.dokidka_amount,
                                        r.dokidka_comment,
                                        r.internal_transfer_amount,
                                        r.internal_transfer_comment,
                                        r.bybit_first_trade,
                                        r.bybit_last_trade,
                                        r.htx_first_trade,
                                        r.htx_last_trade,
                                        r.bliss_first_trade,
                                        r.bliss_last_trade,
                                        r.gate_first_trade,
                                        r.gate_last_trade,
                                        r.appeal_amount,
                                        r.appeal_comment
                                    ].map(v => escapeCSV(v)); // balances_json —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç—Å—è escapeCSV
                                });
                                const csv = [header.join(','), ...rows].join('\r\n');
                                const blob = new Blob([csv], {type: 'text/csv'});
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'reports_export.csv';
                                document.body.appendChild(a);
                                a.click();
                                setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
                            }}><i className="fas fa-file-csv"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
                            {/* --- –ö–Ω–æ–ø–∫–∞ –ò–º–ø–æ—Ä—Ç –∏–∑ CSV --- */}
                            <input id="import-csv-input" type="file" accept=".csv" style={{display:'none'}} onChange={async e => {
                                const file = e.target.files[0];
                                if (!file) return;
                                const text = await file.text();
                                // –ü–∞—Ä—Å–∏–º CSV —á–µ—Ä–µ–∑ SheetJS
                                const workbook = XLSX.read(text, {type: 'string'});
                                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                                const data = XLSX.utils.sheet_to_json(sheet, {header:1});
                                const header = data[0];
                                const rows = data.slice(1);
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                                const required = ['–î–∞—Ç–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','–°–º–µ–Ω–∞','–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫'];
                                const missing = required.filter(f => !header.includes(f));
                                if (missing.length > 0) {
                                    alert('–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã: ' + missing.join(', ') + '\n\n–ü—Ä–∏–º–µ—Ä —à–∞–±–ª–æ–Ω–∞:\n–î–∞—Ç–∞,–°–æ—Ç—Ä—É–¥–Ω–∏–∫,–°–º–µ–Ω–∞,–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫,Bybit –∑–∞—è–≤–∫–∏,HTX –∑–∞—è–≤–∫–∏,Bliss –∑–∞—è–≤–∫–∏,–ë–∞–ª–∞–Ω—Å—ã (JSON),–°–ö–ê–ú,–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –°–ö–ê–ú,–î–æ–∫–∏–¥–∫–∞ (–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥, USDT),–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–∫–∏–¥–∫–∏,–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ (USDT),–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞,BYBIT –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞,BYBIT –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞,HTX –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞,HTX –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞,BLISS –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞,BLISS –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞,GATE –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞,GATE –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞');
                                    e.target.value = '';
                                    return;
                                }
                                // –ú–∞–ø–ø–∏–Ω–≥ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
                                const idx = {};
                                header.forEach((h,i) => { idx[h.trim()] = i; });
                                let ok = 0, fail = 0;
                                let errorDetails = [];
                                for (let i = 0; i < rows.length; i++) {
                                    if (rows[i].length < 4) { fail++; errorDetails.push(`–°—Ç—Ä–æ–∫–∞ ${i+2}: –Ω–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö`); continue; }
                                    let balances = rows[i][idx['–ë–∞–ª–∞–Ω—Å—ã (JSON)']];
                                    let valid = true;
                                    // –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞
                                    try {
                                        JSON.parse(balances || '{}');
                                    } catch {
                                        valid = false;
                                    }
                                    if (!valid) {
                                        fail++;
                                        errorDetails.push(`–°—Ç—Ä–æ–∫–∞ ${i+2}: –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON (–ø—Ä–∏–º–µ—Ä: ${String(rows[i][idx['–ë–∞–ª–∞–Ω—Å—ã (JSON)']]).slice(0, 40)}...)`);
                                        continue;
                                    }
                                    const payload = {
                                        shift_date: (() => {
                                            let val = rows[i][idx['–î–∞—Ç–∞']];
                                            // –ï—Å–ª–∏ —ç—Ç–æ —á–∏—Å–ª–æ (Excel date), –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ YYYY-MM-DD
                                            if (typeof val === 'number' || (!isNaN(val) && val !== '' && typeof val !== 'string')) {
                                                const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                                const jsDate = new Date(excelEpoch.getTime() + (Math.floor(val) * 86400000));
                                                if (val % 1 !== 0) {
                                                    jsDate.setTime(jsDate.getTime() + Math.round((val % 1) * 86400000));
                                                }
                                                return jsDate.toISOString().slice(0, 10);
                                            }
                                            // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ ‚Äî –ø—Ä–æ–±—É–µ–º –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥–∞—Ç–µ
                                            if (typeof val === 'string' && val.match(/^\d+(\.\d+)?$/)) {
                                                const num = parseFloat(val);
                                                if (!isNaN(num)) {
                                                    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
                                                    const jsDate = new Date(excelEpoch.getTime() + (Math.floor(num) * 86400000));
                                                    if (num % 1 !== 0) {
                                                        jsDate.setTime(jsDate.getTime() + Math.round((num % 1) * 86400000));
                                                    }
                                                    return jsDate.toISOString().slice(0, 10);
                                                }
                                            }
                                            return String(val).trim();
                                        })(),
                                        employee_name: rows[i][idx['–°–æ—Ç—Ä—É–¥–Ω–∏–∫']],
                                        shift_type: rows[i][idx['–°–º–µ–Ω–∞']],
                                        total_requests: rows[i][idx['–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫']],
                                        bybit_requests: rows[i][idx['Bybit –∑–∞—è–≤–∫–∏']],
                                        htx_requests: rows[i][idx['HTX –∑–∞—è–≤–∫–∏']],
                                        bliss_requests: rows[i][idx['Bliss –∑–∞—è–≤–∫–∏']],
                                        balances_json: balances,
                                        scam_amount: rows[i][idx['–°–ö–ê–ú']],
                                        scam_comment: rows[i][idx['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –°–ö–ê–ú']],
                                        dokidka_amount: rows[i][idx['–î–æ–∫–∏–¥–∫–∞ (–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥, USDT)']],
                                        dokidka_comment: rows[i][idx['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–∫–∏–¥–∫–∏']],
                                        internal_transfer_amount: rows[i][idx['–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ (USDT)']],
                                        internal_transfer_comment: rows[i][idx['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞']],
                                        bybit_first_trade: rows[i][idx['BYBIT –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞']],
                                        bybit_last_trade: rows[i][idx['BYBIT –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞']],
                                        htx_first_trade: rows[i][idx['HTX –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞']],
                                        htx_last_trade: rows[i][idx['HTX –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞']],
                                        bliss_first_trade: rows[i][idx['BLISS –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞']],
                                        bliss_last_trade: rows[i][idx['BLISS –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞']],
                                        gate_first_trade: rows[i][idx['GATE –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞']],
                                        gate_last_trade: rows[i][idx['GATE –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞']],
                                        appeal_amount: rows[i][idx['–ê–ø–ø–µ–ª—è—Ü–∏–∏ (—Å—É–º–º–∞, USDT)']],
                                        appeal_comment: rows[i][idx['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∞–ø–ø–µ–ª—è—Ü–∏–∏']]
                                    };
                                    // –ü–æ–ª—É—á–∞–µ–º employee_id –ø–æ –∏–º–µ–Ω–∏
                                    const emp = employees.find(e => String(e.name).trim() === String(payload.employee_name).trim());
                                    if (!emp) { fail++; errorDetails.push(`–°—Ç—Ä–æ–∫–∞ ${i+2}: —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω`); continue; }
                                    payload.employee_id = emp.id;
                                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥
                                    try {
                                        const resp = await fetch('/api/reports', {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify(payload)
                                        });
                                        if (resp.ok) ok++; else fail++;
                                    } catch { fail++; errorDetails.push(`–°—Ç—Ä–æ–∫–∞ ${i+2}: –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä`); }
                                }
                                let msg = `–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –£—Å–ø–µ—à–Ω–æ: ${ok} —Å—Ç—Ä–æ–∫, –æ—à–∏–±–æ–∫: ${fail}`;
                                if (errorDetails.length > 0) msg += '\n\n–û—à–∏–±–∫–∏:\n' + errorDetails.join('\n');
                                alert(msg);
                                loadReports();
                                e.target.value = '';
                            }} />
                            <button className="btn btn-secondary" type="button" style={{background:'#f7b731'}} onClick={() => document.getElementById('import-csv-input').click()}><i className="fas fa-file-import"></i> –ò–º–ø–æ—Ä—Ç –∏–∑ CSV</button>
                            <button className="btn" type="button" style={{marginLeft:8,background:'#3c78d8'}} onClick={() => {
                                // –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel (XLSX) —á–µ—Ä–µ–∑ SheetJS
                                const header = [
                                    '–î–∞—Ç–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','–°–º–µ–Ω–∞','–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫','Bybit –∑–∞—è–≤–∫–∏','HTX –∑–∞—è–≤–∫–∏','Bliss –∑–∞—è–≤–∫–∏',
                                    '–ë–∞–ª–∞–Ω—Å—ã (JSON)','–°–ö–ê–ú','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –°–ö–ê–ú','–î–æ–∫–∏–¥–∫–∞ (–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥, USDT)','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–∫–∏–¥–∫–∏','–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ (USDT)','–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –ø–µ—Ä–µ–≤–æ–¥–∞',
                                    'BYBIT –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','BYBIT –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞','HTX –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','HTX –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞','BLISS –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','BLISS –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞','GATE –ø–µ—Ä–≤–∞—è —Å–¥–µ–ª–∫–∞','GATE –ø–æ—Å–ª–µ–¥–Ω—è—è —Å–¥–µ–ª–∫–∞',
                                    '–ê–ø–ø–µ–ª—è—Ü–∏–∏ (—Å—É–º–º–∞, USDT)', '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∞–ø–ø–µ–ª—è—Ü–∏–∏'
                                ];
                                const rows = reports.map(r => {
                                    const employee = employees.find(e => e.id === r.employee_id);
                                    let balancesStr = '';
                                    try {
                                        balancesStr = JSON.stringify(JSON.parse(r.balances_json || '{}'));
                                    } catch {
                                        balancesStr = r.balances_json || '';
                                    }
                                    return [
                                        r.shift_date,
                                        employee ? employee.name : '',
                                        r.shift_type,
                                        r.total_requests,
                                        r.bybit_requests,
                                        r.htx_requests,
                                        r.bliss_requests,
                                        balancesStr, // —Ç–µ–ø–µ—Ä—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –±–µ–∑ –¥–≤–æ–π–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                                        r.scam_amount,
                                        r.scam_comment,
                                        r.dokidka_amount,
                                        r.dokidka_comment,
                                        r.internal_transfer_amount,
                                        r.internal_transfer_comment,
                                        r.bybit_first_trade,
                                        r.bybit_last_trade,
                                        r.htx_first_trade,
                                        r.htx_last_trade,
                                        r.bliss_first_trade,
                                        r.bliss_last_trade,
                                        r.gate_first_trade,
                                        r.gate_last_trade,
                                        r.appeal_amount,
                                        r.appeal_comment
                                    ].map(v => escapeCSV(v)); // balances_json —Ç–µ–ø–µ—Ä—å —Ç–æ–∂–µ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç—Å—è escapeCSV
                                });
                                const ws = window.XLSX.utils.aoa_to_sheet([header, ...rows]);
                                const wb = window.XLSX.utils.book_new();
                                window.XLSX.utils.book_append_sheet(wb, ws, '–û—Ç—á–µ—Ç—ã');
                                window.XLSX.writeFile(wb, 'reports_export.xlsx');
                            }}><i className="fas fa-file-excel"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
                        </div>
                        <div className="filters" style={{marginBottom: '8px'}}>
                            <div className="filter-item">
                                <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label>
                                <input type="date" className="form-control" value={filters.start_date} onChange={e => setFilters({...filters, start_date: e.target.value})} />
                            </div>
                            <div className="filter-item">
                                <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label>
                                <input type="date" className="form-control" value={filters.end_date} onChange={e => setFilters({...filters, end_date: e.target.value})} />
                            </div>
                            <div className="filter-item">
                                <label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                                <select className="form-control" value={filters.employee_id} onChange={e => setFilters({...filters, employee_id: e.target.value})}>
                                    <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                                    {employees.map(emp => (
                                        <option key={emp.id} value={emp.id}>{emp.name}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="filter-item" style={{ display: 'flex', alignItems: 'end' }}>
                                <button className="btn" onClick={loadReports}>
                                    <i className="fas fa-search"></i> –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                </button>
                            </div>
                        </div>
                        <hr style={{margin: '24px 0', border: 'none', borderTop: '2px solid #e1e8ed'}} />
                        {showForm && (
                            <div style={{margin:'0 auto',maxWidth:900,padding:'32px 0'}}>
                                <h2 style={{color:'#764ba2',marginBottom:24,display:'flex',alignItems:'center',gap:12}}><i className="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</h2>
                                <form onSubmit={handleSubmit} encType="multipart/form-data" style={{display:'flex',flexDirection:'column',gap:32}}>
                                    {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 2px 12px #e1e8ed',padding:24,marginBottom:8}}>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))',gap:18}}>
                                            <div>
                                                <label style={{fontWeight:600}}>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</label>
                                            <select className="form-control" value={formData.employee_id} onChange={e => setFormData({...formData, employee_id: e.target.value})} required>
                                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞</option>
                                                {employees.map(emp => (
                                                    <option key={emp.id} value={emp.id}>{emp.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                            <div>
                                                <label style={{fontWeight:600}}>–î–∞—Ç–∞ —Å–º–µ–Ω—ã</label>
                                            <input type="date" className="form-control" value={formData.shift_date} onChange={e => setFormData({...formData, shift_date: e.target.value})} required />
                                        </div>
                                            <div>
                                                <label style={{fontWeight:600}}>–¢–∏–ø —Å–º–µ–Ω—ã</label>
                                            <select className="form-control" value={formData.shift_type} onChange={e => setFormData({...formData, shift_type: e.target.value})}>
                                                <option value="morning">–£—Ç—Ä–µ–Ω–Ω—è—è</option>
                                                <option value="evening">–í–µ—á–µ—Ä–Ω—è—è</option>
                                            </select>
                                        </div>
                                    </div>
                                    </div>
                                    {/* –ó–∞—è–≤–∫–∏ –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º */}
                                    <div style={{background:'#f8f9fa',borderRadius:16,boxShadow:'0 1px 6px #e1e8ed',padding:24}}>
                                        <div style={{fontWeight:700,color:'#764ba2',marginBottom:12,display:'flex',alignItems:'center',gap:8}}><i className="fas fa-list-alt"></i> –ó–∞—è–≤–∫–∏ –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º</div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))',gap:16}}>
                                            <div>
                                                <label>Bybit</label>
                                                <input type="number" className="form-control" value={formData.bybit_requests || ''} onChange={e => setFormData({...formData, bybit_requests: e.target.value})} onWheel={e => e.target.blur()} />
                                        </div>
                                            <div>
                                                <label>HTX</label>
                                                <input type="number" className="form-control" value={formData.htx_requests || ''} onChange={e => setFormData({...formData, htx_requests: e.target.value})} onWheel={e => e.target.blur()} />
                                        </div>
                                            <div>
                                                <label>Bliss</label>
                                                <input type="number" className="form-control" value={formData.bliss_requests || ''} onChange={e => setFormData({...formData, bliss_requests: e.target.value})} onWheel={e => e.target.blur()} />
                                        </div>
                                    </div>
                                    </div>
                                    {/* –ë–∞–ª–∞–Ω—Å—ã –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 1px 6px #e1e8ed',padding:24}}>
                                        <div style={{fontWeight:700,color:'#667eea',marginBottom:12,display:'flex',alignItems:'center',gap:8}}><i className="fas fa-wallet"></i> –ë–∞–ª–∞–Ω—Å—ã –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º</div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:16}}>
                                            {['bybit','htx','bliss','gate'].map(platform => {
                                                return (
                                                    <div key={platform}>
                                                <label style={{fontWeight:600}}>{platform.toUpperCase()} –∞–∫–∫–∞—É–Ω—Ç—ã</label>
                                                <div style={{display:'flex',flexWrap:'wrap',gap:'10px',marginBottom:6}}>
                                                    {accounts.filter(a => a.platform === platform).map(acc => {
                                                        const checked = formData.balances[platform].some(a2 => a2.id === acc.id);
                                                        return (
                                                            <label key={acc.id} style={{marginRight:10,display:'flex',alignItems:'center',gap:4}}>
                                                                        <input type="checkbox" checked={checked} onChange={e => {
                                                                        if (e.target.checked) {
                                                                            handleAccountChange(platform, [...formData.balances[platform].map(a => a.id.toString()), acc.id.toString()]);
                                                                        } else {
                                                                            handleAccountChange(platform, formData.balances[platform].filter(a => a.id !== acc.id).map(a => a.id.toString()));
                                                                        }
                                                                        }} />
                                                                {acc.account_name}
                                                            </label>
                                                        );
                                                    })}
                                                </div>
                                                {formData.balances[platform].map((acc, idx) => (
                                                    <div key={acc.id || acc.account_id} style={{ marginTop: 5 }}>
                                                        <label>–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è {acc.account_name}:</label>
                                                                <input type="number" className="form-control" value={acc.start_balance} onChange={e => handleBalanceChange(platform, idx, 'start_balance', e.target.value)} onWheel={e => e.target.blur()} />
                                                        <label style={{marginTop:4}}>–ö–æ–Ω–µ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å –¥–ª—è {acc.account_name}:</label>
                                                                <input type="number" className="form-control" value={acc.end_balance} onChange={e => handleBalanceChange(platform, idx, 'end_balance', e.target.value)} onWheel={e => e.target.blur()} />
                                                    </div>
                                                ))}
                                            </div>
                                                );
                                            })}
                                    </div>
                                    </div>
                                    {/* –°–ö–ê–ú –∏ –ø–µ—Ä–µ–≤–æ–¥—ã */}
                                    <div style={{background:'#f8f9fa',borderRadius:16,boxShadow:'0 1px 6px #e1e8ed',padding:24}}>
                                        <div style={{fontWeight:700,color:'#e74c3c',marginBottom:12,display:'flex',alignItems:'center',gap:8}}><i className="fas fa-exclamation-triangle"></i> –°–ö–ê–ú –∏ –ø–µ—Ä–µ–≤–æ–¥—ã</div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))',gap:16}}>
                                            <div>
                                            <label>–°–ö–ê–ú (—Å—É–º–º–∞, USDT)</label>
                                                <input type="number" className="form-control" value={formData.scam_amount} onChange={e => setFormData({ ...formData, scam_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –°–ö–ê–ú</label>
                                                <input type="text" className="form-control" value={formData.scam_comment} onChange={e => setFormData({ ...formData, scam_comment: e.target.value })} />
                                            <div style={{marginTop:8}}>
                                                <label style={{fontWeight:400, fontSize:'0.98em'}}>
                                                    <input type="checkbox" checked={formData.scam_personal || false} onChange={e => setFormData({ ...formData, scam_personal: e.target.checked })} /> –ü–æ –º–æ–µ–π –≤–∏–Ω–µ (–≤—ã—á–∏—Ç–∞–µ—Ç—Å—è –∏–∑ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏)
                                                </label>
                                            </div>
                                        </div>
                                            <div>
                                            <label>–î–æ–∫–∏–¥–∫–∞ (–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥, USDT)</label>
                                                <input type="number" className="form-control" value={formData.dokidka_amount} onChange={e => setFormData({ ...formData, dokidka_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –¥–æ–∫–∏–¥–∫–µ</label>
                                                <input type="text" className="form-control" value={formData.dokidka_comment} onChange={e => setFormData({ ...formData, dokidka_comment: e.target.value })} />
                                        </div>
                                            <div>
                                            <label>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ (USDT)</label>
                                                <input type="number" className="form-control" value={formData.internal_transfer_amount} onChange={e => setFormData({ ...formData, internal_transfer_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É –ø–µ—Ä–µ–≤–æ–¥—É</label>
                                                <input type="text" className="form-control" value={formData.internal_transfer_comment} onChange={e => setFormData({ ...formData, internal_transfer_comment: e.target.value })} />
                                        </div>
                                        <div>
                                            <label>–ê–ø–ø–µ–ª—è—Ü–∏–∏ (—Å—É–º–º–∞, USDT)</label>
                                                <input type="number" className="form-control" value={formData.appeal_amount || ''} onChange={e => setFormData({ ...formData, appeal_amount: e.target.value })} onWheel={e => e.target.blur()} />
                                            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∞–ø–ø–µ–ª—è—Ü–∏–∏</label>
                                                <input type="text" className="form-control" value={formData.appeal_comment || ''} onChange={e => setFormData({ ...formData, appeal_comment: e.target.value })} />
                                    </div>
                                    </div>
                                    </div>
                                    {/* –§–∞–π–ª—ã –∏ —Ñ–æ—Ç–æ */}
                                    <div style={{background:'#fff',borderRadius:16,boxShadow:'0 1px 6px #e1e8ed',padding:24}}>
                                        <div style={{fontWeight:700,color:'#764ba2',marginBottom:12,display:'flex',alignItems:'center',gap:8}}><i className="fas fa-paperclip"></i> –§–∞–π–ª—ã –∏ —Ñ–æ—Ç–æ</div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(220px, 1fr))',gap:16}}>
                                            <div>
                                            <label>–í—ã–≥—Ä—É–∑–∫–∞ Bybit</label>
                                            <input type="file" className="form-control" accept=".csv,.xlsx,.xls" onChange={e => setFormData(fd => ({...fd, bybit_file: e.target.files[0]}))} />
                                        </div>
                                            <div>
                                            <label>–í—ã–≥—Ä—É–∑–∫–∞ HTX</label>
                                            <input type="file" className="form-control" accept=".csv,.xlsx,.xls" onChange={e => setFormData(fd => ({...fd, htx_file: e.target.files[0]}))} />
                                        </div>
                                            <div>
                                            <label>–í—ã–≥—Ä—É–∑–∫–∞ Bliss</label>
                                            <input type="file" className="form-control" accept=".csv,.xlsx,.xls" onChange={e => setFormData(fd => ({...fd, bliss_file: e.target.files[0]}))} />
                                        </div>
                                            <div>
                                            <label>–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã</label>
                                            <input type="file" className="form-control" accept="image/*" onChange={e => setFormData(fd => ({...fd, start_photo: e.target.files[0]}))} />
                                        </div>
                                            <div>
                                            <label>–§–æ—Ç–æ –∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã</label>
                                            <input type="file" className="form-control" accept="image/*" onChange={e => setFormData(fd => ({...fd, end_photo: e.target.files[0]}))} />
                                        </div>
                                    </div>
                                    </div>
                                    {/* –î–∞—Ç—ã —Å–¥–µ–ª–æ–∫ –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º */}
                                    <div style={{background:'#f8f9fa',borderRadius:16,boxShadow:'0 1px 6px #e1e8ed',padding:24}}>
                                        <div style={{fontWeight:700,color:'#3c78d8',marginBottom:12,display:'flex',alignItems:'center',gap:8}}><i className="fas fa-calendar-alt"></i> –î–∞—Ç—ã —Å–¥–µ–ª–æ–∫ –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º</div>
                                        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(180px, 1fr))',gap:16}}>
                                      {['bybit','htx','bliss','gate'].map(platform => (
                                                <div key={platform}>
                                          <label style={{fontWeight:600}}>{platform.toUpperCase()}</label>
                                                    <input type="text" className="form-control" placeholder="–î–∞—Ç–∞ –ø–µ—Ä–≤–æ–π —Å–¥–µ–ª–∫–∏" value={formData[platform + '_first_trade'] || ''} onChange={e => setFormData(fd => ({...fd, [platform + '_first_trade']: e.target.value}))} />
                                                    <input type="text" className="form-control" placeholder="–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–¥–µ–ª–∫–∏" style={{marginTop:8}} value={formData[platform + '_last_trade'] || ''} onChange={e => setFormData(fd => ({...fd, [platform + '_last_trade']: e.target.value}))} />
                                        </div>
                                      ))}
                                    </div>
                                    </div>
                                    {/* –ö–Ω–æ–ø–∫–∏ */}
                                    <div style={{display:'flex',gap:18,justifyContent:'flex-end',marginTop:8}}>
                                        <button type="submit" className="btn" style={{minWidth:140}}><i className="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button type="button" className="btn btn-secondary" style={{minWidth:120}} onClick={() => setShowForm(false)}><i className="fas fa-times"></i> –û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </form>
                            </div>
                        )}

                        <table className="table">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ê–∫–∫–∞—É–Ω—Ç—ã —Å–º–µ–Ω—ã</th>
                                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                    <th>–°–º–µ–Ω–∞</th>
                                    <th>–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</th>
                                    <th>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∏—Ç–æ–≥ —Å–º–µ–Ω—ã</th>
                                    <th>–°–ö–ê–ú</th>
                                    <th>–î–æ–∫–∏–¥–∫–∞ (–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥, USDT)</th>
                                    <th>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ (USDT)</th>
                                    <th>–ê–ø–ø–µ–ª—è—Ü–∏–∏ (USDT)</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {reports.map((report, idx) => {
                                    const employee = employees.find(emp => emp.id === report.employee_id);
                                    let balances = {};
                                    try { balances = JSON.parse(report.balances_json || '{}'); } catch { balances = {}; }
                                    return (
                                        <React.Fragment key={report.id}>
                                            <tr>
                                                <td>{new Date(report.shift_date).toLocaleDateString('ru-RU')}</td>
                                                <td>{(() => {
                                                  const platformIcons = {
                                                    bybit: <i className="fab fa-btc" style={{color:'#f7b731',marginRight:2}}></i>,
                                                    htx: <i className="fab fa-hubspot" style={{color:'#27ae60',marginRight:2}}></i>,
                                                    bliss: <i className="fas fa-bolt" style={{color:'#e74c3c',marginRight:2}}></i>,
                                                    gate: <i className="fas fa-circle" style={{color:'#764ba2',marginRight:2}}></i>
                                                  };
                                                  let accs = [];
                                                  try {
                                                    const bals = JSON.parse(report.balances_json || '{}');
                                                    ['bybit','htx','bliss','gate'].forEach(platform => {
                                                      if (bals[platform] && bals[platform].length > 0) {
                                                        accs.push(
                                                          <span key={platform} style={{marginRight:8,whiteSpace:'nowrap',display:'inline-block'}}>
                                                            {platformIcons[platform]}
                                                            <span style={{fontWeight:600, color:'#667eea'}}>{platform.toUpperCase()}:</span>{' '}
                                                            {bals[platform].map(acc => acc.account_name).join(', ')}
                                                          </span>
                                                        );
                                                      }
                                                    });
                                                  } catch {}
                                                  return accs.length ? accs : '‚Äî';
                                                })()}</td>
                                                <td>{employee ? employee.name : '‚Äî'}</td>
                                                <td>{report.shift_type === 'morning' ? '–£—Ç—Ä–µ–Ω–Ω—è—è' : '–í–µ—á–µ—Ä–Ω—è—è'}</td>
                                                <td>{report.total_requests}</td>
                                                <td style={{textAlign:'right'}}>
                                                  {(() => {
                                                    let totalEnd = 0;
                                                    let totalStart = 0;
                                                    ['bybit','htx','bliss','gate'].forEach(platform => {
                                                        if (balances[platform] && balances[platform].length > 0) {
                                                        totalEnd += balances[platform].reduce((accum, acc) => acc.end_balance !== '' && !isNaN(acc.end_balance) ? accum + parseFloat(acc.end_balance) : accum, 0);
                                                        totalStart += balances[platform].reduce((accum, acc) => acc.start_balance !== '' && !isNaN(acc.start_balance) ? accum + parseFloat(acc.start_balance) : accum, 0);
                                                      }
                                                    });
                                                    const dokidka = parseFloat(report.dokidka_amount) || 0;
                                                    const internal = parseFloat(report.internal_transfer_amount) || 0;
                                                    const endSum = totalEnd - dokidka;
                                                    const profit = (totalEnd - totalStart) - dokidka - internal;
                                                        return (
                                                      <div style={{
                                                        background: 'linear-gradient(90deg,#f3f6fd 60%,#e1e8ed 100%)',
                                                        borderRadius: 12,
                                                        padding: '8px 10px',
                                                        boxShadow: '0 1px 6px #e1e8ed',
                                                        display: 'inline-block',
                                                        minWidth: 120
                                                      }}>
                                                        <div style={{display:'flex',alignItems:'center',gap:8,marginBottom:4}}>
                                                          <i className="fas fa-wallet" style={{color:'#667eea',fontSize:18}}></i>
                                                          <span style={{fontWeight:700,color:'#333',fontSize:'1.08em'}}>–ë–∞–ª–∞–Ω—Å –Ω–∞ –∫–æ–Ω–µ—Ü —Å–º–µ–Ω—ã:</span>
                                                        </div>
                                                        <div style={{fontWeight:700,color:'#764ba2',fontSize:'1.15em',marginBottom:6}}>
                                                          {endSum.toFixed(2)} <span style={{fontWeight:400,color:'#888',fontSize:'0.95em'}}>USDT</span>
                                                        </div>
                                                        <div style={{display:'flex',alignItems:'center',gap:8}}>
                                                          <i className="fas fa-coins" style={{color:'#27ae60',fontSize:16}}></i>
                                                          <span style={{fontWeight:700,color:'#333'}}>–ü—Ä–∏–±—ã–ª—å –∑–∞ —Å–º–µ–Ω—É:</span>
                                                        </div>
                                                        <div style={{fontWeight:700,color:profit>=0?'#27ae60':'#e74c3c',fontSize:'1.12em'}}>
                                                          {(profit >= 0 ? '+' : '') + profit.toFixed(2)} <span style={{fontWeight:400,color:'#888',fontSize:'0.95em'}}>USDT</span>
                                                        </div>
                                                            </div>
                                                        );
                                                  })()}
                                                </td>
                                                <td style={{color:'#e74c3c',textAlign:'center'}}>{report.scam_amount > 0 ? report.scam_amount : '‚Äî'}</td>
                                                <td style={{color:'#f7b731',textAlign:'center'}}>{report.dokidka_amount !== 0 ? report.dokidka_amount : '‚Äî'}</td>
                                                <td style={{color:'#f7b731',textAlign:'center'}}>{report.internal_transfer_amount !== 0 ? report.internal_transfer_amount : '‚Äî'}</td>
                                                <td style={{color:'#f7b731',textAlign:'center'}}>
                                                  {(() => {
                                                    let appeal = report.appeal_amount;
                                                    let appealNum = 0;
                                                    if (typeof appeal === 'string' && appeal.trim() !== '') appealNum = parseFloat(appeal);
                                                    else if (typeof appeal === 'number') appealNum = appeal;
                                                    if (isNaN(appealNum)) appealNum = 0;
                                                    return appealNum !== 0 ? appealNum : '‚Äî';
                                                  })()}
                                                </td>
                                                <td style={{textAlign:'center'}}>
                                                  <button className="btn btn-secondary btn-xs" title="–î–µ—Ç–∞–ª–∏" onClick={() => setExpandedReportId(expandedReportId === report.id ? null : report.id)}>
                                                    <i className={expandedReportId === report.id ? 'fas fa-eye-slash' : 'fas fa-eye'}></i>
                                                  </button>
                                                  <button className="btn btn-secondary btn-xs" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" onClick={() => { setSelectedReport(report); setShowForm(true); }}>
                                                    <i className="fas fa-edit"></i>
                                                  </button>
                                                  <button className="btn btn-danger btn-xs" title="–£–¥–∞–ª–∏—Ç—å" onClick={() => { if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç?')) { deleteReport(report.id); } }}>
                                                    <i className="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            {expandedReportId === report.id && (
                                                <ReportDetails report={report} reports={reports} employees={employees} accounts={accounts} setShowDetails={setShowDetails} showDetails={showDetails} setZoomedImage={setZoomedImage} />
                                            )}
                                        </React.Fragment>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // –î–æ–±–∞–≤–ª—è—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ReportDetails
        function ReportDetails({ report, reports, employees, accounts, setShowDetails, showDetails, setZoomedImage }) {
            const employee = employees.find(emp => emp.id === report.employee_id);
            let balances = {};
            try { balances = JSON.parse(report.balances_json || '{}'); } catch { balances = {}; }
            // --- –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ReportDetails ---
            return (
                                                <tr>
                                                    <td colSpan={9}>
                        <div style={{display:'flex',flexDirection:'column',gap:28,background:'#f8f9fa',borderRadius:24,padding:'32px 18px',margin:'14px 0',boxShadow:'0 4px 32px rgba(102,126,234,0.10)',maxWidth:1200,marginLeft:'auto',marginRight:'auto'}}>
                                                            {/* –í–µ—Ä—Ö–Ω–∏–π –±–ª–æ–∫: –¥–∞—Ç–∞, —Å–æ—Ç—Ä—É–¥–Ω–∏–∫, —Å–º–µ–Ω–∞ */}
                            <div style={{display:'flex',gap:24,alignItems:'center',flexWrap:'wrap',borderLeft:'6px solid #667eea',paddingLeft:18,background:'#fff',borderRadius:16,padding:'18px 12px'}}>
                                <div style={{fontSize:'1.15em',fontWeight:700,display:'flex',alignItems:'center',gap:10}}>
                                                                    <i className="fas fa-calendar-alt" style={{color:'#667eea',fontSize:22}}></i> {new Date(report.shift_date).toLocaleDateString('ru-RU')}
                                                                </div>
                                <div style={{fontSize:'1.1em',fontWeight:600,display:'flex',alignItems:'center',gap:10}}>
                                                                    <i className="fas fa-user" style={{color:'#764ba2',fontSize:20}}></i> {employee ? employee.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                                                                </div>
                                <div style={{fontSize:'1.1em',fontWeight:600,display:'flex',alignItems:'center',gap:10}}>
                                                                    <i className={report.shift_type==='morning' ? 'fas fa-sun' : 'fas fa-moon'} style={{color:report.shift_type==='morning'?'#f7b731':'#667eea',fontSize:20}}></i> {report.shift_type === 'morning' ? '–£—Ç—Ä–µ–Ω–Ω—è—è' : '–í–µ—á–µ—Ä–Ω—è—è'} —Å–º–µ–Ω–∞
                                                                </div>
                                                            </div>
                            {/* –ó–∞—è–≤–∫–∏ –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º */}
                            <div style={{background:'#fff',borderRadius:16,padding:'18px 12px',boxShadow:'0 2px 8px #e1e8ed',borderLeft:'6px solid #764ba2'}}>
                                <div style={{fontWeight:700,fontSize:'1.1em',color:'#764ba2',marginBottom:8,display:'flex',alignItems:'center',gap:10}}>
                                    <i className="fas fa-list-alt" style={{color:'#764ba2',fontSize:20}}></i> –ó–∞—è–≤–∫–∏ –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º:
                                </div>
                                <div style={{display:'flex',gap:18,flexWrap:'wrap'}}>
                                    <span style={{background:'#f3f6fd',borderRadius:8,padding:'4px 12px',fontWeight:600}}><i className="fab fa-btc" style={{color:'#f7b731',marginRight:6}}></i>Bybit: {report.bybit_requests || 0}</span>
                                                                <span style={{background:'#f3f6fd',borderRadius:8,padding:'4px 12px',fontWeight:600}}><i className="fab fa-hubspot" style={{color:'#27ae60',marginRight:6}}></i>HTX: {report.htx_requests || 0}</span>
                                                                <span style={{background:'#f3f6fd',borderRadius:8,padding:'4px 12px',fontWeight:600}}><i className="fas fa-bolt" style={{color:'#e74c3c',marginRight:6}}></i>Bliss: {report.bliss_requests || 0}</span>
                                                                <span style={{background:'#f3f6fd',borderRadius:8,padding:'4px 12px',fontWeight:600}}><i className="fas fa-circle" style={{color:'#764ba2',marginRight:6}}></i>Gate: {report.gate_requests || 0}</span>
                                                            </div>
                                                            </div>
                            {/* –ë–∞–ª–∞–Ω—Å—ã –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º */}
                            <div style={{background:'#fff',borderRadius:16,padding:'18px 12px',boxShadow:'0 2px 8px #e1e8ed',borderLeft:'6px solid #667eea'}}>
                                <div style={{fontWeight:700,fontSize:'1.1em',color:'#667eea',marginBottom:8,display:'flex',alignItems:'center',gap:10}}>
                                    <i className="fas fa-wallet" style={{color:'#667eea',fontSize:20}}></i> –ë–∞–ª–∞–Ω—Å—ã –ø–æ –∞–∫–∫–∞—É–Ω—Ç–∞–º:
                                                            </div>
                                <div style={{overflowX:'auto',paddingBottom:4}}>
                                    <table style={{minWidth:480,width:'100%',fontSize:'1em',borderCollapse:'collapse'}}>
                                        <thead style={{background:'#f3f6fd'}}>
                                            <tr>
                                                <th style={{textAlign:'left',padding:'6px 12px'}}>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                                                <th style={{textAlign:'left',padding:'6px 12px'}}>–ê–∫–∫–∞—É–Ω—Ç</th>
                                                <th style={{textAlign:'right',padding:'6px 12px'}}>–ù–∞—á–∞–ª—å–Ω—ã–π</th>
                                                <th style={{textAlign:'right',padding:'6px 12px'}}>–ö–æ–Ω–µ—á–Ω—ã–π</th>
                                                <th style={{textAlign:'right',padding:'6px 12px'}}>Œî</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {['bybit','htx','bliss','gate'].flatMap(platform =>
                                                (balances[platform]||[]).map(acc => {
                                                    const start = acc.start_balance !== '' && !isNaN(acc.start_balance) ? parseFloat(acc.start_balance) : 0;
                                                    const end = acc.end_balance !== '' && !isNaN(acc.end_balance) ? parseFloat(acc.end_balance) : 0;
                                                    const diff = end - start;
                                                    return (
                                                        <tr key={platform+'-'+(acc.account_id||acc.id)} style={{background: diff>0?'#f8fff8':diff<0?'#fff8f8':'#fff'}}>
                                                            <td style={{padding:'6px 12px',color:'#888'}}>{platform.toUpperCase()}</td>
                                                            <td style={{padding:'6px 12px'}}>{acc.account_name}</td>
                                                            <td style={{textAlign:'right',padding:'6px 12px'}}>{start} USDT</td>
                                                            <td style={{textAlign:'right',padding:'6px 12px'}}>{end} USDT</td>
                                                            <td style={{textAlign:'right',padding:'6px 12px',color:diff>0?'#27ae60':diff<0?'#e74c3c':'#888',fontWeight:600}}>{diff>0?'+':''}{diff.toFixed(2)}</td>
                                                        </tr>
                                                    );
                                                })
                                            )}
                                        </tbody>
                                    </table>
                                                                        </div>
                                                            </div>
                            {/* –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∏—Ç–æ–≥–∏ */}
                            <div style={{display:'flex',gap:24,flexWrap:'wrap',marginTop:8}}>
                                <div style={{flex:1,minWidth:320,background:'#fff',borderRadius:16,padding:'18px 12px',boxShadow:'0 2px 8px #e1e8ed',borderLeft:'6px solid #f7b731'}}>
                                    <div style={{fontWeight:700,fontSize:'1.1em',color:'#f7b731',marginBottom:8,display:'flex',alignItems:'center',gap:10}}>
                                        <i className="fas fa-coins" style={{color:'#f7b731',fontSize:20}}></i> –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –∏—Ç–æ–≥–∏:
                                                            </div>
                                    <div style={{margin:'0 0 18px 0',display:'flex',alignItems:'center',gap:16,background:'#f8f9fa',borderRadius:12,padding:'14px 18px',boxShadow:'0 2px 8px #e1e8ed'}}>
                                        <i className="fas fa-balance-scale" style={{color:'#764ba2',fontSize:20}}></i>
                                        <b style={{color:'#764ba2'}}>–°—É–º–º–∞—Ä–Ω—ã–π –±–∞–ª–∞–Ω—Å –Ω–∞ –∫–æ–Ω–µ—Ü —Å–º–µ–Ω—ã:</b><br/>
                                        <span style={{fontWeight:700,fontSize:'1.1em',color:'#764ba2'}}>{(() => {
                                            let total = 0;
                                            ['bybit','htx','bliss','gate'].forEach(platform => {
                                                if (balances[platform] && balances[platform].length > 0) {
                                                    total += balances[platform].reduce((accum, acc) => acc.end_balance !== '' && !isNaN(acc.end_balance) ? accum + parseFloat(acc.end_balance) : accum, 0);
                                                }
                                            });
                                            const dokidka = parseFloat(report.dokidka_amount) || 0;
                                            return (total - dokidka).toFixed(2);
                                        })()} USDT</span>
                                        <span style={{color:'#888',marginLeft:8}}>(—Å—É–º–º–∞ –±–∞–ª–∞–Ω—Å–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ ‚àí –¥–æ–∫–∏–¥–∫–∞)</span>
                                    </div>
                                    <div style={{display:'flex',gap:18,flexWrap:'wrap',marginBottom:10}}>
                                        <div style={{background:'#f8f9fa',borderRadius:12,padding:'14px 18px',minWidth:120,maxWidth:340,boxShadow:'0 2px 8px #e1e8ed',display:'flex',flexDirection:'column'}}>
                                            <b style={{color:'#e74c3c',whiteSpace:'nowrap'}}>–°–ö–ê–ú:</b>
                                            <div style={{display:'flex',flexDirection:'column',gap:4}}>
                                                                    {report.scam_amount > 0
                                                    ? <span style={{color:'#e74c3c',fontWeight:700,fontSize:'1.1em',whiteSpace:'nowrap'}}>{report.scam_amount} USDT</span>
                                                                        : <span style={{color:'#aaa'}}>‚Äî</span>}
                                                {report.scam_comment && <span style={{color:'#888',wordBreak:'break-word',overflowWrap:'break-word',whiteSpace:'pre-wrap'}}>{report.scam_comment}</span>}
                                                                </div>
                                        </div>
                                        <div style={{background:'#f8f9fa',borderRadius:12,padding:'14px 18px',minWidth:120,maxWidth:340,boxShadow:'0 2px 8px #e1e8ed',display:'flex',flexDirection:'column'}}>
                                            <b style={{color:'#f7b731',whiteSpace:'nowrap'}}>–î–æ–∫–∏–¥–∫–∞ (–≤–Ω–µ—à–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥, USDT):</b>
                                            <div style={{display:'flex',flexDirection:'column',gap:4}}>
                                    {report.dokidka_amount !== 0
                                        ? (
                                                        <span style={{color: report.dokidka_amount < 0 ? '#27ae60' : '#f7b731',fontWeight:700,fontSize:'1.1em',whiteSpace:'nowrap'}}>
                                                {report.dokidka_amount < 0
                                                    ? `+${Math.abs(report.dokidka_amount)} USDT`
                                                    : `${report.dokidka_amount} USDT`}
                                            </span>
                                        )
                                        : <span style={{color:'#aaa'}}>‚Äî</span>
                                    }
                                                {report.dokidka_comment && <span style={{color:'#888',wordBreak:'break-word',overflowWrap:'break-word',whiteSpace:'pre-wrap'}}>{report.dokidka_comment}</span>}
                                </div>
                                        </div>
                                        <div style={{background:'#f8f9fa',borderRadius:12,padding:'14px 18px',minWidth:120,maxWidth:340,boxShadow:'0 2px 8px #e1e8ed',display:'flex',flexDirection:'column'}}>
                                            <b style={{color:'#f7b731',whiteSpace:'nowrap'}}>–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –ø–µ—Ä–µ–≤–æ–¥ (USDT):</b>
                                            <div style={{display:'flex',flexDirection:'column',gap:4}}>
                                    {report.internal_transfer_amount !== 0
                                        ? (
                                                        <span style={{color: report.internal_transfer_amount < 0 ? '#27ae60' : '#f7b731',fontWeight:700,fontSize:'1.1em',whiteSpace:'nowrap'}}>
                                                {report.internal_transfer_amount < 0
                                                    ? `+${Math.abs(report.internal_transfer_amount)} USDT`
                                                    : `${report.internal_transfer_amount} USDT`}
                                            </span>
                                        )
                                        : <span style={{color:'#aaa'}}>‚Äî</span>
                                    }
                                                {report.internal_transfer_comment && <span style={{color:'#888',wordBreak:'break-word',overflowWrap:'break-word',whiteSpace:'pre-wrap'}}>{report.internal_transfer_comment}</span>}
                                            </div>
                                        </div>
                                        <div style={{background:'#f8f9fa',borderRadius:12,padding:'14px 18px',minWidth:120,maxWidth:340,boxShadow:'0 2px 8px #e1e8ed',display:'flex',flexDirection:'column'}}>
                                            <b style={{color:'#f7b731',whiteSpace:'nowrap'}}>–ê–ø–ø–µ–ª—è—Ü–∏–∏ (—Å—É–º–º–∞, USDT):</b>
                                            <div style={{display:'flex',flexDirection:'column',gap:4}}>
                                                {(() => {
                                                    let appeal = report.appeal_amount;
                                                    let appealNum = 0;
                                                    if (typeof appeal === 'string' && appeal.trim() !== '') appealNum = parseFloat(appeal);
                                                    else if (typeof appeal === 'number') appealNum = appeal;
                                                    if (isNaN(appealNum)) appealNum = 0;
                                                    return appealNum !== 0
                                                        ? (
                                                            <span style={{color: appealNum < 0 ? '#27ae60' : '#f7b731',fontWeight:700,fontSize:'1.1em',whiteSpace:'nowrap'}}>
                                                                {appealNum < 0 ? `+${Math.abs(appealNum).toFixed(2)} USDT` : `${appealNum.toFixed(2)} USDT`}
                                                            </span>
                                                        )
                                                        : <span style={{color:'#aaa'}}>‚Äî</span>;
                                                })()}
                                                {report.appeal_comment && (
                                                  <span style={{color:'#888',wordBreak:'break-word',overflowWrap:'break-word',whiteSpace:'pre-wrap'}}>
                                                    {report.appeal_comment}
                                                  </span>
                                                )}
                                            </div>
                                                                </div>
                                                            </div>
                                </div>
                                {/* –í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ ‚Äî —Ñ–∞–π–ª—ã –∏ —Ñ–æ—Ç–æ, —Å–≤–µ—Ä–Ω—É—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */}
                                <div style={{flex:1,minWidth:320,background:'#fff',borderRadius:16,padding:'18px 12px',boxShadow:'0 2px 8px #e1e8ed',borderLeft:'6px solid #764ba2',marginTop:0}}>
                                    <div style={{fontWeight:700,fontSize:'1.1em',color:'#764ba2',marginBottom:8,display:'flex',alignItems:'center',gap:10}}>
                                        <i className="fas fa-paperclip" style={{color:'#764ba2',fontSize:20}}></i> –§–∞–π–ª—ã –∏ —Ñ–æ—Ç–æ:
                                    </div>
                                    <details>
                                        <summary style={{cursor:'pointer',color:'#888',fontWeight:600}}>–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å —Ñ–∞–π–ª—ã –∏ —Ñ–æ—Ç–æ</summary>
                                                            <ReportFilesSection report={report} setZoomedImage={setZoomedImage} />
                                    </details>
                                </div>
                            </div>
                            <div style={{margin: '18px 0 0 0', background: '#fff', borderRadius: 12, boxShadow: '0 1px 6px #e1e8ed', padding: '14px 18px'}}>
                              <div style={{fontWeight: 700, color: '#3c78d8', marginBottom: 8, display: 'flex', alignItems: 'center', gap: 10}}>
                                <i className="fas fa-clock" style={{color:'#3c78d8', fontSize: 18}}></i> –í—Ä–µ–º—è —Å–¥–µ–ª–æ–∫ –ø–æ –ø–ª–æ—â–∞–¥–∫–∞–º:
                              </div>
                              <div style={{display: 'flex', gap: 24, flexWrap: 'wrap'}}>
                                {['bybit','htx','bliss','gate'].map(platform => {
                                  const first = report[platform + '_first_trade'];
                                  const last = report[platform + '_last_trade'];
                                  if (!first && !last) return null;
                                  const platformNames = {bybit: 'Bybit', htx: 'HTX', bliss: 'Bliss', gate: 'Gate'};
                                  return (
                                    <div key={platform} style={{minWidth: 120}}>
                                      <b style={{color:'#667eea'}}>{platformNames[platform]}:</b>
                                      <div style={{fontSize:'0.98em',color:'#333'}}>
                                        {first && <span>–ü–µ—Ä–≤–∞—è: <b>{first}</b></span>}<br/>
                                        {last && <span>–ü–æ—Å–ª–µ–¥–Ω—è—è: <b>{last}</b></span>}
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                            <div style={{background:'#f8f9fa',borderRadius:12,padding:'18px 18px',margin:'10px 0',boxShadow:'0 2px 8px #e1e8ed',maxWidth:340}}>
                              {(() => {
                                let totalEnd = 0, totalStart = 0;
                                ['bybit','htx','bliss','gate'].forEach(platform => {
                                  if (balances[platform] && balances[platform].length > 0) {
                                    totalEnd += balances[platform].reduce((acc, accObj) => accObj.end_balance !== '' && !isNaN(accObj.end_balance) ? acc + parseFloat(accObj.end_balance) : acc, 0);
                                    totalStart += balances[platform].reduce((acc, accObj) => accObj.start_balance !== '' && !isNaN(accObj.start_balance) ? acc + parseFloat(accObj.start_balance) : acc, 0);
                                  }
                                });
                                const dokidka = parseFloat(report.dokidka_amount) || 0;
                                const internal = parseFloat(report.internal_transfer_amount) || 0;
                                const scam = report.scam_personal ? (parseFloat(report.scam_amount) || 0) : 0;
                                const profit = (totalEnd - totalStart) - dokidka - internal - scam;
                                let percent = (employee && employee.percent) ? parseFloat(employee.percent) : 30;
                                if (isNaN(percent) || percent <= 0) percent = 30;
                                const salary = profit * percent / 100;
                                return (
                                  <>
                                    <div style={{fontWeight:700,fontSize:'1.1em',color:'#27ae60',marginBottom:6,display:'flex',alignItems:'center',gap:10}}>
                                      <i className="fas fa-coins" style={{color:'#27ae60',fontSize:20}}></i> –ü—Ä–∏–±—ã–ª—å –∑–∞ —Å–º–µ–Ω—É:
                                      <span style={{fontWeight:700,color:profit>=0?'#27ae60':'#e74c3c',fontSize:'1.12em',marginLeft:8}}>{(profit>=0?'+':'')+profit.toFixed(2)} USDT</span>
                                    </div>
                                    <div style={{fontWeight:700,fontSize:'1.05em',color:'#764ba2',marginBottom:2,display:'flex',alignItems:'center',gap:10}}>
                                      <i className="fas fa-user-tie" style={{color:'#764ba2',fontSize:18}}></i> –ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞:
                                      <span style={{fontWeight:700,color:'#764ba2',fontSize:'1.08em',marginLeft:8}}>{salary.toFixed(2)} USDT</span>
                                      <span style={{color:'#888',fontWeight:400,fontSize:'0.98em',marginLeft:6}}>({percent}% –æ—Ç –ø—Ä–∏–±—ã–ª–∏)</span>
                                    </div>
                                  </>
                                );
                              })()}
                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
            );
        }

        // --- –î–û–ë–ê–í–õ–Ø–Æ –ö–û–ú–ü–û–ù–ï–ù–¢ AccountBalancesTable ---
        function AccountBalancesTable({ balances, reports, report, accounts }) {
            function findPrevBalance(account_id, platform) {
                const prev = reports
                    .filter(r => {
                        if (r.id === report.id) return false;
                        if (compareShifts(r.shift_date, r.shift_type, report.shift_date, report.shift_type) >= 0) return false;
                        let b = {};
                        try { b = JSON.parse(r.balances_json || '{}'); } catch { b = {}; }
                        return b[platform] && b[platform].some(a => (a.account_id || a.id) == account_id);
                    })
                    .sort((a, b) => {
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) > 0) return -1;
                        if (compareShifts(a.shift_date, a.shift_type, b.shift_date, b.shift_type) < 0) return 1;
                        return 0;
                    });
                if (prev.length > 0) {
                    let b = {};
                    try { b = JSON.parse(prev[0].balances_json || '{}'); } catch { b = {}; }
                    const acc = b[platform].find(a => (a.account_id || a.id) == account_id);
                    return acc && acc.balance !== undefined ? parseFloat(acc.balance) : 0;
                }
                if (window.settingsInitialBalances) {
                    const acc = window.settingsInitialBalances.find(b => b.platform === platform && (b.account_id == account_id || b.account_name == (accounts.find(a => a.id == account_id)?.account_name)));
                    return acc && acc.balance !== undefined ? parseFloat(acc.balance) : 0;
                }
                return 0;
            }
            return (
                <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(320px, 1fr))',gap:'18px',marginTop:8,marginBottom:18}}>
                    {['bybit','htx','bliss','gate'].map(platform => (
                        <div key={platform} style={{background:'#f8f9fa',borderRadius:12,padding:'14px 18px',boxShadow:'0 2px 8px #e1e8ed'}}>
                            <div style={{fontWeight:600,color:'#667eea',marginBottom:6}}><i className="fas fa-circle" style={{fontSize:10,marginRight:6,color:'#764ba2'}}></i>{platform.toUpperCase()}</div>
                            {balances[platform] && balances[platform].length > 0 ? (
                                <table style={{width:'100%',fontSize:'1em'}}>
                                    <thead><tr><th style={{textAlign:'left'}}>–ê–∫–∫–∞—É–Ω—Ç</th><th style={{textAlign:'right'}}>–ù–∞—á–∞–ª—å–Ω—ã–π</th><th style={{textAlign:'right'}}>–ö–æ–Ω–µ—á–Ω—ã–π</th><th style={{textAlign:'right'}}>Œî</th></tr></thead>
                                    <tbody>
                                        {balances[platform].map(acc => {
                                            const start = acc.start_balance !== '' && !isNaN(acc.start_balance) ? parseFloat(acc.start_balance) : 0;
                                            const end = acc.end_balance !== '' && !isNaN(acc.end_balance) ? parseFloat(acc.end_balance) : 0;
                                            const diff = end - start;
                                            return (
                                                <tr key={acc.account_id || acc.id}>
                                                    <td>{acc.account_name}</td>
                                                    <td style={{textAlign:'right'}}>{start} USDT</td>
                                                    <td style={{textAlign:'right'}}>{end} USDT</td>
                                                    <td style={{textAlign:'right',color:diff>=0?'#27ae60':'#e74c3c',fontWeight:600}} title="–†–∞–∑–Ω–∏—Ü–∞ –∑–∞ —Å–º–µ–Ω—É">{diff>=0?'+':''}{diff.toFixed(2)}</td>
                                                </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                            ) : (
                                <span style={{color:'#aaa',marginLeft:8}}>‚Äî</span>
                            )}
                        </div>
                    ))}
                </div>
            );
        }

        // --- –î–û–ë–ê–í–õ–Ø–Æ –ö–û–ú–ü–û–ù–ï–ù–¢ ReportFilesSection ---
        function ReportFilesSection({ report, setZoomedImage }) {
            // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
            const [startPhotoError, setStartPhotoError] = React.useState(false);
            const [endPhotoError, setEndPhotoError] = React.useState(false);
            // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—à–∏–±–æ–∫ —Ñ–∞–π–ª–æ–≤ (–º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
            // ...
            return (
                <>
                    <div style={{margin:'24px 0 10px 0',display:'flex',alignItems:'center',gap:16}}>
                        <i className="fas fa-paperclip" style={{color:'#764ba2',fontSize:20}}></i>
                        <span style={{fontWeight:700,fontSize:'1.1em',color:'#764ba2'}}>–§–∞–π–ª—ã –∏ —Ñ–æ—Ç–æ:</span>
                    </div>
                    <div style={{display:'flex',gap:32,flexWrap:'wrap',alignItems:'flex-start',marginTop:8}}>
                        <div style={{minWidth:180}}>
                            <b style={{color:'#764ba2'}}>–í—ã–≥—Ä—É–∑–∫–∏ —Å –ø–ª–æ—â–∞–¥–æ–∫:</b>
                            <ul style={{margin:'8px 0 0 18px',padding:0}}>
                                {report.bybit_file ? (
                                    <li><i className="fab fa-btc" style={{color:'#f7b731',marginRight:6}}></i><a href={`/uploads/${report.bybit_file}`} target="_blank" rel="noopener noreferrer">Bybit</a></li>
                                ) : <li style={{color:'#aaa'}}>Bybit: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω</li>}
                                {report.htx_file ? (
                                    <li><i className="fab fa-hubspot" style={{color:'#27ae60',marginRight:6}}></i><a href={`/uploads/${report.htx_file}`} target="_blank" rel="noopener noreferrer">HTX</a></li>
                                ) : <li style={{color:'#aaa'}}>HTX: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω</li>}
                                {report.bliss_file ? (
                                    <li><i className="fas fa-bolt" style={{color:'#e74c3c',marginRight:6}}></i><a href={`/uploads/${report.bliss_file}`} target="_blank" rel="noopener noreferrer">Bliss</a></li>
                                ) : <li style={{color:'#aaa'}}>Bliss: —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω</li>}
                            </ul>
                        </div>
                        <div style={{display:'flex',gap:24}}>
                            {report.start_photo && !startPhotoError ? (
                                <div><b>–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ —Å–º–µ–Ω—ã:</b><br/>
                                    <img src={`/uploads/${report.start_photo}`} alt="–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞" style={{maxWidth:120, borderRadius:12, marginTop:4, cursor:'zoom-in',boxShadow:'0 2px 8px #aaa'}} onClick={() => setZoomedImage(`/uploads/${report.start_photo}`)} onError={() => setStartPhotoError(true)} />
                                </div>
                            ) : report.start_photo ? (
                                <div style={{color:'#e74c3c',marginTop:12}}><b>–§–æ—Ç–æ –Ω–∞—á–∞–ª–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</b></div>
                            ) : null}
                            {report.end_photo && !endPhotoError ? (
                                <div><b>–§–æ—Ç–æ –∫–æ–Ω—Ü–∞ —Å–º–µ–Ω—ã:</b><br/>
                                    <img src={`/uploads/${report.end_photo}`} alt="–§–æ—Ç–æ –∫–æ–Ω—Ü–∞" style={{maxWidth:120, borderRadius:12, marginTop:4, cursor:'zoom-in',boxShadow:'0 2px 8px #aaa'}} onClick={() => setZoomedImage(`/uploads/${report.end_photo}`)} onError={() => setEndPhotoError(true)} />
                                </div>
                            ) : report.end_photo ? (
                                <div style={{color:'#e74c3c',marginTop:12}}><b>–§–æ—Ç–æ –∫–æ–Ω—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</b></div>
                            ) : null}
                        </div>
                    </div>
                </>
            );
        }

        function Settings({ authed, setAuthed, password, setPassword, initialBalances, setInitialBalances, accounts, loading }) {
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState('');
            const [success, setSuccess] = useState('');
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∞–∫–∫–∞—É–Ω—Ç—ã –ø–æ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º
            const platforms = [
                { value: 'bybit', label: 'Bybit' },
                { value: 'htx', label: 'HTX' },
                { value: 'bliss', label: 'Bliss' },
                { value: 'gate', label: 'Gate' }
            ];
            const grouped = {};
            platforms.forEach(p => grouped[p.value] = []);
            accounts.forEach(acc => {
                if (grouped[acc.platform]) grouped[acc.platform].push(acc);
            });
            // –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã —Å –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏
            const getBalance = (platform, account_name) => {
                const found = initialBalances.find(b => b.platform === platform && b.account_name === account_name);
                return found ? found.balance : '';
            };
            const handleBalanceChange = (platform, account_name, value) => {
                setInitialBalances(balances => {
                    const idx = balances.findIndex(b => b.platform === platform && b.account_name === account_name);
                    if (idx >= 0) {
                        const updated = [...balances];
                        updated[idx] = { ...updated[idx], balance: value };
                        return updated;
                    } else {
                        return [...balances, { platform, account_name, balance: value }];
                    }
                });
            };
            const handleSave = async () => {
                setSaving(true); setError(''); setSuccess('');
                try {
                    const response = await fetch('/api/settings/balances', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password: password, balances: initialBalances })
                    });
                    if (response.ok) {
                        setSuccess('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                    } else {
                        const data = await response.json();
                        setError(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    }
                } catch (e) {
                    setError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
                setSaving(false);
            };
            if (!authed) {
                return (
                    <div className="card" style={{maxWidth:400,margin:'40px auto',textAlign:'center'}}>
                        <h3><i className="fas fa-lock"></i> –í—Ö–æ–¥ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                        <input type="password" className="form-control" placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" value={password} onChange={e => setPassword(e.target.value)} style={{margin:'20px 0'}} />
                        <button className="btn" onClick={() => { if (password === 'Blalala2') setAuthed(true); else setError('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'); }}>–í–æ–π—Ç–∏</button>
                        {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                    </div>
                );
            }
            if (loading) return <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
            return (
                <div className="card">
                    <h3><i className="fas fa-cog"></i> –ù–∞—á–∞–ª—å–Ω—ã–µ –±–∞–ª–∞–Ω—Å—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤</h3>
                    <p style={{color:'#888'}}>–≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –¥–µ–ª—å—Ç –∏ –ø–µ—Ä–≤–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>
                    <div className="form-group" style={{maxWidth:300,margin:'0 0 18px 0'}}>
                        <label>–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</label>
                        <input type="password" className="form-control" value={password} onChange={e => setPassword(e.target.value)} placeholder="–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞" />
                    </div>
                    {platforms.map(p => (
                        <div key={p.value} style={{marginBottom:20}}>
                            <b>{p.label}</b>
                            {grouped[p.value].length === 0 ? <div style={{color:'#aaa'}}>–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div> : (
                                <table className="table" style={{marginTop:8}}>
                                    <thead><tr><th>–ê–∫–∫–∞—É–Ω—Ç</th><th>–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</th></tr></thead>
                                    <tbody>
                                        {grouped[p.value].map(acc => (
                                            <tr key={acc.id}>
                                                <td>{acc.account_name}</td>
                                                <td>
                                                    <input
                                                        type="number"
                                                        onWheel={e => e.target.blur()}
                                                        className="form-control"
                                                        style={{maxWidth:120}}
                                                        value={getBalance(p.value, acc.account_name)}
                                                        onChange={e => handleBalanceChange(p.value, acc.account_name, e.target.value)}
                                                    />
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            )}
                        </div>
                    ))}
                    <div style={{marginTop:40,marginBottom:24,padding:'24px',background:'#fff',borderRadius:16,boxShadow:'0 2px 8px #e1e8ed'}}>
                        <h3 style={{marginBottom:16}}><i className="fas fa-percent" style={{color:'#764ba2',marginRight:8}}></i> –ü—Ä–æ—Ü–µ–Ω—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</h3>
                        <EmployeePercentSettings />
                    </div>
                    <button className="btn" onClick={handleSave} disabled={saving}>{saving ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</button>
                    {(!password || password.length < 3) && <div style={{color:'#e74c3c',marginTop:10}}>–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</div>}
                    {success && <div style={{color:'#27ae60',marginTop:10}}>{success}</div>}
                    {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                </div>
            );
        }

        function Statistics({ stats, start, end, setStart, setEnd, loading }) {
            // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
            return (
                <div className="card">
                    <h3><i className="fas fa-chart-pie"></i> –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º</h3>
                    <div style={{display:'flex',gap:16,alignItems:'end',margin:'18px 0 28px 0',flexWrap:'wrap'}}>
                        <div>
                            <label>–ü–µ—Ä–∏–æ–¥ —Å</label>
                            <input type="date" className="form-control" value={start} onChange={e => setStart(e.target.value)} style={{minWidth:140}} />
                        </div>
                        <div>
                            <label>–ø–æ</label>
                            <input type="date" className="form-control" value={end} onChange={e => setEnd(e.target.value)} style={{minWidth:140}} />
                        </div>
                    </div>
                    {loading ? <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div> : (
                        <div style={{overflowX:'auto'}}>
                            <table className="table" style={{minWidth:900}}>
                                <thead>
                                    <tr>
                                        <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                        <th>–°–º–µ–Ω</th>
                                        <th>–î–Ω–µ–π</th>
                                        <th>–ó–∞—è–≤–æ–∫ (–≤—Å–µ–≥–æ)</th>
                                        <th>Bybit</th>
                                        <th>HTX</th>
                                        <th>Bliss</th>
                                        <th>–°—Ä–µ–¥. –∑–∞—è–≤–æ–∫/–¥–µ–Ω—å</th>
                                        <th><span title="–°—É–º–º–∞—Ä–Ω–∞—è –ø—Ä–∏–±—ã–ª—å –∑–∞ –≤—Å–µ —Å–º–µ–Ω—ã"><i className='fas fa-coins' style={{color:'#27ae60'}}></i> –ü—Ä–∏–±—ã–ª—å –∑–∞ —Å–º–µ–Ω—ã</span></th>
                                        <th><span title="30% –æ—Ç –ø—Ä–∏–±—ã–ª–∏ –∑–∞ —Å–º–µ–Ω—ã"><i className='fas fa-money-bill-wave' style={{color:'#27ae60'}}></i> –ó–∞—Ä–ø–ª–∞—Ç–∞</span></th>
                                        <th><span title="–°—É–º–º–∞ —Å–∫–∞–º–∞"><i className='fas fa-skull-crossbones' style={{color:'#e74c3c'}}></i> –°–∫–∞–º</span></th>
                                        <th><span title="–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–æ–≤"><i className='fas fa-exchange-alt' style={{color:'#f7b731'}}></i> –ü–µ—Ä–µ–≤–æ–¥—ã</span></th>
                                        <th><span title="–°—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å –∑–∞ —Å–º–µ–Ω—É"><i className='fas fa-chart-line' style={{color:'#3c78d8'}}></i> –°—Ä–µ–¥. –ø—Ä–∏–±—ã–ª—å/—Å–º–µ–Ω—É</span></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {stats.map(emp => (
                                        <tr key={emp.id} style={{background: emp.salary > 0 ? '#f8fff8' : emp.salary < 0 ? '#fff8f8' : undefined}}>
                                            <td><b>{emp.name}</b><br/><span style={{color:'#888',fontSize:'0.95em'}}>{emp.telegram}</span></td>
                                            <td>{emp.total_shifts}</td>
                                            <td>{emp.total_days}</td>
                                            <td>{emp.total_requests}</td>
                                            <td>{emp.total_bybit}</td>
                                            <td>{emp.total_htx}</td>
                                            <td>{emp.total_bliss}</td>
                                            <td>{emp.avg_requests_per_day}</td>
                                            <td style={{color:'#27ae60',fontWeight:700,fontSize:'1.1em'}}>{emp.net_profit >= 0 ? '+' : ''}{emp.net_profit} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#27ae60',fontWeight:700}}>{emp.salary} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#e74c3c',fontWeight:700}}>{emp.total_scam} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#f7b731',fontWeight:700}}>{emp.total_transfer} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                            <td style={{color:'#3c78d8',fontWeight:700}}>{emp.avg_profit_per_shift} <span style={{fontSize:'0.95em',color:'#888'}}>USDT</span></td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        }

        // --- UI-—Ä–∞–∑–¥–µ–ª –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–ª–∞–Ω—Å–æ–≤ ---
        function AccountBalanceHistoryViewer({ accounts, employees }) {
            const [history, setHistory] = React.useState([]);
            const [filters, setFilters] = React.useState({ account_id: '', platform: '', employee_id: '', date_from: '', date_to: '' });
            const [page, setPage] = React.useState(1);
            const rowsPerPage = 20;
            React.useEffect(() => {
                let url = '/api/account-balance-history?';
                if (filters.account_id) url += `account_id=${filters.account_id}&`;
                if (filters.platform) url += `platform=${filters.platform}&`;
                if (filters.employee_id) url += `employee_id=${filters.employee_id}&`;
                if (filters.date_from) url += `start_date=${filters.date_from}&`;
                if (filters.date_to) url += `end_date=${filters.date_to}`;
                fetch(url).then(r => r.json()).then(data => { setHistory(data); setPage(1); });
            }, [filters]);
            const filtered = history.filter(h =>
                (!filters.account_id || String(h.account_id) === String(filters.account_id)) &&
                (!filters.platform || h.platform === filters.platform) &&
                (!filters.employee_id || String(h.employee_id) === String(filters.employee_id)) &&
                (!filters.date_from || h.shift_date >= filters.date_from) &&
                (!filters.date_to || h.shift_date <= filters.date_to)
            );
            // –ü–∞–≥–∏–Ω–∞—Ü–∏—è
            const totalPages = Math.ceil(filtered.length / rowsPerPage) || 1;
            const paginated = filtered.slice((page-1)*rowsPerPage, page*rowsPerPage);
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) setPage(newPage);
            };
            return (
                <div className="card">
                    <h3><i className="fas fa-database"></i> –ò—Å—Ç–æ—Ä–∏—è –±–∞–ª–∞–Ω—Å–æ–≤ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</h3>
                    <div style={{display:'flex',gap:12,marginBottom:16,flexWrap:'wrap'}}>
                        <select className="form-control" value={filters.account_id} onChange={e => setFilters(f => ({...f, account_id: e.target.value}))} style={{maxWidth:180}}>
                            <option value="">–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã</option>
                            {[...new Set(history.map(h => h.account_id))].map(id => (
                                <option key={id} value={id}>{accounts.find(a => a.id == id)?.account_name || id}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.platform} onChange={e => setFilters(f => ({...f, platform: e.target.value}))} style={{maxWidth:140}}>
                            <option value="">–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</option>
                            {[...new Set(history.map(h => h.platform))].map(p => (
                                <option key={p} value={p}>{p.toUpperCase()}</option>
                            ))}
                        </select>
                        <select className="form-control" value={filters.employee_id} onChange={e => setFilters(f => ({...f, employee_id: e.target.value}))} style={{maxWidth:180}}>
                            <option value="">–í—Å–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∏</option>
                            {[...new Set(history.map(h => h.employee_id))].map(id => (
                                <option key={id} value={id}>{employees.find(e => e.id == id)?.name || id}</option>
                            ))}
                        </select>
                        <input type="date" className="form-control" value={filters.date_from} onChange={e => setFilters(f => ({...f, date_from: e.target.value}))} style={{maxWidth:160}} placeholder="–° –¥–∞—Ç—ã" />
                        <input type="date" className="form-control" value={filters.date_to} onChange={e => setFilters(f => ({...f, date_to: e.target.value}))} style={{maxWidth:160}} placeholder="–ü–æ –¥–∞—Ç—É" />
                    </div>
                    <div style={{overflowX:'auto'}}>
                        <table className="table" style={{minWidth:900}}>
                            <thead>
                                <tr>
                                    <th>–ê–∫–∫–∞—É–Ω—Ç</th>
                                    <th>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</th>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–°–º–µ–Ω–∞</th>
                                    <th>–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å</th>
                                    <th>–ö–æ–Ω–µ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å</th>
                                    <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
                                </tr>
                            </thead>
                            <tbody>
                                {(() => {
                                  // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ account_id, platform, shift_date, shift_type, employee_id
                                  const grouped = {};
                                  history.forEach(h => {
                                    const key = [h.account_id, h.platform, h.shift_date, h.shift_type, h.employee_id].join('|');
                                    if (!grouped[key]) grouped[key] = { ...h, start: null, end: null };
                                    if (h.balance_type === 'start') grouped[key].start = h.balance;
                                    if (h.balance_type === 'end') grouped[key].end = h.balance;
                                  });
                                  return Object.values(grouped).map((h, idx) => (
                                    <tr key={idx}>
                                      <td>{h.account_id}</td>
                                        <td>{h.platform.toUpperCase()}</td>
                                      <td>{h.account_name}</td>
                                        <td>{h.shift_date}</td>
                                        <td>{h.shift_type === 'morning' ? '–£—Ç—Ä–µ–Ω–Ω—è—è' : '–í–µ—á–µ—Ä–Ω—è—è'}</td>
                                      <td>{h.start !== null && h.start !== undefined ? h.start : '‚Äî'}</td>
                                      <td>{h.end !== null && h.end !== undefined ? h.end : '‚Äî'}</td>
                                      <td>{h.employee_name || h.employee_id}</td>
                                    </tr>
                                  ));
                                })()}
                            </tbody>
                        </table>
                    </div>
                    {/* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */}
                    <div style={{display:'flex',justifyContent:'center',alignItems:'center',gap:8,marginTop:18}}>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page-1)} disabled={page<=1}>–ù–∞–∑–∞–¥</button>
                        <span style={{fontWeight:600}}>{page} / {totalPages}</span>
                        <button className="btn btn-secondary" onClick={() => handlePageChange(page+1)} disabled={page>=totalPages}>–í–ø–µ—Ä—ë–¥</button>
                    </div>
                </div>
            );
        }

        // –î–æ–±–∞–≤–ª—è—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç EmployeePercentSettings
        function EmployeePercentSettings() {
            const [employees, setEmployees] = React.useState([]);
            const [percents, setPercents] = React.useState({});
            const [saving, setSaving] = React.useState(false);
            const [success, setSuccess] = React.useState('');
            const [error, setError] = React.useState('');
            React.useEffect(() => {
                fetch('/api/employees').then(r => r.json()).then(data => {
                    setEmployees(data);
                    // salary_percent —Ç–µ–ø–µ—Ä—å –∏–∑ API
                    const perc = {};
                    data.forEach(e => { if (e.salary_percent != null) perc[e.id] = e.salary_percent; });
                    setPercents(perc);
                });
            }, []);
            const handleChange = (id, value) => {
                setPercents(p => ({...p, [id]: value}));
                setSaving(true); setSuccess(''); setError('');
                fetch(`/api/employees/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ salary_percent: value })
                })
                .then(r => r.json().then(data => ({ok: r.ok, data})))
                .then(res => {
                    if (res.ok) setSuccess('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
                    else setError(res.data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                    setSaving(false);
                })
                .catch(() => { setError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'); setSaving(false); });
            };
            return (
                <div>
                    <table className="table" style={{maxWidth:600}}>
                        <thead><tr><th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th><th>–ü—Ä–æ—Ü–µ–Ω—Ç (%)</th></tr></thead>
                        <tbody>
                            {employees.map(emp => (
                                <tr key={emp.id}>
                                    <td>{emp.name}</td>
                                    <td>
                                        <input type="number" min="0" max="100" step="0.1" className="form-control" style={{maxWidth:100}} value={percents[emp.id] || ''} onChange={e => handleChange(emp.id, e.target.value)} />
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {saving && <span style={{color:'#888',marginLeft:10}}>–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span>}
                    {success && <div style={{color:'#27ae60',marginTop:10}}>{success}</div>}
                    {error && <div style={{color:'#e74c3c',marginTop:10}}>{error}</div>}
                </div>
            );
        }

        function DayProfitChart({ reports, year, month }) {
            const dayChartRef = React.useRef(null);
            const [dayChart, setDayChart] = React.useState(null);
            useEffect(() => {
                if (!reports || !dayChartRef.current) return;
                if (dayChart) dayChart.destroy();
                const monthIdx = month - 1;
                const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();
                const labels = Array.from({length: daysInMonth}, (_,i) => new Date(year, monthIdx, i+1).toISOString().slice(0,10));
                let profitByDay = {};
                reports.forEach(r => {
                    const d = (r.shift_date || '').slice(0,10);
                    if (d.startsWith(`${year}-${String(month).padStart(2,'0')}`)) {
                        if (!profitByDay[d]) profitByDay[d] = 0;
                        let balances = {};
                        try { balances = typeof r.balances_json === 'string' ? JSON.parse(r.balances_json) : r.balances_json || {}; } catch { balances = {}; }
                        let endSum = 0, startSum = 0;
                        ['bybit','htx','bliss','gate'].forEach(platform => {
                            if (balances[platform]) {
                                balances[platform].forEach(acc => {
                                    if (acc.end_balance !== '' && !isNaN(acc.end_balance)) endSum += parseFloat(acc.end_balance);
                                    if (acc.start_balance !== '' && !isNaN(acc.start_balance)) startSum += parseFloat(acc.start_balance);
                                });
                            }
                        });
                        const dokidka = parseFloat(r.dokidka_amount) || 0;
                        const internal = parseFloat(r.internal_transfer_amount) || 0;
                        const profit = (endSum - startSum) - dokidka - internal;
                        profitByDay[d] += profit;
                    }
                });
                const dataArr = labels.map(d => profitByDay[d] || 0);
                const minVal = Math.min(...dataArr, 0);
                const maxVal = Math.max(...dataArr, 0);
                const yMax = maxVal === minVal ? maxVal + 10 : undefined;
                const newDayChart = new Chart(dayChartRef.current, {
                    type: 'line',
                    data: {
                        labels: labels.map(d => d.slice(8,10)+'.'+d.slice(5,7)),
                        datasets: [{
                            label: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å –ø–æ –¥–Ω—è–º (–ø–æ –≤—Å–µ–º —Å–º–µ–Ω–∞–º)',
                            data: dataArr,
                            fill: true,
                            backgroundColor: 'rgba(102, 126, 234, 0.15)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            tension: 0.2,
                            pointRadius: 4,
                            pointBackgroundColor: dataArr.map(v => v >= 0 ? '#27ae60' : '#e74c3c')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: minVal,
                                max: yMax,
                                grace: '10%',
                                ticks: {
                                    callback: function(value) { return value + ' USDT'; }
                                }
                            }
                        }
                    }
                });
                setDayChart(newDayChart);
                return () => { newDayChart.destroy(); };
            }, [reports, year, month]);
            return <div className="chart-container"><canvas ref={dayChartRef} /></div>;
        }

        // –ó–∞–º–µ–Ω—è—é ReactDOM.render –Ω–∞ createRoot
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html> 