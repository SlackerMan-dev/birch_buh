# Исправления системы загрузки файлов

## Исправленные проблемы

### 1. SQLAlchemy Legacy Warnings
**Проблема**: Использование устаревшего метода `Employee.query.get()` вызывало предупреждения.

**Исправление**: Заменил все вызовы на новый синтаксис SQLAlchemy 2.0:
```python
# Старый способ (deprecated)
employee = Employee.query.get(employee_id)

# Новый способ (SQLAlchemy 2.0)
employee = db.session.get(Employee, employee_id)
```

**Исправленные места**:
- `upload_orders()` - проверка существования сотрудника
- `update_employee()` - обновление данных сотрудника
- `create_order()` - создание нового ордера
- `update_order()` - обновление ордера
- `delete_order()` - удаление ордера
- `get_platform_balances()` - получение информации о сотрудниках

### 2. Улучшенная обработка Symbol/Pair
**Проблема**: Некоторые ордера пропускались из-за проблем с определением торговой пары.

**Исправление**: Улучшил логику определения символа:
```python
# Добавил больше вариантов названий столбцов
elif any(x in col_lower for x in ['symbol', 'pair', 'пара', 'инструмент', 'currency', 'валюта']):
    if col_value and col_value.lower() not in ['nan', 'none', '']:
        symbol = col_value.upper()

# Добавил дополнительную проверку
if symbol.lower() in ['nan', 'none', '']:
    print(f"Пропускаем строку - некорректный символ: {symbol}")
    return None
```

### 3. Улучшенная валидация данных
**Исправление**: Заменил `all()` на более точную проверку:
```python
# Старый способ
if not all([order_id, symbol, side]) or quantity is None or price is None:

# Новый способ - более точная проверка
if not order_id or not symbol or not side or quantity is None or price is None:
```

## Результат

✅ **Устранены предупреждения SQLAlchemy**
- Код теперь совместим с SQLAlchemy 2.0
- Нет deprecated warnings в логах

✅ **Улучшена обработка файлов**
- Лучшее определение торговых пар
- Более точная валидация данных
- Меньше пропущенных ордеров

✅ **Стабильная работа загрузки**
- Система корректно обрабатывает различные форматы файлов
- Правильно определяет и сохраняет все необходимые поля

## Логи после исправления

Теперь в логах вы увидите:
```
127.0.0.1 - - [07/Jul/2025 02:37:32] "POST /api/orders/upload HTTP/1.1" 200 -
```

Вместо предупреждений:
```
C:\...\app.py:1329: LegacyAPIWarning: The Query.get() method is considered legacy...
```

## Что дальше

Система загрузки файлов теперь работает стабильно и без предупреждений. Если у вас все еще есть проблемы с определением торговых пар в конкретных файлах, можете отправить пример файла для дополнительной настройки парсера. 